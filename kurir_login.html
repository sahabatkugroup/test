<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery - Login Kurir</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <!-- Form Login Kurir -->
    <div id="kurirLoginForm" class="card">
      <h2>Login Kurir</h2>
      <div class="grid grid-3">
        <div><label>Username</label><input id="kurirLoginUser" type="text" placeholder="Nama kurir (contoh: Tom Haye)" autocomplete="username"></div>
        <div><label>Password</label><input id="kurirLoginPass" type="password" placeholder="ID Card (contoh: A1234)" autocomplete="current-password"></div>
        <div style="align-self:end"><div class="btnbar"><button id="kurirLoginBtn" class="btn full">Masuk</button><button id="backToInitialKurir" class="btn secondary full">Kembali</button></div></div>
      </div>
      <p id="kurirLoginMsg" class="small" style="color:var(--error-color);margin-top:8px"></p>
    </div>
  </div>

  <!-- Notification -->
  <div id="notificationPopup" class="notification-popup"></div>
  <audio id="notificationSound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>

  <script type="module" src="firebase_config.js"></script>
  <script type="module" src="common_script.js"></script>
  <script type="module">
    import { db, auth } from './firebase_config.js';
    import { showNotification } from './common_script.js';
    import { get, ref } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const el = (id) => document.getElementById(id);

    let currentUser = null;

    // Dummy users for quick testing (can be removed if all users are in Firebase)
    const sampleUsers = {
      "Sonia":"A0103","Alfan":"A0106","Hafiz":"A0108","Gilang":"A0109","Kardianto":"A0110","Eblek":"A0112",
      "Nandar":"A0117","Pitri":"A0115","Robi":"A0118","Hambali":"A0119","Ulum":"A0120","Admin":"A1111"
    };

    el('kurirLoginBtn').addEventListener('click', doKurirLogin);
    el('backToInitialKurir').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    async function doKurirLogin() {
      const u = el('kurirLoginUser').value.trim();
      const p = el('kurirLoginPass').value.trim();
      const msgEl = el('kurirLoginMsg');
      msgEl.innerText = '';

      // 1. Check sampleUsers (dummy)
      if (u && sampleUsers[u] === p) {
        kurirLoginSuccess(u);
        return;
      }

      // 2. Check Firebase Realtime Database (kurir/{username})
      try {
        const snap = await get(ref(db, 'kurir/' + u));
        if (snap.exists()) {
          const data = snap.val();
          if (!data.enabled) {
            msgEl.innerText = 'Akun ini dinonaktifkan! Silakan hubungi admin.';
            showNotification('Akun diblokir!', 'error');
            return;
          }
          if (data.password !== p) {
            msgEl.innerText = 'Password salah!';
            showNotification('Password salah!', 'error');
            return;
          }
          kurirLoginSuccess(data.username);
        } else {
          msgEl.innerText = 'User tidak ditemukan!';
          showNotification('User tidak ditemukan!', 'error');
        }
      } catch (err) {
        console.error("Firebase error:", err);
        msgEl.innerText = 'Gagal konek Firebase atau user tidak ditemukan!';
        showNotification('Login gagal!', 'error');
      }
    }

    function kurirLoginSuccess(username) {
      currentUser = username;
      localStorage.setItem('currentUser', username);
      showNotification(`Selamat datang, ${currentUser}!`, 'success');
      window.location.href = 'kurir_dashboard.html';
    }

    // Auto-login kurir jika sudah ada di localStorage
    window.addEventListener('load', () => {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        el('kurirLoginUser').value = savedUser;
        // Optionally, you can directly attempt login here if you want to bypass manual click
        // doKurirLogin(); 
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery - Terpadu</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Global Styles (Gabungan dari semua modul) */
    :root {
      --main-bg-color: #0BA6DF;
      --card-bg: #fff;
      --glass: rgba(255,255,255,0.85);
      --border: #c9dbf8;
      --shadow-light: rgba(74,144,226,0.15);
      --shadow-strong: rgba(74,144,226,0.3);
      --sky-light: #d0e8ff;
      --sky: #a3c9ff;
      --sky-strong: #4a90e2;
      --accent: #0077c8;
      --muted: #4a6fa5;
      --text-primary: #0b3b5a;
      --text-secondary: #506273;
      --success-color: #28a745;
      --error-color: #dc3545;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --transition-speed: 0.3s;
      /* Absensi Colors */
      --absensi-primary: #3a8dde;
      --absensi-primary-dark: #1e5fa8;
      --absensi-bg: #e8f4fd;
      --absensi-ok: #43a047;
      --absensi-danger: #e53935;
      --absensi-pending: #f9a825;
      --absensi-text: #1a2e4a;
      --absensi-text-muted: #5a6d8c;
      --absensi-radius: 16px;
      --absensi-shadow-light: rgba(58,141,222,0.15);
      --absensi-shadow-strong: rgba(58,141,222,0.25);
      /* Cek Ongkir Specific */
      --ongkir-brand:#2f80ed;
      --ongkir-brand-2:#5ea3ff;
      --ongkir-shadow: 0 20px 45px rgba(4,32,66,.18);

      /* Admin Box Colors */
      --admin-box-bg: linear-gradient(135deg, #FFD700, #FFA500); /* Gold to Orange */
      --admin-box-text: #333;
      --admin-box-shadow: 0 15px 35px rgba(255,193,7,0.4);
      --admin-box-border: 1px solid #FFC107;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', system-ui, Arial, Helvetica, sans-serif; background: var(--main-bg-color); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.6; }
    .container { max-width: 960px; margin: 0 auto; padding: 16px 20px; }
    .card { background: var(--card-bg); border-radius: 20px; padding: 24px 28px; box-shadow: 0 12px 30px var(--shadow-light); margin-bottom: 20px; border: 1px solid var(--border); transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease; }
    .card:hover { box-shadow: 0 16px 40px var(--shadow-strong); transform: translateY(-3px); }
    h1, h2, h3, h4 { margin: 8px 0 16px 0; color: var(--sky-strong); font-weight: 700; letter-spacing: 0.02em; }
    h1 { font-size: clamp(24px, 4vw, 36px); text-align: center; }
    h2 { font-size: clamp(20px, 3.5vw, 28px); }
    h3 { font-size: clamp(18px, 3vw, 24px); }
    h4 { font-size: clamp(16px, 2.5vw, 20px); }
    label { display: block; margin-top: 12px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: 0.01em; }
    input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1.5px solid var(--border); margin-top: 8px; background: var(--glass); outline: none; font-size: 0.95rem; color: var(--text-primary); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, input[type="email"]:focus, textarea:focus, select:focus { border-color: var(--sky-strong); box-shadow: 0 0 8px var(--sky-strong); background: #f0f8ff; }
    .btn { background: var(--sky-strong); color: #fff; border: none; padding: 10px 16px; border-radius: 14px; cursor: pointer; box-shadow: 0 6px 18px var(--shadow-light); font-weight: 700; font-size: 0.9rem; letter-spacing: 0.02em; transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease; }
    .btn:hover { background: #3a6fc1; box-shadow: 0 8px 24px var(--shadow-strong); transform: translateY(-2px); }
    .btn.secondary { background: #f5f7fa; color: var(--text-primary); border: 1.5px solid var(--border); box-shadow: none; font-weight: 600; }
    .btn.secondary:hover { background: #e1e9f8; border-color: var(--sky-strong); color: var(--sky-strong); }
    .btn.ghost { background: transparent; color: var(--text-primary); border: 1.5px dashed var(--border); font-weight: 600; }
    .btn.ghost:hover { border-color: var(--sky-strong); color: var(--sky-strong); }
    .btn.danger { background: #ff6b6b; box-shadow: none; font-weight: 700; }
    .btn.danger:hover { background: #e04e4e; }
    .btn.full { width: 100%; }
    .btnbar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
    nav.tab { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 16px; background: var(--card-bg); padding: 10px; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
    nav.tab button { padding: 12px 0; border-radius: 14px; border: 1.5px solid var(--border); background: var(--card-bg); color: var(--text-primary); font-weight: 700; font-size: 0.9rem; letter-spacing: 0.02em; transition: background var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease; cursor: pointer; }
    nav.tab button.active { background: linear-gradient(90deg, var(--sky-strong), #6fc2ff); color: #fff; border-color: transparent; box-shadow: 0 6px 18px var(--shadow-light); }
    .row { display: flex; gap: 12px; align-items: flex-start; }
    .col { flex: 1; }
    .hidden { display: none !important; }
    .small { font-size: 12px; color: var(--muted); font-weight: 600; }
    .stack { display: flex; flex-direction: column; gap: 10px; }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: repeat(2,1fr); }
    .grid-3 { grid-template-columns: repeat(3,1fr); }
    .grid-4 { grid-template-columns: repeat(4,1fr); }
    .section-title { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-weight: 700; color: var(--sky-strong); font-size: 1rem; }
    .list-v { display: flex; flex-direction: column; gap: 10px; }
    .line-card { border: 1.5px solid var(--border); border-radius: 16px; background: var(--card-bg); padding: 12px 16px; display: grid; grid-template-columns: 2.5fr 80px 160px 120px 90px; gap: 10px; align-items: center; box-shadow: 0 3px 9px rgba(74,144,226,0.07); transition: box-shadow var(--transition-speed) ease; }
    .line-card:hover { box-shadow: 0 6px 18px var(--shadow-light); }
    .line-card .sub { font-weight: 700; text-align: center; color: var(--sky-strong); font-size: 0.9rem; }
    .line-card .mini-btn { width: 100%; border-radius: 12px; padding: 6px 0; font-weight: 600; font-size: 0.85rem; background: var(--sky); color: var(--text-primary); border: none; cursor: pointer; transition: background var(--transition-speed) ease; }
    .line-card .mini-btn:hover { background: var(--sky-strong); color: #fff; }
    .line-card-tambahan { border: 1.5px solid var(--border); border-radius: 16px; background: var(--card-bg); padding: 12px 16px; display: grid; grid-template-columns: 1.8fr 1.2fr 120px; gap: 10px; align-items: center; box-shadow: 0 3px 9px rgba(74,144,226,0.07); transition: box-shadow var(--transition-speed) ease; }
    .line-card-tambahan:hover { box-shadow: 0 6px 18px var(--shadow-light); }
    .nota-box { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; background: #f5faff; padding: 18px 20px; border-radius: 14px; border: 1.5px solid #c9dbf8; min-height: 140px; color: var(--text-primary); font-size: 0.9rem; box-shadow: inset 0 0 8px #dbeeff; line-height: 1.4; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; color: var(--text-primary); }
    th, td { padding: 10px 8px; border: 1.5px solid var(--border); text-align: center; font-weight: 600; }
    th { background: linear-gradient(90deg, var(--sky-strong), #6fc2ff); color: #fff; letter-spacing: 0.03em; }
    /* Notification Pop-up & Overlay */
    .notification-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--success-color); color: #fff; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; font-size: 1.1rem; font-weight: 700; text-align: center; }
    .notification-popup.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
    .notification-popup.success { background-color: var(--success-color); }
    .notification-popup.error { background-color: var(--error-color); }
    .notification-popup.info { background-color: var(--info-color); }
    .notification-popup.warning { background-color: var(--warning-color); }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .overlay.show { opacity: 1; visibility: visible; }
    .overlay-content { max-width: 90%; max-height: 90%; background: #fff; padding: 15px; border-radius: 10px; position: relative; }
    .overlay-content img { max-width: 100%; max-height: 80vh; display: block; margin: 0 auto; border-radius: 8px; }
    .overlay-close { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #333; cursor: pointer; background: none; border: none; padding: 0; }
    /* Autocomplete */
    .autocomplete-suggestions { border: 1px solid #999; background: #fff; cursor: default; overflow: auto; max-height: 150px; position: absolute; z-index: 100; width: calc(100% - 28px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .autocomplete-suggestion { padding: 8px 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; display: block; }
    .autocomplete-suggestion.selected { background: var(--sky-light); color: var(--text-primary); }
    .autocomplete-suggestion strong { font-weight: 700; color: var(--sky-strong); }
    /* Cek Ongkir Specific */
    .cek-ongkir-module .hero { position: relative; background: radial-gradient(1100px 400px at 10% -10%, rgba(255,255,255,.22), rgba(255,255,255,0)), linear-gradient(135deg, var(--ongkir-brand-2), var(--ongkir-brand)); border-radius: 20px; padding: 28px clamp(16px,3vw,36px); color: #fff; box-shadow: var(--ongkir-shadow); overflow: hidden; margin-bottom: 20px; }
    .cek-ongkir-module .hero:after { content: ""; position: absolute; right: -120px; top: -120px; width: 280px; height: 280px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%); filter: blur(2px); transform: rotate(15deg); }
    .cek-ongkir-module .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .8px; text-transform: uppercase; font-size: clamp(18px, 2.4vw, 22px); }
    .cek-ongkir-module .brand i { background: #fff; color: var(--ongkir-brand); width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,.15), inset 0 -2px 3px rgba(0,0,0,.08); }
    .cek-ongkir-module .headline { font-size: clamp(22px, 3.2vw, 30px); font-weight: 700; margin: 12px 0 6px; }
    .cek-ongkir-module .sub { opacity: .95; font-weight: 500; }
    .cek-ongkir-module .card__body { padding: clamp(16px, 2.8vw, 28px); }
    .cek-ongkir-module .field .label { font-size: 14px; font-weight: 600; color: #2a3b58; margin: 2px 0 8px 6px; display: flex; align-items: center; gap: 8px; }
    .cek-ongkir-module .control { position: relative; }
    .cek-ongkir-module .control .licon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #6c84a8; }
    .cek-ongkir-module .control .clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: #f1f6ff; color: #1e429f; width: 30px; height: 30px; border-radius: 9px; cursor: pointer; }
    .cek-ongkir-module .control .clear-btn:hover { filter: brightness(0.98); }
    .cek-ongkir-module .suggest { position: absolute; z-index: 40; left: 0; right: 0; top: calc(100% + 6px); background: #fff; border: 1px solid #e8eef8; border-radius: 14px; overflow: hidden; box-shadow: 0 14px 40px rgba(17,38,87,.15); max-height: 320px; overflow-y: auto; display: none; }
    .cek-ongkir-module .s-item { padding: 12px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .cek-ongkir-module .s-item:hover, .cek-ongkir-module .s-item.active { background: #f6faff; }
    .cek-ongkir-module .s-icon { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; background: #eef5ff; color: #2161ff; flex: 0 0 28px; }
    .cek-ongkir-module .s-text { line-height: 1.2; }
    .cek-ongkir-module .s-name { font-weight: 600; }
    .cek-ongkir-module .s-price { font-size: 12px; color: #5a6d89; margin-top: 2px; }
    .cek-ongkir-module mark { background: #ffefb3; padding: 0 .15em; border-radius: 4px; }
    .cek-ongkir-module .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
    .cek-ongkir-module .btn-primary { color: #fff; background: linear-gradient(180deg, #3b82f6, #1d4ed8); box-shadow: 0 12px 30px rgba(30,64,175, .35); }
    .cek-ongkir-module .btn-primary:hover { filter: brightness(1.03); }
    .cek-ongkir-module .btn-ghost { background: #eff5ff; color: #1d4ed8; border: 1px solid #d9e7ff; }
    .cek-ongkir-module .btn-ghost:hover { background: #e9f1ff; }
    .cek-ongkir-module .btn-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .cek-ongkir-module .btn-danger:hover { filter: brightness(0.99); }
    .cek-ongkir-module .results { margin-top: 18px; display: grid; gap: 14px; grid-template-columns: 1fr 1fr; }
    .cek-ongkir-module .pellet { display: inline-flex; align-items: center; gap: 8px; background: #f3f7ff; color: #1e40af; border: 1px solid #e9f2ff; padding: 8px 12px; border-radius: 999px; font-size: 13px; font-weight: 600; }
    .cek-ongkir-module .kartu { border: 1px solid #eaf0fb; border-radius: 16px; padding: 18px; background: linear-gradient(180deg, #ffffff, #fbfdff); }
    .cek-ongkir-module .kartu h4 { margin: 0 0 8px; font-size: 16px; letter-spacing: .2px; display: flex; align-items: center; gap: 8px; }
    .cek-ongkir-module .harga { font-size: 28px; font-weight: 800; color: #0b5bd3; }
    .cek-ongkir-module .muted { color: #607599; font-size: 13px; }
    .cek-ongkir-module .formula { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas; background: #f6f9ff; border: 1px dashed #d9e7ff; padding: 10px 12px; border-radius: 10px; display: inline-block; margin-top: 8px; }
    .cek-ongkir-module .footer { text-align: center; color: #eaf2ff; margin-top: 18px; font-size: 13px; }
    /* Absensi Module Specific */
    .absensi-module .topbar, .absensi-module .admin-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center; margin: 12px 0 20px; }
    .absensi-module .topbar .btn, .absensi-module .admin-bar .btn { padding: 12px 18px; border: none; border-radius: 14px; background: var(--absensi-primary); color: #fff; font-weight: 700; cursor: pointer; transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease; box-shadow: 0 4px 12px rgba(0,0,0,0.12); user-select: none; }
    .absensi-module .topbar .btn:hover, .absensi-module .admin-bar .btn:hover, .absensi-module .topbar .btn:focus, .absensi-module .admin-bar .btn:focus { filter: brightness(0.9); transform: translateY(-2px); outline: none; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .absensi-module .topbar .btn.ghost { background: #e8f4fb; color: var(--absensi-primary-dark); box-shadow: none; border: 1.5px solid var(--absensi-primary); }
    .absensi-module .topbar .btn.active { background: var(--absensi-primary-dark); box-shadow: 0 6px 20px var(--absensi-shadow-strong); }
    .absensi-module .admin-bar .btn.alt { background: #e8f4fb; color: var(--absensi-primary-dark); box-shadow: none; border: 1.5px solid var(--absensi-primary); }
    .absensi-module .admin-bar .btn.danger { background: var(--absensi-danger); box-shadow: none; }
    .absensi-module .admin-bar { display: none; }
    .absensi-module .tab { display: none; }
    .absensi-module .tab.active { display: block; }
    .absensi-module .table-wrap { overflow-x: auto; border-radius: var(--absensi-radius); border: 1.5px solid #d6e4f0; margin-top: 16px; box-shadow: 0 6px 20px rgba(58,141,222,0.05); }
    .absensi-module table { width: 100%; border-collapse: collapse; font-size: 15px; color: var(--absensi-text); min-width: 600px; }
    .absensi-module thead th { position: sticky; top: 0; background: var(--absensi-primary); color: #fff; font-weight: 700; padding: 14px 16px; letter-spacing: 0.03em; z-index: 10; text-align: center; user-select: none; box-shadow: inset 0 -3px 6px rgba(0,0,0,0.1); }
    .absensi-module tbody td { padding: 14px 16px; border-bottom: 1.5px solid #d6e4f0; text-align: center; transition: background var(--transition-speed) ease; }
    .absensi-module tbody tr:hover td { background: #d9eaff; cursor: default; }
    .absensi-module .badge { display: inline-block; padding: 7px 16px; border-radius: 9999px; font-weight: 700; font-size: 13px; user-select: none; transition: background var(--transition-speed) ease, color var(--transition-speed) ease; white-space: nowrap; }
    .absensi-module .badge.on { background: #e9f7ef; color: #1b5e20; border: 1.5px solid #cdebd6; }
    .absensi-module .badge.off { background: #ffebee; color: #b71c1c; border: 1.5px solid #ffcdd2; }
    .absensi-module .badge.pending { background: #fff8e1; color: #f9a825; border: 1.5px solid #ffe082; }
    .absensi-module .btn-mini { padding: 8px 14px; border: none; border-radius: 14px; color: #fff; font-weight: 700; cursor: pointer; transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease; box-shadow: 0 4px 12px rgba(0,0,0,0.12); user-select: none; font-size: 14px; }
    .absensi-module .btn-on { background: var(--absensi-ok); }
    .absensi-module .btn-off { background: var(--absensi-danger); }
    .absensi-module .btn-pending { background: var(--absensi-pending); }
    .absensi-module .btn-on:hover, .absensi-module .btn-off:hover, .absensi-module .btn-pending:hover, .absensi-module .btn-on:focus, .absensi-module .btn-off:focus, .absensi-module .btn-pending:focus { filter: brightness(0.9); transform: translateY(-2px); outline: none; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .absensi-module .login { background: #fff; width: min(92vw, 460px); border-radius: 20px; box-shadow: 0 12px 30px var(--absensi-shadow-light); padding: 28px 32px; text-align: center; user-select: none; }
    .absensi-module .login h3 { color: var(--absensi-primary-dark); margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: 0.03em; }
    .absensi-module .login input { width: 100%; padding: 14px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; margin: 12px 0; font-size: 1rem; color: var(--absensi-text); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
    .absensi-module .login input:focus { border-color: var(--absensi-primary); box-shadow: 0 0 12px var(--absensi-primary); outline: none; background: #f0f8ff; }
    .absensi-module .login .btn { width: 100%; padding: 14px 0; border: none; border-radius: 14px; background: var(--absensi-primary); color: #fff; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease; user-select: none; }
    .absensi-module .login .btn:hover, .absensi-module .login .btn:focus { background: var(--absensi-primary-dark); box-shadow: 0 8px 24px var(--absensi-shadow-strong); outline: none; }
    .absensi-module select { padding: 12px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; min-width: 220px; background: #f8fcff; cursor: pointer; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; font-weight: 600; color: var(--absensi-text); user-select: none; }
    .absensi-module select:hover, .absensi-module select:focus { border-color: var(--absensi-primary); box-shadow: 0 6px 18px rgba(58,141,222,0.25); outline: none; }
    .absensi-module input { width: 100%; padding: 12px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; background: #f8fcff; color: var(--absensi-text); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; font-size: 1rem; }
    .absensi-module input:focus { border-color: var(--absensi-primary); box-shadow: 0 6px 18px rgba(58,141,222,0.25); outline: none; }
    /* Mobile */
    @media (max-width: 900px) {
      .grid-3 { grid-template-columns: 1fr; }
      .line-card, .line-card-tambahan { grid-template-columns: 1fr 80px 120px 100px 80px; padding: 12px 16px; }
      .cek-ongkir-module .results { grid-template-columns: 1fr; }
      .absensi-module .topbar, .absensi-module .admin-bar { justify-content: flex-start; }
      .absensi-module .table-wrap { overflow-x: auto; }
      .absensi-module table { min-width: 100%; font-size: 14px; }
    }
    @media (max-width: 600px) {
      .container { padding: 10px 12px; margin: 12px auto; }
      .card { padding: 18px 20px; border-radius: 16px; margin-bottom: 16px; }
      h1 { font-size: clamp(20px, 6vw, 28px); }
      h2, h3 { font-size: 1.1rem; margin: 6px 0 12px 0; }
      label { font-size: 13px; margin-top: 10px; }
      input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select { padding: 10px 12px; border-radius: 10px; font-size: 0.85rem; }
      .btn { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; }
      .btnbar { gap: 6px; flex-direction: column; align-items: stretch; }
      nav.tab { grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; border-radius: 14px; }
      nav.tab button { padding: 10px 0; font-size: 0.85rem; border-radius: 12px; }
      .line-card, .line-card-tambahan { grid-template-columns: 3fr 50px 60px 70px; padding: 10px 12px; gap: 6px; }
      .nota-box { padding: 14px 16px; font-size: 0.8rem; min-height: 100px; }
      table { font-size: 0.8rem; }
      th, td { padding: 8px 6px; }
      .section-title { font-size: 0.9rem; margin-top: 8px; }
      .small { font-size: 10px; margin-top: 4px; }
      .notification-popup { padding: 15px 25px; font-size: 1rem; }
      .cek-ongkir-module .brand { font-size: clamp(16px, 2vw, 18px); }
      .cek-ongkir-module .headline { font-size: clamp(18px, 2.5vw, 24px); }
      .absensi-module #pengajuanForm { flex-direction: column; gap: 16px; padding: 16px; }
      .absensi-module #pengajuanForm select, .absensi-module #pengajuanForm button { min-width: 100% !important; width: 100% !important; }
      .absensi-module .table-wrap { overflow-x: auto; }
      .absensi-module table { min-width: 100%; font-size: 13px; }
      .absensi-module thead th, .absensi-module tbody td { padding: 10px 8px; }
      .absensi-module .badge { padding: 5px 10px; font-size: 11px; }
      .absensi-module .btn-mini { padding: 6px 10px; font-size: 12px; }
      .absensi-module .login { width: 90vw; padding: 20px; }
      .absensi-module .login input { padding: 10px 12px; font-size: 0.9rem; }
      .absensi-module .login .btn { padding: 12px 0; font-size: 1rem; }

      #adminDashboard .admin-summary-grid {
        grid-template-columns: 1fr;
      }
      #adminDashboard .tabs {
        justify-content: flex-start;
      }
    }

    /* Admin Dashboard Specific Styles */
    #adminDashboard .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      justify-content: flex-end; /* Align tabs to the right */
    }

    #adminDashboard .tabs button {
      padding: 12px 18px;
      border-radius: 14px;
      border: 1.5px solid var(--border);
      background: var(--card-bg);
      color: var(--text-primary);
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
      transition: background var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease;
      cursor: pointer;
    }

    #adminDashboard .tabs button.active {
      background: var(--admin-box-bg); /* Gold background for active admin tab */
      color: var(--admin-box-text);
      border-color: transparent;
      box-shadow: var(--admin-box-shadow);
    }

    /* Admin Box Styling */
    .admin-box {
      background: var(--admin-box-bg);
      color: var(--admin-box-text);
      border-radius: 20px;
      padding: 24px 28px;
      box-shadow: var(--admin-box-shadow);
      margin-bottom: 20px;
      border: var(--admin-box-border);
      transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease;
    }

    .admin-box:hover {
      box-shadow: 0 20px 45px rgba(255,193,7,0.6);
      transform: translateY(-5px);
    }

    .admin-box h1, .admin-box h2, .admin-box h3, .admin-box h4 {
      color: var(--admin-box-text);
    }

    .admin-box .badge {
      background: #fff;
      color: var(--admin-box-text);
      border: 1px solid #FFD700;
    }

    /* Ensure buttons within admin-box also have gold styling if desired, or keep default */
    .admin-box .btn {
      background: #FFC107; /* A shade of gold */
      color: #333;
      box-shadow: 0 6px 18px rgba(255,193,7,0.3);
    }

    .admin-box .btn:hover {
      background: #FFD700; /* Lighter gold on hover */
      box-shadow: 0 8px 24px rgba(255,193,7,0.5);
    }

    .admin-box .btn.danger {
      background: #dc3545; /* Keep danger red */
      color: #fff;
    }

    .admin-box .btn.secondary {
      background: #f5f7fa;
      color: var(--text-primary);
      border: 1.5px solid #FFD700;
    }

    .admin-box .btn.secondary:hover {
      background: #ffe082;
      border-color: #FFD700;
      color: #333;
    }

    /* Admin Dashboard Header Bar */
    #adminDashboard header .bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: var(--admin-box-bg);
      border-radius: 20px;
      margin-bottom: 20px;
      box-shadow: var(--admin-box-shadow);
      color: var(--admin-box-text);
    }

    #adminDashboard header .bar strong {
      font-size: 1.2rem;
      font-weight: 800;
    }

    #adminDashboard header .bar .badge {
      margin-left: 10px;
      padding: 5px 10px;
      border-radius: 10px;
      background: #fff;
      color: var(--admin-box-text);
      font-weight: 700;
    }

    /* Admin Dashboard Grid for 4 boxes */
    #adminDashboard .admin-summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    #adminDashboard .admin-summary-box {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      text-align: center;
      transition: all 0.3s ease;
      position: relative; /* Added for notification button */
    }

    #adminDashboard .admin-summary-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }

    #adminDashboard .admin-summary-box .icon {
      font-size: 2.5rem;
      color: var(--sky-strong);
      margin-bottom: 10px;
    }

    #adminDashboard .admin-summary-box .value {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    #adminDashboard .admin-summary-box .label {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 5px;
    }

    /* Small notification button in summary box */
    #pendingApprovalsBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--warning-color);
      color: #fff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      cursor: pointer;
      border: none;
      transition: transform 0.2s ease;
    }

    #pendingApprovalsBtn:hover {
      transform: scale(1.1);
    }

    /* Overlay for the pending approvals popup */
    #pendingApprovalsPopup .overlay-content {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 12px 30px var(--shadow-strong);
      border: 1px solid var(--border);
      max-width: 500px; /* Added max-width */
      padding: 20px; /* Added padding */
    }

    #pendingApprovalsPopup h3 {
      color: var(--sky-strong);
      margin-bottom: 15px;
      text-align: center;
    }

    #pendingApprovalsPopup .list-v .card {
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 12px;
      background: #f8faff;
      border: 1px solid #e0eaff;
    }


    /* Responsive adjustments for admin dashboard */
    @media (max-width: 900px) {
      #adminDashboard .admin-summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      #adminDashboard .tabs {
        justify-content: flex-start;
      }
    }

    @media (max-width: 600px) {
      .container { padding: 10px 12px; margin: 12px auto; } /* Adjusted for smaller screens */
      .card { padding: 18px 20px; border-radius: 16px; margin-bottom: 16px; } /* Adjusted for smaller screens */
      h1 { font-size: clamp(20px, 6vw, 28px); } /* Adjusted for smaller screens */
      h2, h3 { font-size: 1.1rem; margin: 6px 0 12px 0; } /* Adjusted for smaller screens */
      label { font-size: 13px; margin-top: 10px; } /* Adjusted for smaller screens */
      input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select { padding: 10px 12px; border-radius: 10px; font-size: 0.85rem; } /* Adjusted for smaller screens */
      .btn { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; } /* Adjusted for smaller screens */
      .btnbar { gap: 6px; flex-direction: column; align-items: stretch; } /* Adjusted for smaller screens */
      nav.tab { grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; border-radius: 14px; }
      nav.tab button { padding: 10px 0; font-size: 0.85rem; border-radius: 12px; }
      .line-card, .line-card-tambahan { grid-template-columns: 3fr 50px 60px 70px; padding: 10px 12px; gap: 6px; }
      .nota-box { padding: 14px 16px; font-size: 0.8rem; min-height: 100px; }
      table { font-size: 0.8rem; }
      th, td { padding: 8px 6px; }
      .section-title { font-size: 0.9rem; margin-top: 8px; }
      .small { font-size: 10px; margin-top: 4px; }
      .notification-popup { padding: 15px 25px; font-size: 1rem; }
      .cek-ongkir-module .brand { font-size: clamp(16px, 2vw, 18px); }
      .cek-ongkir-module .headline { font-size: clamp(18px, 2.5vw, 24px); }
      .absensi-module #pengajuanForm { flex-direction: column; gap: 16px; padding: 16px; }
      .absensi-module #pengajuanForm select, .absensi-module #pengajuanForm button { min-width: 100% !important; width: 100% !important; }
      .absensi-module .table-wrap { overflow-x: auto; }
      .absensi-module table { min-width: 100%; font-size: 13px; }
      .absensi-module thead th, .absensi-module tbody td { padding: 10px 8px; }
      .absensi-module .badge { padding: 5px 10px; font-size: 11px; }
      .absensi-module .btn-mini { padding: 6px 10px; font-size: 12px; }
      .absensi-module .login { width: 90vw; padding: 20px; }
      .absensi-module .login input { padding: 10px 12px; font-size: 0.9rem; }
      .absensi-module .login .btn { padding: 12px 0; font-size: 1rem; }

      #adminDashboard .admin-summary-grid {
        grid-template-columns: 1fr;
      }
      #adminDashboard .tabs {
        flex-direction: column;
        align-items: stretch;
      }
      #adminDashboard .tabs button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Halaman Login Pilihan -->
  <div id="initialLoginChoice" class="card">
    <h1>Selamat Datang di Sahabatku Delivery</h1>
    <p style="text-align:center; margin-bottom:20px; color:var(--muted);">Pilih jenis login Anda:</p>
    <div class="grid grid-2" style="max-width: 400px; margin: 0 auto; gap: 20px;">
      <button id="showKurirLogin" class="btn full"><i class="fa-solid fa-user"></i> Login Kurir</button>
      <button id="showAdminLogin" class="btn secondary full"><i class="fa-solid fa-user-gear"></i> Login Admin</button>
    </div>
  </div>

  <!-- Form Login Kurir -->
  <div id="kurirLoginForm" class="card hidden">
    <h2>Login Kurir</h2>
    <div class="grid grid-3">
      <div><label>Username</label><input id="kurirLoginUser" type="text" placeholder="Nama kurir (contoh: Tom Haye)" autocomplete="username"></div>
      <div><label>Password</label><input id="kurirLoginPass" type="password" placeholder="ID Card (contoh: A1234)" autocomplete="current-password"></div>
      <div style="align-self:end"><div class="btnbar"><button id="kurirLoginBtn" class="btn full">Masuk</button><button id="backToInitialKurir" class="btn secondary full">Kembali</button></div></div>
    </div>
    <p id="kurirLoginMsg" class="small" style="color:var(--error-color);margin-top:8px"></p>
  </div>

  <!-- Form Login Admin -->
  <div id="adminLoginForm" class="card hidden">
    <h2>Login Admin</h2>
    <div class="grid grid-3">
      <div><label>Email</label><input id="adminLoginEmail" type="email" placeholder="admin@email.com"></div>
      <div><label>Password</label><input id="adminLoginPass" type="password" placeholder="••••••••"></div>
      <div style="align-self:end"><div class="btnbar"><button id="adminLoginBtn" class="btn full">Masuk</button><button id="backToInitialAdmin" class="btn secondary full">Kembali</button></div></div>
    </div>
    <p id="adminLoginMsg" class="small" style="color:var(--error-color);margin-top:8px"></p>
  </div>

  <!-- Dashboard Kurir -->
  <div id="kurirDashboard" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><h2>Halo, <span id="curUser"></span></h2><div class="small">Buat nota • Simpan Nota • Rekap bulanan • Pelacak • Cek Ongkir</div></div>
        <div><div class="small">No Nota berikutnya:</div><div id="nextNota" style="font-weight:800;font-size:18px;color:#0b4870">-</div></div>
        <button id="kurirLogoutBtn" class="btn danger">Logout</button>
      </div>
    </div>

    <nav class="tab" id="kurirNavTabs">
      <button data-tab="notaTab" class="active">📝 Nota</button>
      <button data-tab="riwayatTab">📑 Riwayat</button>
      <button data-tab="rekapTab">📊 Rekap</button>
      <button data-tab="pelacakTab">📋 Pelacak</button>
      <button data-tab="cekOngkirModule">📍 Cek Ongkir</button>
      <button data-tab="absensiKurirModule">✅ Absensi Kurir</button>
    </nav>

    <!-- Tab Contents Kurir -->
    <div id="notaTab" class="tabContent">
      <div class="card">
        <h3>Buat / Edit Nota</h3>
        <div class="grid grid-3">
          <div><label>Nama Kurir</label><input id="kurirName" type="text" readonly></div>
          <div><label>Nomor WhatsApp Customer</label><input id="custPhone" type="text" placeholder="6281234... (opsional)"></div>
          <div><label>Ongkir (Rp)</label><input id="ongkir" type="number" value="0" min="0"></div>
        </div>
        <div class="section-title" style="margin-top:14px"><div class="small" style="font-weight:700">Daftar Item</div><div class="btnbar"><button id="btnAddItem" class="btn">+ Item</button><button id="btnClearItems" class="btn secondary">Bersihkan</button></div></div>
        <div id="itemsArea" class="list-v" style="margin-top:10px"></div>
        <div class="section-title" style="margin-top:14px"><div class="small" style="font-weight:700">Tambahan Biaya</div><div class="btnbar"><button id="btnAddTambahan" class="btn secondary">+ Tambahan</button></div></div>
        <div id="tambahanArea" class="list-v" style="margin-top:10px"></div>
        <div class="grid grid-3" style="margin-top:8px;align-items:end">
          <div><label>Total</label><div id="totalPesanan" style="font-weight:800;font-size:22px;color:#0b4870">Rp 0</div><div class="small">Subtotal item + ongkir + tambahan</div></div>
          <div></div>
          <div class="btnbar" style="justify-content:flex-end">
            <button id="btnClearAll" class="btn danger">Bersihkan Semua</button>
            <button id="btnSaveForm" class="btn">Simpan Nota</button>
            <button id="btnExportPreview" class="btn secondary">Simpan Foto</button>
            <button id="btnSharePreview" class="btn secondary">Bagikan WhatsApp</button>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="section-title"><h3 style="margin:0">Preview Nota</h3><div class="small">Nama file: <span id="previewFilename">-</span></div></div>
          <div id="notaPreview" class="nota-box">Belum ada nota.</div>
        </div>
      </div>
    </div>

    <div id="riwayatTab" class="tabContent hidden">
      <div class="card">
        <h3>Riwayat Nota (akun ini)</h3>
        <div id="notaHistory"></div>
      </div>
    </div>

    <div id="rekapTab" class="tabContent hidden">
      <div class="card">
        <h3>Rekap Bulanan</h3>
        <div class="grid grid-3">
          <div><label>Bulan</label><input id="rekapMonth" type="month"></div>
          <div style="align-self:end"><button id="btnLoadRekap" class="btn">Muat Rekap</button></div>
        </div>
        <div class="card" style="margin-top:10px">
          <table aria-label="Rekap Bulanan">
            <thead><tr><th>Tanggal</th><th>Jumlah Nota</th><th>Ongkir</th><th>Tambahan</th><th>Total</th></tr></thead>
            <tbody id="rekapBody"></tbody>
            <tfoot><tr><th>Total Bulan</th><th id="sumNota">0</th><th id="sumOngkir">0</th><th id="sumTambahan">0</th><th id="sumTotal">0</th></tr></tfoot>
          </table>
        </div>
      </div>
    </div>

    <div id="pelacakTab" class="tabContent hidden">
      <div class="card">
        <h3>Pelacak Orderan</h3>
        <p class="small" style="margin-top: -10px; margin-bottom: 10px; color: var(--muted);">Hanya orderan Anda sendiri.</p>
        <div class="grid grid-3">
          <div><label>No Nota</label><input id="trackNoNota" type="text" placeholder="cth: 00012"></div>
          <div><label>Tanggal (YYYY-MM-DD)</label><input id="trackDate" type="text" placeholder="2025-09-01"></div>
          <div style="align-self:end"><div class="btnbar"><button id="btnCariNota" class="btn">Cari</button><button id="btnCariReset" class="btn secondary">Reset</button></div></div>
        </div>
        <div id="pelacakHasil" style="margin-top:10px"></div>
      </div>
    </div>

    <div id="cekOngkirModule" class="tabContent hidden cek-ongkir-module">
      <div class="hero">
        <div class="brand"><i class="fa-solid fa-box"></i> Ongkir Express</div>
        <div class="headline">Cek Tarif Pengiriman – Asal & Tujuan</div>
        <div class="sub">Pilih lokasi lewat pencarian pintar. Bisa isi salah satu atau keduanya. Otomatis hitung sesuai aturan.</div>
      </div>
      <main class="card">
        <div class="card__body">
          <div class="grid">
            <div class="field" id="field-asal">
              <div class="label"><i class="fa-solid fa-location-arrow"></i> Asal (opsional)</div>
              <div class="control"><i class="fa-solid fa-magnifying-glass licon"></i><input id="asalInput" class="input" type="text" placeholder="Ketik lokasi asal… (opsional)"/><button class="clear-btn" title="Bersihkan" id="clearAsal"><i class="fa-solid fa-xmark"></i></button><div class="suggest" id="asalSuggest"></div></div>
            </div>
            <div class="field" id="field-tujuan">
              <div class="label"><i class="fa-solid fa-location-dot"></i> Tujuan</div>
              <div class="control"><i class="fa-solid fa-magnifying-glass licon"></i><input id="tujuanInput" class="input" type="text" placeholder="Ketik lokasi tujuan…"/><button class="clear-btn" title="Bersihkan" id="clearTujuan"><i class="fa-solid fa-xmark"></i></button><div class="suggest" id="tujuanSuggest"></div></div>
            </div>
          </div>
          <div class="actions">
            <button id="cekBtn" class="btn btn-primary"><i class="fa-solid fa-calculator"></i> Cek Ongkir</button>
            <button id="bersihkanBtn" class="btn btn-ghost"><i class="fa-solid fa-broom"></i> Bersihkan</button>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
            <span class="pellet"><i class="fa-regular fa-circle-check"></i> Isi salah satu = ongkir normal</span>
            <span class="pellet"><i class="fa-regular fa-circle-check"></i> Isi dua-duanya = (Asal + Tujuan) − 6.000</span>
          </div>
          <div class="results" id="ongkirResults" style="display:none">
            <div class="kartu"><h4><i class="fa-solid fa-tag"></i> Ongkir Normal</h4><div class="harga" id="normalHarga">–</div><div class="muted" id="normalKeterangan">—</div></div>
            <div class="kartu"><h4><i class="fa-solid fa-route"></i> Ongkir Rute (Asal + Tujuan − 6.000)</h4><div class="harga" id="ruteHarga">–</div><div class="muted" id="ruteKeterangan">—</div><div class="formula" id="ruteFormula" style="display:none"></div></div>
          </div>
        </div>
      </main>
    </div>

    <div id="absensiKurirModule" class="tabContent hidden absensi-module">
      <div class="card">
        <h1>Jadwal & Absensi Kurir</h1>
        <div class="topbar" id="absensiTopbar">
          <button class="btn active" data-tab="tab-jadwal">Jadwal Off</button>
          <button class="btn" data-tab="tab-rekap">Rekap & Keaktifan</button>
          <button class="btn ghost" id="btn-absensi-tab" data-tab="tab-absensi" style="display:none;">Absensi Harian</button>
          <button class="btn ghost" data-tab="tab-approval" id="btn-approval-tab" style="display:none;">Approval Kurir</button>
          <div class="month-wrap">
            <label for="monthPick"><small>Bulan:</small></label>
            <input type="month" id="monthPick"/>
          </div>
          <!-- Tombol login/logout absensi dihapus dari sini -->
        </div>

        <div class="admin-bar" id="absensiAdminBar">
          <button class="btn alt" id="btn-save">Save Data (Firestore)</button>
          <button class="btn" id="btn-add">Tambah Kurir</button>
          <button class="btn danger" id="btn-del">Hapus Kurir</button>
          <button class="btn alt" id="btn-regen">Regenerasi Off</button>
          <!-- Tombol logout absensi dihapus dari sini -->
        </div>

        <!-- Tabs Absensi -->
        <div id="tab-jadwal" class="tab active">
          <div id="pengajuanForm">
            <select id="pengajuanTanggal"></select>
            <select id="penggantiKurir"></select>
            <select id="tanggalTukar"></select>
            <button class="btn" id="btnAjukan">Ajukan Tukar Off</button>
          </div>
          <div class="table-wrap">
            <table id="tableJadwal">
              <thead><tr><th>Tanggal</th><th>Hari</th><th>Kurir Off</th><th>Pengganti</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-absensi" class="tab">
          <div class="table-wrap">
            <table id="tableAbsensi">
              <thead><tr><th>Tanggal</th><th>Nama Kurir</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-rekap" class="tab">
          <div class="table-wrap">
            <table id="tableRekap">
              <thead><tr><th>Nama Kurir</th><th>Total On</th><th>Total Off</th><th>Skor Keaktifan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-approval" class="tab">
          <div class="table-wrap">
            <table id="tableApproval">
              <thead><tr><th>Tanggal</th><th>Kurir Asal</th><th>Pengganti</th><th>Status</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Admin -->
  <div id="adminDashboard" class="hidden">
    <header>
      <div class="bar">
        <div class="flex"><strong>📊 Admin Panel</strong><span class="badge">👑 Admin</span></div>
        <button id="adminLogoutBtn" class="btn danger">Logout</button>
      </div>
    </header>

    <!-- Admin Summary Boxes -->
    <div class="admin-summary-grid">
      <div class="admin-summary-box">
        <div class="icon"><i class="fa-solid fa-file-invoice"></i></div>
        <div class="value" id="totalNotasAdmin">0</div>
        <div class="label">Total Nota</div>
      </div>
      <div class="admin-summary-box">
        <div class="icon"><i class="fa-solid fa-users"></i></div>
        <div class="value" id="totalKurirAdmin">0</div>
        <div class="label">Jumlah Kurir</div>
      </div>
      <div class="admin-summary-box">
        <div class="icon"><i class="fa-solid fa-money-bill-wave"></i></div>
        <div class="value" id="totalRevenueAdmin">Rp 0</div>
        <div class="label">Total Pendapatan</div>
      </div>
      <div class="admin-summary-box">
        <div class="icon"><i class="fa-solid fa-calendar-check"></i></div>
        <div class="value" id="pendingApprovalsAdmin">0</div>
        <div class="label">Pengajuan Pending</div>
        <!-- Tombol notifikasi kecil di sini -->
        <button class="btn-mini" id="pendingApprovalsBtn" style="position: absolute; top: 10px; right: 10px; background: var(--warning-color); color: #fff; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
          <i class="fa-solid fa-bell"></i>
        </button>
      </div>
    </div>

    <div class="card admin-box"> <!-- Apply admin-box class here -->
      <div class="tabs">
        <button class="btn active" data-tab="tabNotaAdmin">📝 Kelola Nota</button>
        <button class="btn" data-tab="tabRekapAdmin">📈 Rekap & Riwayat</button>
        <button class="btn" data-tab="tabKurirAdmin">👥 Manajemen Kurir</button>
        <button class="btn" data-tab="tabOngkirAdmin">🚚 Manajemen Ongkir</button>
        <button class="btn" data-tab="tabAbsensiAdmin">✅ Manajemen Absensi</button>
      </div>
    </div>

    <!-- Kelola Nota Admin -->
    <div id="tabNotaAdmin" class="card tab">
      <div class="row">
        <div><label>Nama Kurir</label><select id="filterKurir"><option value="">— Semua Kurir —</option></select></div>
        <div><label>Tanggal</label><input type="date" id="filterTanggal"></div>
        <div><label>Bulan</label><input type="month" id="filterBulan"></div>
        <div><label>Tahun</label><input type="number" id="filterTahun" min="2020" placeholder="2025"></div>
      </div>
      <div class="row" style="justify-content: flex-end;"> <!-- Align to the right -->
        <div><label>Cari Nota (No Nota)</label><input id="filterCariNota" list="listNoNota" placeholder="Pilih/ketik No Nota"><datalist id="listNoNota"></datalist></div>
        <div style="align-self:end" class="btnbar">
          <button class="btn secondary" onclick="applyFilter()">Filter</button>
          <button class="btn secondary" onclick="clearFilter()">Reset</button>
          <!-- <button class="btn" onclick="showAddForm()">+ Tambah Nota</button> --> <!-- Dihilangkan sesuai permintaan -->
          <button class="btn secondary" onclick="exportCSV()">⬇ Export CSV (hasil filter)</button>
        </div>
      </div>
      <div id="notaList"></div>

      <!-- Form Tambah/Edit Nota Admin -->
      <div id="notaForm" class="card hidden">
        <h3 id="formTitle">Tambah Nota</h3>
        <div class="grid grid-2"> <!-- Changed to grid-2 for better alignment -->
          <div><label>Kurir (dropdown / ketik manual)</label><input id="formKurir" list="listKurir" placeholder="Pilih/ketik kurir"><datalist id="listKurir"></datalist></div>
          <div><label>No Nota</label><input id="formNoNota" placeholder="NN-001 / otomatis"></div>
        </div>
        <h4>Item</h4>
        <table id="itemTable">
          <thead><tr><th>Nama</th><th>Qty</th><th>Harga</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="flex" style="justify-content: flex-end;"><button class="btn ghost" onclick="addItemRow()">+ Item</button></div> <!-- Align to the right -->
        <div class="grid grid-3">
          <div><label>Ongkir</label><input id="formOngkir" type="number" value="0"></div>
          <div><label>Tambahan</label><input id="formTambahan" type="number" value="0"></div>
          <div><label>Keterangan</label><input id="formText" placeholder="Catatan…"></div>
        </div>
        <h4>Total: Rp <span id="formTotal">0</span></h4>
        <div class="btnbar" style="justify-content: flex-end;"> <!-- Align to the right -->
          <button class="btn" onclick="saveNota()">Simpan</button>
          <button class="btn danger" onclick="cancelNota()">Batal</button>
        </div>
      </div>
    </div>

    <!-- Rekap & Riwayat Admin -->
    <div id="tabRekapAdmin" class="card tab hidden">
      <div class="row" style="justify-content: flex-end;"> <!-- Align to the right -->
        <div><label>Kurir</label><select id="rekapKurirAdmin"><option value="">— Semua Kurir —</option></select></div>
        <div><label>Bulan</label><input type="month" id="rekapBulanAdmin"></div>
        <div style="align-self:end"><button class="btn secondary" onclick="renderRekapAdmin()">Terapkan</button></div>
      </div>
      <div class="flex" style="justify-content: flex-end; gap: 10px; margin-top: 10px;"> <!-- Align to the right -->
        <span class="pill">Mode: Total Nota per Kurir</span>
        <span class="pill">Mode: Penghasilan (tanggal, jumlah, ongkir, tambahan, total)</span>
      </div>
      <div id="rekapRingkasAdmin" style="margin-top:10px"></div>
      <div id="rekapTabelAdmin"></div>
      <div class="flex" style="justify-content: flex-end;"><button class="btn secondary" onclick="exportCSVRekapAdmin()">⬇ Export CSV (Rekap)</button></div> <!-- Align to the right -->
    </div>

    <!-- Manajemen Kurir Admin -->
    <div id="tabKurirAdmin" class="card tab hidden">
      <div class="row" style="justify-content: flex-end;"> <!-- Align to the right -->
        <div><label>Tambah Kurir Baru</label><input id="kurirBaru" placeholder="Nama kurir (username)"></div>
        <div><label>Password (kurir)</label><input id="kurirPass" type="password" placeholder="minimal 4 karakter"></div>
      </div>
      <div class="flex" style="justify-content: flex-end; gap: 10px;"> <!-- Align to the right -->
        <button class="btn" onclick="tambahKurirAdmin()">+ Tambah Kurir</button>
        <span class="pill">Akun dibuat di Auth (email: username@kurir.local) & daftar kurir di DB.</span>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <div class="row" style="justify-content: flex-end;"> <!-- Align to the right -->
        <div><label>Hapus Kurir</label><select id="kurirManage"></select></div>
        <div style="align-self:end"><button class="btn danger" onclick="hapusKurirAdmin()">Hapus Kurir</button></div>
      </div>
      <small style="display: block; text-align: right; margin-top: 8px;">Catatan: Menghapus kurir akan menonaktifkan akses di aplikasi kurir dengan menghapus entri kurir di DB. (Penghapusan akun Auth penuh memerlukan server admin.)</small> <!-- Align to the right -->
      <div style="text-align: right; margin-top: 10px;"><button class="btn secondary" onclick="ubahPasswordKurirAdmin()">Ubah Password Kurir</button></div> <!-- Align to the right -->
      <h4 style="text-align: right; margin-top: 20px;">Daftar Kurir & Password</h4>
      <div id="kurirListTable" class="table-wrap">
        <table id="tableKurirPasswords">
          <thead>
            <tr>
              <th>Username</th>
              <th>Password</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data kurir akan dimuat di sini oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Manajemen Ongkir Admin -->
    <div id="tabOngkirAdmin" class="card tab hidden">
      <div class="row" style="justify-content: flex-end;"> <!-- Align to the right -->
        <div><label>Wilayah</label><input id="wilayahInput" list="wilayahList" placeholder="Pilih/ketik wilayah"><datalist id="wilayahList"></datalist></div>
        <div><label>Harga Ongkir</label><input id="hargaOngkir" type="number" placeholder="0"></div>
        <div style="align-self:end" class="btnbar">
          <button class="btn" onclick="simpanOngkirAdmin()">💾 Save/Update</button>
          <button class="btn danger" onclick="hapusOngkirAdmin()">🗑 Hapus</button>
        </div>
      </div>
      <small style="display: block; text-align: right; margin-top: 8px; color: var(--muted);">Catatan: Perhitungan cek ongkir hanya menggunakan Wilayah dan Harga Ongkir, tidak termasuk Zona.</small>
      <h4 style="text-align: right;">Data Wilayah</h4> <!-- Align to the right -->
      <div id="ongkirTabel"></div>
    </div>

    <!-- Manajemen Absensi Admin -->
    <div id="tabAbsensiAdmin" class="card tab hidden">
      <div class="absensi-module">
        <h1>Manajemen Absensi</h1>
        <div class="topbar" id="absensiTopbarAdmin">
          <button class="btn active" data-tab="tab-jadwal-admin">Jadwal Off</button>
          <button class="btn" data-tab="tab-rekap-admin">Rekap & Keaktifan</button>
          <button class="btn" data-tab="tab-absensi-admin">Absensi Harian</button>
          <button class="btn" data-tab="tab-approval-admin">Approval Kurir</button>
          <div class="month-wrap">
            <label for="monthPickAdmin"><small>Bulan:</small></label>
            <input type="month" id="monthPickAdmin"/>
          </div>
        </div>

        <div class="admin-bar" id="absensiAdminBarAdmin">
          <button class="btn alt" id="btn-save-admin">Save Data (Firestore)</button>
          <button class="btn" id="btn-add-admin">Tambah Kurir</button>
          <button class="btn danger" id="btn-del-admin">Hapus Kurir</button>
          <button class="btn alt" id="btn-regen-admin">Regenerasi Off</button>
        </div>

        <!-- Tabs Absensi Admin -->
        <div id="tab-jadwal-admin" class="tab active">
          <div class="table-wrap">
            <table id="tableJadwalAdmin">
              <thead><tr><th>Tanggal</th><th>Hari</th><th>Kurir Off</th><th>Pengganti</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-absensi-admin" class="tab">
          <div class="table-wrap">
            <table id="tableAbsensiAdmin">
              <thead><tr><th>Tanggal</th><th>Nama Kurir</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-rekap-admin" class="tab">
          <div class="table-wrap">
            <table id="tableRekapAdmin">
              <thead><tr><th>Nama Kurir</th><th>Total On</th><th>Total Off</th><th>Skor Keaktifan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-approval-admin" class="tab">
          <div class="table-wrap">
            <table id="tableApprovalAdmin">
              <thead><tr><th>Tanggal</th><th>Kurir Asal</th><th>Pengganti</th><th>Status</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pop Notifikasi -->
<div id="notificationPopup" class="notification-popup"></div>
<audio id="notificationSound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>

<!-- Pop-up Foto Nota -->
<div id="notaPhotoOverlay" class="overlay">
  <div class="overlay-content">
    <button class="overlay-close" id="closePhotoOverlay">&times;</button>
    <img id="notaPhotoImage" src="" alt="Nota Photo" />
    <div class="btnbar" style="margin-top: 15px; justify-content: center;">
      <button class="btn" id="saveNotaPhotoBtn"><i class="fa-solid fa-download"></i> Save Foto</button>
      <button class="btn secondary" id="copyNotaTextBtn"><i class="fa-solid fa-copy"></i> Salin Teks</button>
    </div>
  </div>
</div>

<!-- Pop-up Notifikasi untuk Pengajuan Pending (Contoh) -->
<div id="pendingApprovalsPopup" class="overlay" style="z-index: 10001;">
  <div class="overlay-content" style="max-width: 500px; padding: 20px;">
    <button class="overlay-close" id="closePendingApprovalsPopup">&times;</button>
    <h3>Pengajuan Pending</h3>
    <div id="pendingApprovalsList" class="list-v">
      <!-- Daftar pengajuan pending akan dimuat di sini oleh JavaScript -->
      <p class="small">Tidak ada pengajuan pending.</p>
    </div>
  </div>
</div>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, set, get, onValue, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Firebase config Anda (SATU KONFIGURASI UNTUK SEMUA LAYANAN)
  const firebaseConfig = {
    apiKey: "AIzaSyCtva8TeL40-WotK4kFL_vL8uUXL3GDfww", // Ganti dengan API Key Anda
    authDomain: "sahabatkuu-bisa.firebaseapp.com",
    databaseURL: "https://sahabatkuu-bisa-default-rtdb.asia-southeast1.firebasedatabase.app", // Realtime Database
    projectId: "sahabatkuu-bisa",
    storageBucket: "sahabatkuu-bisa.firebasestorage.app",
    messagingSenderId: "315555564115",
    appId: "1:315555564115:web:56f46dbceb8c154589d4a6",
    measurementId: "G-PFGYL96VPS"
  };

  // Inisialisasi Firebase App (HANYA SATU INSTANCE)
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app); // Realtime Database
  const firestoreDb = getFirestore(app); // Firestore
  const auth = getAuth(app); // Authentication
  try { getAnalytics(app); } catch(e) {} // Optional analytics

  // UID Admin untuk Main App (Realtime Database) dan Absensi App (Firestore)
  // Diasumsikan admin untuk kedua modul adalah pengguna Firebase yang sama dalam satu proyek.
  const ADMIN_UID = "kSW4ThusrwhUFCQeTsnPV1VNaR72";
  const ABSENSI_ADMIN_UID = ADMIN_UID; // Menggunakan UID admin yang sama

  // ====================================================================
  // Helper Functions (UI & Notifikasi)
  // ====================================================================
  const el = (id) => document.getElementById(id);
  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
  const money = (n) => (Number(n) || 0).toLocaleString('id-ID');
  const leftPad = (num, len = 5) => String(num).padStart(len, '0');

  function showNotification(message, type = 'success') {
    const popup = el('notificationPopup');
    popup.textContent = message;
    popup.className = `notification-popup show ${type}`;
    el('notificationSound').play();
    setTimeout(() => {
      popup.classList.remove('show');
    }, 3000);
  }

  function showSection(id) {
    qsa('.container > div').forEach(div => div.classList.add('hidden'));
    el(id).classList.remove('hidden');
  }

  function setActiveTab(tabContainerId, tabId) {
    qsa(`#${tabContainerId} button`).forEach(b => {
      b.classList.toggle('active', b.dataset.tab === tabId);
    });
    // For kurir dashboard, tabContents are direct children of the parent of the nav.
    // For admin dashboard, tabs are direct children of the card, and their content divs are also direct children of the card.
    if (tabContainerId === 'kurirNavTabs') {
      qsa('#kurirDashboard .tabContent').forEach(t => t.classList.add('hidden'));
    } else if (tabContainerId === 'adminDashboard .tabs') {
      qsa('#adminDashboard .tab').forEach(t => t.classList.add('hidden'));
    } else if (tabContainerId.startsWith('absensiTopbar')) { // For absensi module internal tabs
      qsa(`#${tabContainerId.replace('Topbar', '')} .tab`).forEach(t => t.classList.add('hidden'));
    }
    
    el(tabId).classList.remove('hidden');

    // Trigger specific refresh for tabs
    if (tabId === 'riwayatTab') refreshNotaHistory();
    if (tabId === 'rekapTab') el('btnLoadRekap').click(); // Auto-load rekap
    if (tabId === 'cekOngkirModule') el('tujuanInput').focus(); // Focus on input
    if (tabId === 'absensiKurirModule') absensiQuickSync(); // Refresh absensi (kurir)
    if (tabId === 'tabNotaAdmin') loadAllAdminData(); // Refresh admin nota
    if (tabId === 'tabRekapAdmin') renderRekapAdmin(); // Refresh admin rekap
    if (tabId === 'tabKurirAdmin') { fillKurirManageAdmin(); renderKurirPasswordsTable(); } // Refresh admin kurir and password table
    if (tabId === 'tabOngkirAdmin') setupOngkirRealtimeAdmin(); // Refresh admin ongkir
    if (tabId === 'tabAbsensiAdmin') absensiAdminQuickSync(); // Refresh admin absensi
  }

  // ====================================================================
  // Initial Login Choice
  // ====================================================================
  el('showKurirLogin').addEventListener('click', () => showSection('kurirLoginForm'));
  el('showAdminLogin').addEventListener('click', () => showSection('adminLoginForm'));

  // ====================================================================
  // Kurir Login
  // ====================================================================
  let currentUser = null;
  let lastNoNota = 0;
  let notaCounterLoaded = false;

  // Dummy users for quick testing (can be removed if all users are in Firebase)
  const sampleUsers = {
    "Sonia":"A0103","Alfan":"A0106","Hafiz":"A0108","Gilang":"A0109","Kardianto":"A0110","Eblek":"A0112",
    "Nandar":"A0117","Pitri":"A0115","Robi":"A0118","Hambali":"A0119","Ulum":"A0120","Admin":"A1111"
  };

  el('kurirLoginBtn').addEventListener('click', doKurirLogin);
  el('backToInitialKurir').addEventListener('click', () => showSection('initialLoginChoice'));
  el('kurirLogoutBtn').addEventListener('click', doKurirLogout);

  async function doKurirLogin() {
    const u = el('kurirLoginUser').value.trim();
    const p = el('kurirLoginPass').value.trim();
    const msgEl = el('kurirLoginMsg');
    msgEl.innerText = '';

    // 1. Check sampleUsers (dummy)
    if (u && sampleUsers[u] === p) {
      return kurirLoginSuccess(u);
    }

    // 2. Check Firebase Realtime Database (kurir/{username})
    try {
      const snap = await get(ref(db, 'kurir/' + u));
      if (snap.exists()) {
        const data = snap.val();
        if (!data.enabled) {
          msgEl.innerText = 'Akun ini dinonaktifkan!';
          return;
        }
        if (data.password !== p) {
          msgEl.innerText = 'Password salah!';
          return;
        }
        return kurirLoginSuccess(data.username);
      } else {
        msgEl.innerText = 'User tidak ditemukan!';
      }
    } catch (err) {
      console.error("Firebase error:", err);
      msgEl.innerText = 'Gagal konek Firebase atau user tidak ditemukan!';
    }
  }

  function kurirLoginSuccess(username) {
    currentUser = username;
    localStorage.setItem('currentUser', username);
    showSection('kurirDashboard');
    el('curUser').innerText = currentUser;
    el('kurirName').value = currentUser;
    setActiveTab('kurirNavTabs', 'notaTab');
    ensureCounter().then(updateNextNotaLabel);
    refreshNotaHistory();
    showNotification(`Selamat datang, ${currentUser}!`, 'success');
  }

  function doKurirLogout() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    showSection('initialLoginChoice');
    showNotification('Anda telah logout.', 'info');
  }

  // Auto-login kurir jika sudah ada di localStorage
  window.addEventListener('load', () => {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      el('kurirLoginUser').value = savedUser;
      // Try to login with saved user (password might be needed if not dummy)
      // In a real app, you'd re-authenticate or use persistent session
      doKurirLogin();
    }
  });

  // ====================================================================
  // Admin Login
  // ====================================================================
  el('adminLoginBtn').addEventListener('click', doAdminLogin);
  el('backToInitialAdmin').addEventListener('click', () => showSection('initialLoginChoice'));
  el('adminLogoutBtn').addEventListener('click', doAdminLogout);

  async function doAdminLogin() {
    const email = el('adminLoginEmail').value.trim();
    const password = el('adminLoginPass').value.trim();
    const msgEl = el('adminLoginMsg');
    msgEl.innerText = '';

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      if (userCredential.user.uid === ADMIN_UID) {
        showSection('adminDashboard');
        loadAllAdminData();
        showNotification('Login Admin Berhasil!', 'success');

        // Otomatis set status admin absensi
        isAbsensiAdmin = true;
        setAbsensiAdminUI(true); // Aktifkan UI admin absensi
        absensiAdminQuickSync(); // Initial sync for admin absensi
        showNotification('Fitur admin absensi diaktifkan.', 'info');

      } else {
        msgEl.innerText = 'Anda bukan admin yang berwenang.';
        await signOut(auth); // Log out non-admin user
        isAbsensiAdmin = false; // Pastikan status admin absensi juga false
        setAbsensiAdminUI(false);
      }
    } catch (error) {
      console.error("Admin login error:", error);
      msgEl.innerText = 'Login gagal: ' + error.message;
      showNotification('Login Admin Gagal!', 'error');
      isAbsensiAdmin = false; // Pastikan status admin absensi juga false
      setAbsensiAdminUI(false);
    }
  }

  async function doAdminLogout() {
    try {
      await signOut(auth); // Logout dari main app
      isAbsensiAdmin = false;
      setAbsensiAdminUI(false); // Nonaktifkan UI admin absensi
      showSection('initialLoginChoice');
      showNotification('Admin telah logout.', 'info');
    } catch (error) {
      console.error("Admin logout error:", error);
      showNotification('Gagal logout Admin!', 'error');
    }
  }

  // ====================================================================
  // Kurir Dashboard: Nota Tab
  // ====================================================================
  const itemsArea = el('itemsArea');
  const tambahanArea = el('tambahanArea');

  el('btnAddItem').addEventListener('click', () => addItemUI());
  el('btnClearItems').addEventListener('click', () => { itemsArea.innerHTML = ''; addItemUI(); updateTotals(); });
  el('btnAddTambahan').addEventListener('click', () => addTambahanUI());
  el('ongkir').addEventListener('input', updateTotals);
  el('btnSaveForm').addEventListener('click', saveNoteToFirebase);
  el('btnExportPreview').addEventListener('click', savePreviewAsImage);
  el('btnSharePreview').addEventListener('click', sharePreviewImage);
  el('btnClearAll').addEventListener('click', clearAllNotaForm);

  // Default one item and one additional field
  addItemUI();
  addTambahanUI();

  function addItemUI(pref = {}) {
    const wrap = document.createElement('div');
    wrap.className = 'line-card';
    wrap.innerHTML = `
      <div><label class="small">Nama Item</label><input class="iname" type="text" value="${pref.name || ''}" placeholder="Nama menu / barang"></div>
      <div><label class="small">Qty</label><input class="iqty" type="number" min="1" value="${pref.qty || 1}"></div>
      <div><label class="small">Harga (Rp)</label><input class="iprice" type="number" min="0" value="${pref.price || 0}"></div>
      <div><label class="small">Subtotal</label><div class="sub isub">0</div></div>
      <div><button class="btn danger mini-btn removeBtn">Hapus</button></div>
    `;
    itemsArea.appendChild(wrap);
    wrap.querySelectorAll('input').forEach(i => i.addEventListener('input', updateTotals));
    wrap.querySelector('.removeBtn').addEventListener('click', () => { wrap.remove(); updateTotals(); });
    updateTotals();
  }

  function addTambahanUI(pref = {}) {
    const row = document.createElement('div');
    row.className = 'line-card-tambahan';
    row.innerHTML = `
      <div><label class="small">Jenis Tambahan</label><select class="t-type">
        <option ${!pref.type ? 'selected' : ''} value="">-- Pilih --</option>
        <option ${pref.type === 'Tambahan Ojeg' ? 'selected' : ''} value="Tambahan Ojeg">Tambahan Ojeg</option>
        <option ${pref.type === 'Tambahan Malam' ? 'selected' : ''} value="Tambahan Malam">Tambahan Malam</option>
        <option ${pref.type === 'Tambahan Tempat' ? 'selected' : ''} value="Tambahan Tempat">Tambahan Tempat</option>
        <option ${pref.type === 'Tambahan Hujan' ? 'selected' : ''} value="Tambahan Hujan">Tambahan Hujan</option>
        <option ${pref.type === 'Tambahan Parkir' ? 'selected' : ''} value="Tambahan Parkir">Tambahan Parkir</option>
        <option ${pref.type === 'Tambahan Melebihi Kapasitas' ? 'selected' : ''} value="Tambahan Melebihi Kapasitas">Tambahan Melebihi Kapasitas</option>
        <option ${pref.type === 'Lainnya' ? 'selected' : ''} value="Lainnya">Lainnya</option>
      </select></div>
      <div><label class="small">Nominal (Rp)</label><input class="t-nom" type="number" min="0" value="${pref.nominal || 0}"></div>
      <div><button class="btn secondary mini-btn t-remove">Hapus</button></div>
    `;
    tambahanArea.appendChild(row);
    row.querySelector('.t-nom').addEventListener('input', updateTotals);
    row.querySelector('.t-type').addEventListener('change', updateTotals);
    row.querySelector('.t-remove').addEventListener('click', () => { row.remove(); updateTotals(); });
    updateTotals();
  }

  function updateTotals() {
    let total = 0;
    itemsArea.querySelectorAll('.line-card').forEach(c => {
      const qty = Number(c.querySelector('.iqty').value) || 0;
      const price = Number(c.querySelector('.iprice').value) || 0;
      const sub = qty * price;
      c.querySelector('.isub').innerText = sub.toLocaleString('id-ID');
      total += sub;
    });
    const ong = Number(el('ongkir').value) || 0;
    total += ong;
    let t = 0;
    tambahanArea.querySelectorAll('.t-nom').forEach(n => t += Number(n.value) || 0);
    total += t;
    el('totalPesanan').innerText = 'Rp ' + total.toLocaleString('id-ID');
    updatePreviewFilename();
    return total;
  }

  function clearAllNotaForm() {
    if (!confirm('Yakin ingin membersihkan semua input nota?')) return;
    el('custPhone').value = '';
    el('ongkir').value = 0;
    itemsArea.innerHTML = '';
    tambahanArea.innerHTML = '';
    addItemUI();
    addTambahanUI();
    updateTotals();
    showNotification('Form nota dibersihkan.', 'info');
  }

  function updatePreviewFilename() {
    const noNota = leftPad((lastNoNota || 0) + 1);
    const filename = `${currentUser || 'User'}_nota_${noNota}.jpg`;
    el('previewFilename').innerText = filename;
    return filename;
  }

  function buildNotaObject() {
    const items = [];
    let subtotal = 0;
    itemsArea.querySelectorAll('.line-card').forEach((c) => {
      const name = (c.querySelector('.iname').value || '').trim();
      const qty = Number(c.querySelector('.iqty').value) || 0;
      const price = Number(c.querySelector('.iprice').value) || 0;
      const sub = qty * price;
      subtotal += sub;
      if (name && (qty > 0 || price > 0)) items.push({ name, qty, price, subtotal: sub });
    });

    const tambahans = [];
    let tambahTotal = 0;
    tambahanArea.querySelectorAll('.line-card-tambahan').forEach(r => {
      const type = (r.querySelector('.t-type').value || '').trim();
      const nominal = Number(r.querySelector('.t-nom').value) || 0;
      if (type && nominal > 0) {
        tambahans.push({ type, nominal });
        tambahTotal += nominal;
      }
    });

    const ongkir = Number(el('ongkir').value) || 0;
    const custPhone = (el('custPhone').value || '').replace(/\D/g, '');
    const kurir = currentUser || '';

    const total = subtotal + ongkir + tambahTotal;
    const noNota = leftPad((lastNoNota || 0) + 1);
    const createdAt = new Date().toISOString();

    const lines = [];
    lines.push('🧾 NOTA SAHABATKU DELIVERY');
    lines.push('==========================');
    lines.push(`Kurir  : ${kurir}`);
    lines.push(`No     : ${noNota}`);
    lines.push(`Tanggal: ${new Date(createdAt).toLocaleString('id-ID')}`);
    if (custPhone) lines.push(`WA     : ${custPhone}`);
    lines.push('--------------------------');
    if (items.length === 0) {
      lines.push('Tidak ada item.');
    } else {
      items.forEach((it, i) => lines.push(`${i + 1}. ${it.name} (${it.qty} x Rp ${it.price.toLocaleString('id-ID')}) = Rp ${it.subtotal.toLocaleString('id-ID')}`));
    }
    lines.push('--------------------------');
    lines.push(`Ongkir   : Rp ${ongkir.toLocaleString('id-ID')}`);
    if (tambahans.length > 0) {
      tambahans.forEach(t => lines.push(`${t.type}: Rp ${Number(t.nominal).toLocaleString('id-ID')}`));
    }
    lines.push(`TOTAL    : Rp ${total.toLocaleString('id-ID')}`);
    lines.push('');
    lines.push('Terima kasih sudah menggunakan Sahabatku Delivery 🙏');

    const text = lines.join('\n');
    el('notaPreview').innerText = text;

    return {
      kurir, noNota, createdAt,
      items, tambahans, ongkir, total, custPhone, text
    };
  }

  // ====================================================================
  // Counter No Nota per user
  // ====================================================================
  async function ensureCounter() {
    if (!currentUser) return;
    if (notaCounterLoaded) return;
    const cRef = ref(db, `counters/${currentUser}`);
    const snap = await get(cRef);
    if (!snap.exists()) {
      await set(cRef, { lastNoNota: 0 });
      lastNoNota = 0;
    } else {
      lastNoNota = Number(snap.val().lastNoNota) || 0;
    }
    notaCounterLoaded = true;
  }

  async function increaseCounter() {
    await ensureCounter();
    lastNoNota = (Number(lastNoNota) || 0) + 1;
    await update(ref(db, `counters/${currentUser}`), { lastNoNota });
    updateNextNotaLabel();
    return lastNoNota;
  }

  function updateNextNotaLabel() {
    el('nextNota').innerText = leftPad((lastNoNota || 0) + 1);
  }

  // ====================================================================
  // Save Nota to Firebase
  // ====================================================================
  async function saveNoteToFirebase() {
    if (!currentUser) { showNotification('Login dulu.', 'error'); return; }
    const data = buildNotaObject();
    if (data.items.length === 0 && data.ongkir === 0 && data.tambahans.length === 0) {
      showNotification('Nota kosong, tidak bisa disimpan.', 'warning');
      return;
    }

    const curNo = await increaseCounter();
    data.noNota = leftPad(curNo);

    const noteId = 'nota_' + Date.now();
    const noteObj = { id: noteId, ...data };

    try {
      await set(ref(db, `nota/${currentUser}/${noteId}`), noteObj);
      await set(ref(db, `pelacakByNo/${data.noNota}/${noteId}`), {
        username: currentUser, createdAt: data.createdAt, total: data.total
      });
      const keyDate = data.createdAt.slice(0, 10);
      await set(ref(db, `pelacakByDate/${keyDate}/${noteId}`), {
        username: currentUser, noNota: data.noNota, total: data.total
      });

      showNotification(`Nota Tersimpan ✅ (No Nota ${data.noNota})`, 'success');
      clearAllNotaForm(); // Clear form after successful save
      refreshNotaHistory();
      updatePreviewFilename();
    } catch (error) {
      console.error("Error saving note:", error);
      showNotification('Gagal menyimpan nota: ' + error.message, 'error');
    }
  }

  // ====================================================================
  // Kurir Dashboard: Riwayat Tab
  // ====================================================================
  function refreshNotaHistory() {
    if (!currentUser) return;
    const listEl = el('notaHistory');
    listEl.innerHTML = 'Memuat...';
    const notesRef = ref(db, `nota/${currentUser}`);
    onValue(notesRef, (snap) => {
      const val = snap.val() || {};
      const arr = Object.values(val).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
      if (arr.length === 0) { listEl.innerHTML = '<p class="small">Belum ada nota.</p>'; return; }
      let html = '<div class="list-v">';
      arr.forEach(n => {
        html += `<div style="display:flex;justify-content:space-between;align-items:center;border:1px solid #eef6ff;padding:12px;border-radius:12px;background:#fff;gap:8px">
          <div style="flex:1">
            <div class="small">${new Date(n.createdAt).toLocaleString('id-ID')}</div>
            <div style="font-weight:800">No: ${n.noNota} • Total: Rp ${(Number(n.total) || 0).toLocaleString('id-ID')}</div>
            <div class="small">${(n.items || []).length} item • Ongkir Rp ${(Number(n.ongkir) || 0).toLocaleString('id-ID')}</div>
          </div>
          <div class="btnbar">
            <button class="btn secondary" onclick="viewNote('${n.id}')">Lihat</button>
            <button class="btn danger" onclick="hapusNote('${n.id}')">Hapus</button>
          </div>
        </div>`;
      });
      html += '</div>';
      listEl.innerHTML = html;
    });
  }

  window.viewNote = async (id) => {
    const snap = await get(ref(db, `nota/${currentUser}/${id}`));
    if (!snap.exists()) { showNotification('Nota tidak ditemukan', 'error'); return; }
    const n = snap.val();
    el('notaPreview').innerText = n.text || '';
    setActiveTab('kurirNavTabs', 'notaTab');
  };

  window.hapusNote = async (id) => {
    if (!confirm('Hapus nota ini dari Firebase?')) return;
    try {
      const notaRef = ref(db, `nota/${currentUser}/${id}`);
      const notaSnap = await get(notaRef);
      const notaData = notaSnap.val();

      await remove(notaRef);
      if (notaData && notaData.noNota) {
        await remove(ref(db, `pelacakByNo/${notaData.noNota}/${id}`));
        const keyDate = notaData.createdAt.slice(0, 10);
        await remove(ref(db, `pelacakByDate/${keyDate}/${id}`));
      }
      showNotification('Nota terhapus.', 'info');
      refreshNotaHistory(); // Refresh history after deletion
      el('pelacakHasil').innerHTML = ''; // Clear pelacak results
    } catch (error) {
      console.error("Error deleting note:", error);
      showNotification('Gagal menghapus nota: ' + error.message, 'error');
    }
  };

  // ====================================================================
  // Kurir Dashboard: Rekap Tab
  // ====================================================================
  el('btnLoadRekap').addEventListener('click', async () => {
    if (!currentUser) { showNotification('Login dulu.', 'error'); return; }
    const ym = el('rekapMonth').value;
    if (!ym) { showNotification('Pilih bulan.', 'warning'); return; }
    const [year, month] = ym.split('-').map(Number);

    const snap = await get(ref(db, `nota/${currentUser}`));
    const val = snap.val() || {};
    const arr = Object.values(val);
    const byDate = {};

    arr.forEach(n => {
      const d = new Date(n.createdAt);
      if (d.getFullYear() === year && (d.getMonth() + 1) === month) {
        const key = n.createdAt.slice(0, 10);
        if (!byDate[key]) byDate[key] = { count: 0, ongkir: 0, tambahan: 0, total: 0, ids: [] };
        byDate[key].count++;
        byDate[key].ongkir += Number(n.ongkir) || 0;
        const t = Array.isArray(n.tambahans) ? n.tambahans.reduce((s, x) => s + (Number(x.nominal) || 0), 0) : 0;
        byDate[key].tambahan += t;
        byDate[key].total += (Number(n.ongkir) || 0) + t; // Total di rekap hanya ongkir + tambahan
        byDate[key].ids.push(n.id || n._id || n.key);
      }
    });

    const tbody = el('rekapBody');
    tbody.innerHTML = '';
    let sumNota = 0, sumO = 0, sumT = 0, sumTot = 0;

    Object.keys(byDate).sort().forEach(k => {
      const v = byDate[k];
      const totalHarian = v.ongkir + v.tambahan;

      const tr = document.createElement('tr');
      const tdTanggal = document.createElement('td');
      tdTanggal.innerText = new Date(k).toLocaleDateString('id-ID');
      tdTanggal.style.cursor = 'pointer';
      tdTanggal.title = 'Klik untuk ubah tanggal (fitur admin)'; // Note: this feature is for admin panel
      tr.appendChild(tdTanggal);
      tr.innerHTML += `
        <td>${v.count}</td>
        <td>${v.ongkir.toLocaleString('id-ID')}</td>
        <td>${v.tambahan.toLocaleString('id-ID')}</td>
        <td>${totalHarian.toLocaleString('id-ID')}</td>
      `;
      tbody.appendChild(tr);

      sumNota += v.count;
      sumO += v.ongkir;
      sumT += v.tambahan;
      sumTot += totalHarian;
    });

    el('sumNota').innerText = sumNota;
    el('sumOngkir').innerText = sumO.toLocaleString('id-ID');
    el('sumTambahan').innerText = sumT.toLocaleString('id-ID');
    el('sumTotal').innerText = sumTot.toLocaleString('id-ID');
  });

  // ====================================================================
  // Kurir Dashboard: Pelacak Tab
  // ====================================================================
  el('btnCariNota').addEventListener('click', async () => {
    const no = (el('trackNoNota').value || '').trim();
    const date = (el('trackDate').value || '').trim();
    const hasilEl = el('pelacakHasil');
    hasilEl.innerHTML = 'Mencari...';

    let html = '';
    let foundAny = false;

    if (no) {
      const s = await get(ref(db, `pelacakByNo/${no}`));
      if (s.exists()) {
        const arr = Object.entries(s.val()).map(([id, v]) => ({ id, ...v })).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
        const filteredArr = arr.filter(n => n.username === currentUser); // Filter by current user
        if (filteredArr.length > 0) {
          html += `<h4>Hasil No Nota ${no}</h4>`;
          filteredArr.forEach(n => {
            foundAny = true;
            html += `<div class="card" style="padding:10px">
              <div><b>${new Date(n.createdAt).toLocaleString('id-ID')}</b> — Kurir: ${n.username}</div>
              <div>Total: Rp ${(Number(n.total) || 0).toLocaleString('id-ID')}</div>
              <div class="btnbar" style="justify-content: flex-end;">
                <button class="btn secondary" onclick="viewNotaAdmin('${n.username}','${n.id}')">Lihat</button>
                <button class="btn danger" onclick="hapusNote('${n.id}')">Hapus</button>
              </div>
            </div>`;
          });
        }
      }
    }

    if (date) {
      const s2 = await get(ref(db, `pelacakByDate/${date}`));
      if (s2.exists()) {
        const arr2 = Object.entries(s2.val()).map(([id, v]) => ({ id, ...v })).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
        const filteredArr2 = arr2.filter(n => n.username === currentUser); // Filter by current user
        if (filteredArr2.length > 0) {
          html += `<h4>Hasil Tanggal ${new Date(date).toLocaleDateString('id-ID')}</h4>`;
          filteredArr2.forEach(n => {
            foundAny = true;
            html += `<div class="card" style="padding:10px">
              <div><b>${new Date(n.createdAt).toLocaleString('id-ID')}</b> — Kurir: ${n.username} — No: ${n.noNota || '-'}</div>
              <div>Total: Rp ${(Number(n.total) || 0).toLocaleString('id-ID')}</div>
              <div class="btnbar" style="justify-content: flex-end;">
                <button class="btn secondary" onclick="viewNotaAdmin('${n.username}','${n.id}')">Lihat</button>
                <button class="btn danger" onclick="hapusNote('${n.id}')">Hapus</button>
              </div>
            </div>`;
          });
        }
      }
    }

    if (!no && !date) { html = '<p class="small">Isi No Nota atau Tanggal untuk mencari.</p>'; }
    else if (!foundAny) { html = '<p class="small">Tidak ada catatan yang ditemukan untuk kriteria ini.</p>'; }
    hasilEl.innerHTML = html;
  });

  el('btnCariReset').addEventListener('click', () => {
    el('trackNoNota').value = '';
    el('trackDate').value = '';
    el('pelacakHasil').innerHTML = '';
  });

  // ====================================================================
  // Kurir Dashboard: Export / Share Image (Web)
  // ====================================================================
  function canvasToBlob(canvas, type = 'image/jpeg', quality = 0.9) {
    return new Promise(res => canvas.toBlob(b => res(b), type, quality));
  }

  async function getNotaBlob() {
    const node = el('notaPreview');
    if (!node.innerText.trim()) { buildNotaObject(); }
    const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#fff' });
    const blob = await canvasToBlob(canvas, 'image/jpeg', 0.9);
    return blob;
  }

  async function savePreviewAsImage() {
    try {
      const nota = buildNotaObject();
      const blob = await getNotaBlob();
      const filename = `${currentUser || 'User'}_nota_${nota.noNota}.jpg`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Foto nota diunduh. Cek folder Downloads/Galeri anda.', 'success');
    } catch (e) {
      console.error(e);
      showNotification('Gagal simpan foto nota', 'error');
    }
  }

  async function sharePreviewImage() {
    try {
      const nota = buildNotaObject();
      const blob = await getNotaBlob();
      const filename = `${currentUser || 'User'}_nota_${nota.noNota}.jpg`;
      const file = new File([blob], filename, { type: 'image/jpeg' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: 'Nota Sahabatku Delivery',
          text: `No Nota ${nota.noNota} — Kurir ${currentUser}`
        });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Browser tidak support share langsung. File sudah diunduh, silakan bagikan via WhatsApp dari Galeri/Downloads.', 'info');
      }
    } catch (e) {
      console.error(e);
      showNotification('Gagal share nota.', 'error');
    }
  }

  // ====================================================================
  // Kurir Dashboard: Cek Ongkir Module
  // ====================================================================
  const ongkirData = [
    { lokasi: "JATIBARANG", ongkir: 6000 }, { lokasi: "JATIBARANG BARU", ongkir: 6000 }, { lokasi: "GAJAH ASRI", ongkir: 7000 }, { lokasi: "PILANGSARI", ongkir: 7000 }, { lokasi: "BINTARA", ongkir: 7000 }, { lokasi: "GG PROYEK", ongkir: 8000 }, { lokasi: "JL PANTURA", ongkir: 9000 }, { lokasi: "BALDES PILANGSARI", ongkir: 10000 }, { lokasi: "POM BENSIN PANTURA", ongkir: 11000 }, { lokasi: "COMO", ongkir: 12000 }, { lokasi: "SUKALILA", ongkir: 13000 }, { lokasi: "SUKAWERA", ongkir: 13000 }, { lokasi: "KLIWED", ongkir: 14000 }, { lokasi: "JL. KERTASMAYA (TELADAN)", ongkir: 16000 }, { lokasi: "KERTASMAYA", ongkir: 18000 }, { lokasi: "TULUNGAGUNG", ongkir: 20000 }, { lokasi: "BINARIA", ongkir: 22000 }, { lokasi: "JL RAYA KERTASMAYA", ongkir: 25000 }, { lokasi: "CANDANGPINGGANG", ongkir: 32000 }, { lokasi: "TERSANA", ongkir: 26000 }, { lokasi: "JENGKOK", ongkir: 30000 }, { lokasi: "JAMBE", ongkir: 35000 }, { lokasi: "BTN SAPHIRE", ongkir: 7000 }, { lokasi: "KEBULEN", ongkir: 8000 }, { lokasi: "BANTARAGUNG", ongkir: 8000 }, { lokasi: "PAWIDEAN", ongkir: 9000 }, { lokasi: "JATISAWIT", ongkir: 10000 }, { lokasi: "JATISAWIT LOR", ongkir: 12000 }, { lokasi: "POM BENSIN JATISAWIT", ongkir: 13000 }, { lokasi: "KRASAK", ongkir: 14000 }, { lokasi: "KALIMATI", ongkir: 16000 }, { lokasi: "LOBENER", ongkir: 18000 }, { lokasi: "TELUKAGUNG", ongkir: 20000 }, { lokasi: "PLUMBON", ongkir: 25000 }, { lokasi: "DUKUH", ongkir: 28000 }, { lokasi: "PEKANDANGAN JAYA", ongkir: 32000 }, { lokasi: "PEKANDANGAN", ongkir: 35000 }, { lokasi: "SINDANG", ongkir: 40000 }, { lokasi: "INDRAMAYU", ongkir: 40000 }, { lokasi: "INDRAMAYU KOTA", ongkir: 45000 }, { lokasi: "KARANGSONG", ongkir: 50000 }, { lokasi: "WIDASARI", ongkir: 7000 }, { lokasi: "KONGSI", ongkir: 8000 }, { lokasi: "UJUNGARIS", ongkir: 9000 }, { lokasi: "UJUNG JAYA", ongkir: 10000 }, { lokasi: "RS MITRA", ongkir: 10000 }, { lokasi: "PONDOK SHIDIQ", ongkir: 11000 }, { lokasi: "UJUNG PENDOK", ongkir: 12000 }, { lokasi: "KESESIH", ongkir: 12000 }, { lokasi: "LEUWIGEDE", ongkir: 13000 }, { lokasi: "SLAUR", ongkir: 14000 }, { lokasi: "LEGOK SLAUR", ongkir: 16000 }, { lokasi: "JL LEGOK", ongkir: 18000 }, { lokasi: "BOJONG SLAWI", ongkir: 17000 }, { lokasi: "POLINDRA", ongkir: 18000 }, { lokasi: "LOHBENER", ongkir: 25000 }, { lokasi: "PAMAYAHAN", ongkir: 28000 }, { lokasi: "BANGKIR", ongkir: 32000 }, { lokasi: "RAMBATAN WETAN", ongkir: 33000 }, { lokasi: "PANYINDANGAN", ongkir: 35000 }, { lokasi: "TERUSAN SINDANG", ongkir: 40000 }, { lokasi: "CELENG", ongkir: 22000 }, { lokasi: "LARANGAN", ongkir: 26000 }, { lokasi: "LANGUT", ongkir: 28000 }, { lokasi: "KASMARAN", ongkir: 20000 }, { lokasi: "JL WARU - KASMARAN", ongkir: 24000 }, { lokasi: "WARU", ongkir: 28000 }, { lokasi: "JL LARANGAN - LELEA", ongkir: 30000 }, { lokasi: "LELEA", ongkir: 31000 }, { lokasi: "PASAR LELEA", ongkir: 31000 }, { lokasi: "TAMANSARI LELEA", ongkir: 33000 }, { lokasi: "PENGAUBAN", ongkir: 35000 }, { lokasi: "NUNUK", ongkir: 22000 }, { lokasi: "TUGU LELEA", ongkir: 37000 }, { lokasi: "JAMBAK", ongkir: 42000 }, { lokasi: "CIKEDUNG", ongkir: 45000 }, { lokasi: "TERISI", ongkir: 50000 }, { lokasi: "POLSEK/BTN LAMA", ongkir: 7000 }, { lokasi: "BTN LAMA", ongkir: 7000 }, { lokasi: "KECAMATAN", ongkir: 7000 }, { lokasi: "BULAK", ongkir: 8000 }, { lokasi: "SLEMAN", ongkir: 9000 }, { lokasi: "TAMBI", ongkir: 10000 }, { lokasi: "POM PERUM TAMBI", ongkir: 11000 }, { lokasi: "TOANG TAMBI", ongkir: 13000 }, { lokasi: "BLOK KASMARAN", ongkir: 16000 }, { lokasi: "JL MANGIR", ongkir: 20000 }, { lokasi: "MANGIR", ongkir: 23000 }, { lokasi: "POLSEK SLIYEG", ongkir: 20000 }, { lokasi: "SUDIKAMPIRAN", ongkir: 22000 }, { lokasi: "JAYALAKSANA", ongkir: 24000 }, { lokasi: "SEGERAN", ongkir: 34000 }, { lokasi: "MUNDU", ongkir: 36000 }, { lokasi: "JL RAYA KARANGAMPEL", ongkir: 40000 }, { lokasi: "KARANGAMPEL", ongkir: 45000 }, { lokasi: "MAJASARI", ongkir: 14000 }, { lokasi: "MAJASIH", ongkir: 15000 }, { lokasi: "JL MAJASIH - SLIYEG", ongkir: 18000 }, { lokasi: "SLIYEG", ongkir: 20000 }, { lokasi: "SLIYEG LOR", ongkir: 22000 }, { lokasi: "GADINGAN", ongkir: 24000 }, { lokasi: "TUGU SLIYEG", ongkir: 25000 }, { lokasi: "SUDIMAMPIR", ongkir: 30000 }, { lokasi: "CANGKINGAN", ongkir: 34000 }, { lokasi: "KEDOKANBUNDER", ongkir: 40000 }, { lokasi: "JUNTINYUAT", ongkir: 52000 }, { lokasi: "LIMBANGAN", ongkir: 56000 }, { lokasi: "BALONGAN", ongkir: 60000 }, { lokasi: "BABADAN", ongkir: 24000 }, { lokasi: "TENAJAR", ongkir: 26000 }, { lokasi: "BANGKALOA ILIR", ongkir: 8000 }, { lokasi: "GINCU", ongkir: 9000 }, { lokasi: "BANGKRONG", ongkir: 10000 }, { lokasi: "PESONA ASRI/SYIFA", ongkir: 10000 }, { lokasi: "CURUG TEGALGIRANG", ongkir: 12000 }, { lokasi: "TEGALGIRANG", ongkir: 13000 }, { lokasi: "KARANGGETAS", ongkir: 14000 }, { lokasi: "WANASARI", ongkir: 15000 }, { lokasi: "CANGKRUNG", ongkir: 16000 }, { lokasi: "TOANG LAJER", ongkir: 17000 }, { lokasi: "BOJONG MELATI", ongkir: 18000 }, { lokasi: "JL BOJONG MELATI", ongkir: 22000 }, { lokasi: "JL BANGODUA - SUKADANA", ongkir: 25000 }, { lokasi: "LAJER", ongkir: 18000 }, { lokasi: "JL LAJER - TUKDANA", ongkir: 20000 }, { lokasi: "TUKDANA", ongkir: 22000 }, { lokasi: "KARANGKERTA", ongkir: 25000 }, { lokasi: "KERTICALA", ongkir: 26000 }, { lokasi: "SUKADANA", ongkir: 25000 }, { lokasi: "SUKAPERNA", ongkir: 28000 }, { lokasi: "CANGKO", ongkir: 30000 }, { lokasi: "RANCAJAWAT", ongkir: 32000 }, { lokasi: "GADEL", ongkir: 34000 }, { lokasi: "BODAS", ongkir: 36000 }, { lokasi: "PERBATESAN MAJALENGKA", ongkir: 40000 }, { lokasi: "PERTIGAAN WIDASARI-CBG", ongkir: 7000 }, { lokasi: "KRANYAR CIBOGOR", ongkir: 8000 }, { lokasi: "TERUSAN CIBOGOR", ongkir: 9000 }, { lokasi: "CIBOGOR", ongkir: 10000 }, { lokasi: "BALDES WIDASARI", ongkir: 12000 }, { lokasi: "CIDENG", ongkir: 13000 }, { lokasi: "JIMPRET", ongkir: 16000 }, { lokasi: "JEMBATAN MAJU", ongkir: 18000 }, { lokasi: "KALENSARI", ongkir: 18000 }, { lokasi: "MALANGSARI", ongkir: 20000 }
  ];

  function findOngkirByName(input) {
    if (!input) return null;
    const q = input.trim().toLowerCase();
    if (!q) return null;
    let exact = ongkirData.find(x => x.lokasi.toLowerCase() === q);
    if (exact) return exact;
    let starts = ongkirData.find(x => x.lokasi.toLowerCase().startsWith(q));
    if (starts) return starts;
    let inc = ongkirData.find(x => x.lokasi.toLowerCase().includes(q));
    return inc || null;
  }

  function attachAutocomplete(inputEl, dropdownEl, dataList) {
    let items = [];
    let active = -1;

    function highlight(txt, query) {
      const i = txt.toLowerCase().indexOf(query.toLowerCase());
      if (i < 0) return txt;
      return txt.substring(0, i) + "<mark>" + txt.substring(i, i + query.length) + "</mark>" + txt.substring(i + query.length);
    }

    function render(list, query) {
      dropdownEl.innerHTML = "";
      list.slice(0, 12).forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 's-item';
        div.innerHTML = `
          <div class="s-icon"><i class="fa-solid fa-location-dot"></i></div>
          <div class="s-text">
            <div class="s-name">${highlight(it.lokasi, query)}</div>
            <div class="s-price">${money(it.ongkir)}</div>
          </div>
        `;
        div.addEventListener('click', () => {
          inputEl.value = it.lokasi;
          hide();
          hitungOngkir(); // Recalculate after selection
        });
        dropdownEl.appendChild(div);
      });
      dropdownEl.style.display = list.length ? 'block' : 'none';
      active = -1;
    }

    function hide() { dropdownEl.style.display = 'none'; }

    inputEl.addEventListener('input', () => {
      const q = inputEl.value.trim();
      if (q.length < 1) { hide(); return; }
      const list = dataList
        .filter(x => x.lokasi.toLowerCase().includes(q.toLowerCase()))
        .sort((a, b) => a.lokasi.localeCompare(b.lokasi));
      items = list;
      render(items, q);
    });

    inputEl.addEventListener('keydown', (e) => {
      const visible = dropdownEl.style.display === 'block';
      if (!visible) return;
      const count = dropdownEl.children.length;
      if (e.key === 'ArrowDown') { e.preventDefault(); active = (active + 1) % count; updateActive(); } else if (e.key === 'ArrowUp') { e.preventDefault(); active = (active + count - 1) % count; updateActive(); } else if (e.key === 'Enter') {
        if (active >= 0 && dropdownEl.children[active]) {
          e.preventDefault();
          dropdownEl.children[active].click();
        }
      } else if (e.key === 'Escape') { hide(); }
    });

    function updateActive() {
      [...dropdownEl.children].forEach((el, i) => {
        el.classList.toggle('active', i === active);
        if (i === active) el.scrollIntoView({ block: 'nearest' });
      });
    }

    document.addEventListener('click', (e) => {
      if (!dropdownEl.contains(e.target) && e.target !== inputEl) { hide(); }
    });

    return { hide };
  }

  const asalInput = el('asalInput');
  const tujuanInput = el('tujuanInput');
  const asalSuggest = el('asalSuggest');
  const tujuanSuggest = el('tujuanSuggest');
  const normalHarga = el('normalHarga');
  const normalKet = el('normalKeterangan');
  const ruteHarga = el('ruteHarga');
  const ruteKet = el('ruteKeterangan');
  const ruteFormula = el('ruteFormula');
  const ongkirResults = el('ongkirResults');

  const { hide: hideAsal } = attachAutocomplete(asalInput, asalSuggest, ongkirData);
  const { hide: hideTujuan } = attachAutocomplete(tujuanInput, tujuanSuggest, ongkirData);

  el('clearAsal').addEventListener('click', () => { asalInput.value = ''; hideAsal(); hitungOngkir(); });
  el('clearTujuan').addEventListener('click', () => { tujuanInput.value = ''; hideTujuan(); hitungOngkir(); });
  el('bersihkanBtn').addEventListener('click', () => {
    asalInput.value = '';
    tujuanInput.value = '';
    hideAsal();
    hideTujuan();
    ongkirResults.style.display = 'none';
    showNotification('Form ongkir dibersihkan.', 'info');
  });
  el('cekBtn').addEventListener('click', hitungOngkir);
  [asalInput, tujuanInput].forEach(input => {
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); hitungOngkir(); }
    });
  });

  function hitungOngkir() {
    const asalText = asalInput.value.trim();
    const tujuanText = tujuanInput.value.trim();

    const asalObj = asalText ? findOngkirByName(asalText) : null;
    const tujuanObj = tujuanText ? findOngkirByName(tujuanText) : null;

    if (!asalObj && !tujuanObj) {
      ongkirResults.style.display = 'none';
      showNotification('Masukkan minimal salah satu lokasi (Asal atau Tujuan) sesuai daftar.', 'warning');
      return;
    }
    if (asalText && !asalObj) { showNotification('Lokasi Asal tidak ditemukan di daftar.', 'error'); return; }
    if (tujuanText && !tujuanObj) { showNotification('Lokasi Tujuan tidak ditemukan di daftar.', 'error'); return; }

    let normalCalcObj = tujuanObj || asalObj;
    normalHarga.textContent = money(normalCalcObj.ongkir);
    normalKet.textContent = `Lokasi: ${normalCalcObj.lokasi}`;

    if (asalObj && tujuanObj) {
      const total = Math.max(0, (asalObj.ongkir + tujuanObj.ongkir) - 6000);
      ruteHarga.textContent = money(total);
      ruteKet.textContent = `Asal: ${asalObj.lokasi} (${money(asalObj.ongkir)}) • Tujuan: ${tujuanObj.lokasi} (${money(tujuanObj.ongkir)})`;
      ruteFormula.textContent = `${money(asalObj.ongkir)} + ${money(tujuanObj.ongkir)} − ${money(6000)} = ${money(total)}`;
      ruteFormula.style.display = 'inline-block';
    } else {
      ruteHarga.textContent = '—';
      ruteKet.textContent = 'Isi Asal & Tujuan untuk menghitung ongkir rute.';
      ruteFormula.style.display = 'none';
    }
    ongkirResults.style.display = 'grid';
  }

  // ====================================================================
  // Kurir Dashboard: Absensi Kurir Module
  // ====================================================================
  const MASTER_DOC = collection(firestoreDb, 'appdata'); // Menggunakan firestoreDb
  const JADWAL_COLLECTION = collection(firestoreDb, 'jadwal_off'); // Menggunakan firestoreDb
  const PENGAJUAN_COLLECTION = collection(firestoreDb, 'pengajuan_off'); // Menggunakan firestoreDb

  let kurirListAbsensi = ["Sonia", "Pitri", "Hambali", "Alfan", "Gilang", "Hafiz", "Kardi", "Robi", "Ulum", "Eblek", "Nandar"]; // Fallback
  let jadwalDataAbsensi = {};
  let isAbsensiAdmin = false; // Status admin absensi
  let unsubJadwalAbsensi = null;
  let pengajuanCacheAbsensi = [];
  const idDays = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

  const absensiMonthPick = el('monthPick');
  absensiMonthPick.value = new Date().toISOString().slice(0, 7);

  // Absensi UI elements (Kurir Dashboard)
  const absensiAdminBar = el('absensiAdminBar');
  const btnAbsensiTab = el('btn-absensi-tab');
  const btnApprovalTab = el('btn-approval-tab');

  // Absensi Admin Actions (Kurir Dashboard)
  const btnAddKurirAbsensi = el('btn-add');
  const btnDelKurirAbsensi = el('btn-del');
  const btnRegenAbsensi = el('btn-regen');
  const btnSaveAbsensi = el('btn-save');

  // Absensi Pengajuan Form (Kurir Dashboard)
  const pengajuanTanggal = el('pengajuanTanggal');
  const penggantiKurir = el('penggantiKurir');
  const tanggalTukar = el('tanggalTukar');
  const btnAjukan = el('btnAjukan');

  // Absensi Tabs (Kurir Dashboard)
  qsa('#absensiTopbar .btn[data-tab]').forEach(b => {
    b.onclick = () => {
      setActiveTab('absensiTopbar', b.dataset.tab);
    };
  });

  // Fungsi setAbsensiAdminUI akan dipanggil dari doAdminLogin/Logout
  function setAbsensiAdminUI(show) {
    // For Kurir Dashboard
    absensiAdminBar.style.display = show ? 'flex' : 'none'; // This bar is for admin actions within absensi module
    btnAbsensiTab.style.display = show ? '' : 'none'; // Absensi Harian tab
    btnApprovalTab.style.display = show ? '' : 'none'; // Approval Kurir tab
    // For Admin Dashboard
    el('tabAbsensiAdmin').classList.toggle('hidden', !show); // Show/hide the entire admin absensi tab
  }

  // Absensi Data & Renderers
  function generateFairOffForMonth(ym) {
    const [y, m] = ym.split('-').map(Number), year = y, month = m - 1;
    const days = new Date(year, month + 1, 0).getDate();
    const pool = kurirListAbsensi.slice();
    if (pool.length === 0) { jadwalDataAbsensi[ym] = []; return; }
    const counts = Object.fromEntries(pool.map(k => [k, 0]));
    const arr = [];
    for (let d = 1; d <= days; d++) {
      const minV = Math.min(...Object.values(counts));
      const cands = pool.filter(k => counts[k] === minV);
      const pick = cands[Math.floor(Math.random() * cands.length)];
      counts[pick] += 1;
      const dt = new Date(year, month, d);
      arr.push({ tanggal: `${year}-${leftPad(month + 1, 2)}-${leftPad(d, 2)}`, off: pick, pengganti: '' });
    }
    jadwalDataAbsensi[ym] = arr;
  }

  function renderJadwalAbsensi(ym, targetTableId = 'tableJadwal') {
    const tbody = document.querySelector(`#${targetTableId} tbody`);
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;

    jadwalDataAbsensi[ym].forEach(it => {
      const d = new Date(it.tanggal);
      const hari = idDays[d.getDay()];
      const tr = document.createElement('tr');

      const tdTanggal = document.createElement('td'); tdTanggal.textContent = it.tanggal;
      const tdHari = document.createElement('td'); tdHari.textContent = hari;

      const tdOff = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = it.off ? 'badge off' : 'badge on';
      badge.textContent = it.off || 'Semua On';
      badge.style.cursor = 'pointer';
      badge.title = 'Klik untuk mengajukan tukar off';
      badge.onclick = () => {
        if (targetTableId === 'tableJadwal') { // Only allow pengajuan from kurir dashboard
          pengajuanTanggal.value = it.tanggal;
          setupFormPengajuanAbsensi();
          showNotification('Tanggal dipilih. Silakan lengkapi form pengajuan.', 'info');
        }
      };
      tdOff.appendChild(badge);

      const tdPeng = document.createElement('td');
      tdPeng.textContent = it.pengganti || '—';

      if (isAbsensiAdmin) {
        badge.oncontextmenu = async (e) => {
          e.preventDefault();
          const nama = prompt('Set OFF hari ini untuk kurir (kosongkan untuk Semua On):', it.off || '');
          if (nama !== null) {
            const newOff = nama.trim();
            it.off = newOff;
            it.pengganti = '';
            await saveFirestoreJadwalAbsensi(ym);
            showNotification(`OFF diperbarui: ${it.tanggal}: ${it.off || 'Semua On'}`, 'success');
          }
        };
      }

      tr.append(tdTanggal, tdHari, tdOff, tdPeng);
      tbody.appendChild(tr);
    });
  }

  function renderAbsensi(ym, targetTableId = 'tableAbsensi') {
    const tbody = document.querySelector(`#${targetTableId} tbody`);
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;
    jadwalDataAbsensi[ym].forEach(it => {
      kurirListAbsensi.forEach(async k => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.tanggal}</td><td>${k}</td>`;
        let status = (k === it.off) ? 'Off' : 'On';
        const tdS = document.createElement('td');
        if (isAbsensiAdmin) {
          const btn = document.createElement('button');
          btn.className = 'btn-mini ' + (status === 'On' ? 'btn-on' : 'btn-off');
          btn.textContent = status;
          btn.onclick = async () => {
            const ymLocal = it.tanggal.slice(0, 7);
            const row = jadwalDataAbsensi[ymLocal].find(r => r.tanggal === it.tanggal);
            row.off = (status === 'On') ? k : '';
            row.pengganti = '';
            await saveFirestoreJadwalAbsensi(ymLocal);
            showNotification(`Status ${k} di ${it.tanggal} diubah menjadi ${row.off ? 'OFF' : 'ON'}`, 'info');
          };
          tdS.appendChild(btn);
        } else {
          const span = document.createElement('span');
          span.className = 'badge ' + (status === 'On' ? 'on' : 'off');
          span.textContent = status;
          tdS.appendChild(span);
        }
        tr.appendChild(tdS);
        tbody.appendChild(tr);
      });
    });
  }

  function renderRekapAbsensi(ym, targetTableId = 'tableRekap') {
    const tbody = document.querySelector(`#${targetTableId} tbody`);
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;
    const arr = jadwalDataAbsensi[ym];
    const sum = Object.fromEntries(kurirListAbsensi.map(k => [k, { on: 0, off: 0 }]));
    arr.forEach(it => { kurirListAbsensi.forEach(k => { if (k === it.off) sum[k].off++; else sum[k].on++; }); });
    kurirListAbsensi.forEach(k => {
      const { on, off } = sum[k];
      const total = on + off || 1;
      const skor = Math.round((on / total) * 100);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td>${on}</td><td>${off}</td><td>${skor}%</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderApprovalAbsensi(targetTableId = 'tableApproval') {
    const tbody = document.querySelector(`#${targetTableId} tbody`);
    tbody.innerHTML = '';
    pengajuanCacheAbsensi.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.tanggal}</td><td>${item.asal}</td><td>${item.pengganti}</td><td>${item.status}</td>`;
      if (item.status === 'Pending' && isAbsensiAdmin) {
        const tdA = document.createElement('td');

        const btnApprove = document.createElement('button');
        btnApprove.textContent = 'Approve';
        btnApprove.className = 'btn-mini btn-on';
        btnApprove.onclick = async () => {
          if (!confirm('Yakin ingin menyetujui pengajuan ini?')) return;
          const ym = item.tanggal.slice(0, 7);
          if (!jadwalDataAbsensi[ym]) return;
          const row = jadwalDataAbsensi[ym].find(it => it.tanggal === item.tanggal);
          const swapRow = jadwalDataAbsensi[ym].find(it => it.tanggal === item.tukarTanggal);
          if (row && swapRow) {
            const tmp = row.off;
            row.off = swapRow.off;
            swapRow.off = tmp;
            row.pengganti = '';
            swapRow.pengganti = '';
            await updateDoc(doc(PENGAJUAN_COLLECTION, item.id), { status: 'Approved', approvedBy: ABSENSI_ADMIN_UID });
            await saveFirestoreJadwalAbsensi(ym);
            showNotification('Approval berhasil: ' + item.tanggal + ' ↔ ' + item.tukarTanggal, 'success');
            updateAdminSummaryBoxes(); // Update summary boxes after approval
          }
        };
        tdA.appendChild(btnApprove);

        const btnReject = document.createElement('button');
        btnReject.textContent = 'Tolak';
        btnReject.className = 'btn-mini btn-off';
        btnReject.style.marginLeft = '6px';
        btnReject.onclick = async () => {
          if (!confirm('Yakin ingin MENOLAK pengajuan ini?')) return;
          await updateDoc(doc(PENGAJUAN_COLLECTION, item.id), { status: 'Rejected', rejectedBy: ABSENSI_ADMIN_UID });
          showNotification('Pengajuan ditolak: ' + item.tanggal, 'info');
          updateAdminSummaryBoxes(); // Update summary boxes after rejection
        };
        tdA.appendChild(btnReject);

        tr.appendChild(tdA);
      } else {
        tr.appendChild(document.createElement('td'));
      }
      tbody.appendChild(tr);
    });
  }

  function absensiQuickSync() {
    const ym = absensiMonthPick.value;
    renderJadwalAbsensi(ym, 'tableJadwal');
    renderAbsensi(ym, 'tableAbsensi');
    renderRekapAbsensi(ym, 'tableRekap');
    renderApprovalAbsensi('tableApproval');
  }

  function absensiAdminQuickSync() {
    const ym = el('monthPickAdmin').value;
    renderJadwalAbsensi(ym, 'tableJadwalAdmin');
    renderAbsensi(ym, 'tableAbsensiAdmin');
    renderRekapAbsensi(ym, 'tableRekapAdmin');
    renderApprovalAbsensi('tableApprovalAdmin');
  }

  function setupFormPengajuanAbsensi() {
    pengajuanTanggal.innerHTML = '';
    penggantiKurir.innerHTML = '';
    tanggalTukar.innerHTML = '';
    const ym = absensiMonthPick.value;

    if (!jadwalDataAbsensi[ym]) return;

    jadwalDataAbsensi[ym].forEach(it => {
      const opt = document.createElement('option');
      opt.value = it.tanggal;
      opt.textContent = it.tanggal + (it.off ? ` (Off: ${it.off})` : ' (Semua On)');
      pengajuanTanggal.appendChild(opt);
    });

    kurirListAbsensi.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = k;
      penggantiKurir.appendChild(opt);
    });

    function refreshTanggalTukar() {
      const kurir = penggantiKurir.value;
      tanggalTukar.innerHTML = '';
      jadwalDataAbsensi[ym].forEach(it => {
        if (it.off === kurir) {
          const opt = document.createElement('option');
          opt.value = it.tanggal;
          opt.textContent = it.tanggal;
          tanggalTukar.appendChild(opt);
        }
      });
      if (!tanggalTukar.children.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(Kurir ini tidak punya OFF di bulan ini)';
        tanggalTukar.appendChild(opt);
      }
    }

    pengajuanTanggal.onchange = refreshTanggalTukar;
    penggantiKurir.onchange = refreshTanggalTukar;
    refreshTanggalTukar();
  }

  // Absensi Firestore I/O
  async function saveFirestoreJadwalAbsensi(ym) {
    if (jadwalDataAbsensi[ym]) {
      await setDoc(doc(JADWAL_COLLECTION, ym), { data: jadwalDataAbsensi[ym] });
    }
  }

  async function saveKurirListAbsensi() {
    await setDoc(doc(MASTER_DOC, 'master'), { kurirList: kurirListAbsensi, updated: new Date().toISOString() });
  }

  // Absensi Realtime Listeners
  function listenMasterKurirAbsensi() {
    onSnapshot(doc(MASTER_DOC, 'master'), docSnap => {
      if (docSnap.exists()) {
        kurirListAbsensi = Array.isArray(docSnap.data().kurirList) ? docSnap.data().kurirList : [];
        absensiQuickSync();
        absensiAdminQuickSync(); // Also update admin view
        setupFormPengajuanAbsensi();
      } else {
        absensiQuickSync();
        absensiAdminQuickSync(); // Also update admin view
        setupFormPengajuanAbsensi();
      }
    });
  }

  function listenJadwalAbsensi(ym) {
    if (unsubJadwalAbsensi) { unsubJadwalAbsensi(); unsubJadwalAbsensi = null; }
    unsubJadwalAbsensi = onSnapshot(doc(JADWAL_COLLECTION, ym), async docSnap => {
      if (docSnap.exists()) {
        jadwalDataAbsensi[ym] = docSnap.data().data || [];
        absensiQuickSync();
        absensiAdminQuickSync(); // Also update admin view
        setupFormPengajuanAbsensi();
      } else {
        generateFairOffForMonth(ym);
        await setDoc(doc(JADWAL_COLLECTION, ym), { data: jadwalDataAbsensi[ym] }); // Menggunakan setDoc untuk membuat dokumen jika belum ada
        showNotification('Jadwal dibuat untuk ' + ym, 'success');
      }
    });
  }

  function listenPengajuanAbsensi() {
    onSnapshot(query(PENGAJUAN_COLLECTION, orderBy('created', 'desc')), snap => {
      pengajuanCacheAbsensi = [];
      snap.forEach(doc => {
        const d = doc.data();
        pengajuanCacheAbsensi.push({ id: doc.id, ...d });
      });
      renderApprovalAbsensi('tableApproval'); // Kurir dashboard
      renderApprovalAbsensi('tableApprovalAdmin'); // Admin dashboard
      updateAdminSummaryBoxes(); // Update summary boxes when pengajuan changes
    });
  }

  // Absensi Admin Actions (Kurir Dashboard)
  btnAddKurirAbsensi.addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const nama = prompt('Nama Kurir baru:');
    if (nama) { kurirListAbsensi.push(nama.trim()); await saveKurirListAbsensi(); showNotification('Kurir ditambahkan: ' + nama, 'success'); }
  });
  btnDelKurirAbsensi.addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const nama = prompt('Hapus kurir (ketik persis):');
    const idx = kurirListAbsensi.indexOf(nama);
    if (idx > -1) { kurirListAbsensi.splice(idx, 1); await saveKurirListAbsensi(); showNotification('Kurir dihapus: ' + nama, 'info'); }
  });
  btnRegenAbsensi.addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const ym = absensiMonthPick.value;
    if (!ym) { showNotification('Pilih bulan.', 'warning'); return; }
    generateFairOffForMonth(ym);
    await saveFirestoreJadwalAbsensi(ym);
    showNotification('Regenerasi selesai untuk ' + ym, 'success');
  });
  btnSaveAbsensi.addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    try {
      await saveKurirListAbsensi();
      const ym = absensiMonthPick.value;
      if (jadwalDataAbsensi[ym]) await saveFirestoreJadwalAbsensi(ym);
      showNotification('Data absensi disimpan di Firestore.', 'success');
    } catch (e) { showNotification('Gagal save absensi: ' + e.message, 'error'); }
  });

  // Absensi Pengajuan (Kurir Dashboard)
  btnAjukan.addEventListener('click', async () => {
    const tanggal = pengajuanTanggal.value;
    const pengganti = penggantiKurir.value;
    const tukarTanggal = tanggalTukar.value;
    if (!tanggal || !pengganti || !tukarTanggal) { showNotification('Pilih tanggal, kurir pengganti & tanggal tukar.', 'warning'); return; }

    const ym = tanggal.slice(0, 7);
    const row = (jadwalDataAbsensi[ym] || []).find(it => it.tanggal === tanggal);
    if (!row || !row.off) { showNotification('Tidak ada kurir off pada tanggal ini.', 'warning'); return; }

    try {
      await setDoc(doc(PENGAJUAN_COLLECTION, { id: Date.now().toString() }), { // Generate unique ID for new doc
        tanggal,
        tukarTanggal,
        asal: row.off,
        pengganti,
        status: 'Pending',
        created: new Date().toISOString(), // Firestore.FieldValue.serverTimestamp()
        uid: auth.currentUser ? auth.currentUser.uid : null, // Menggunakan auth dari satu instance
        email: auth.currentUser ? auth.currentUser.email : null // Menggunakan auth dari satu instance
      });
      showNotification('Pengajuan terkirim. Tunggu approval admin.', 'info');
    } catch (e) { showNotification('Gagal mengirim pengajuan: ' + e.message, 'error'); }
  });

  // Absensi Init (Kurir Dashboard)
  absensiMonthPick.addEventListener('change', () => listenJadwalAbsensi(absensiMonthPick.value));

  // ====================================================================
  // Admin Dashboard
  // ====================================================================
  let allDataAdmin = {}; // {kurir:{id:nota}}
  let kurirSetAdmin = new Set();
  let kurirDataAdmin = {}; // To store full kurir objects including passwords
  let ongkirDataAdmin = {};
  let editingNotaAdmin = null; // {user,id,createdAt}
  let currentNotaPreviewText = ''; // To store the text for copy button

  // Admin Tabs
  qsa('#adminDashboard .tabs button').forEach(b => b.addEventListener('click', () => {
    setActiveTab('adminDashboard .tabs', b.dataset.tab);
  }));

  // Admin Absensi Tabs (within Admin Dashboard)
  qsa('#tabAbsensiAdmin .topbar button[data-tab]').forEach(b => {
    b.onclick = () => {
      setActiveTab('absensiTopbarAdmin', b.dataset.tab);
    };
  });

  // Admin Absensi Month Picker
  el('monthPickAdmin').addEventListener('change', () => absensiAdminQuickSync());

  // Admin Absensi Admin Bar Actions
  el('btn-add-admin').addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const nama = prompt('Nama Kurir baru:');
    if (nama) { kurirListAbsensi.push(nama.trim()); await saveKurirListAbsensi(); showNotification('Kurir ditambahkan: ' + nama, 'success'); absensiAdminQuickSync(); }
  });
  el('btn-del-admin').addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const nama = prompt('Hapus kurir (ketik persis):');
    const idx = kurirListAbsensi.indexOf(nama);
    if (idx > -1) { kurirListAbsensi.splice(idx, 1); await saveKurirListAbsensi(); showNotification('Kurir dihapus: ' + nama, 'info'); absensiAdminQuickSync(); }
  });
  el('btn-regen-admin').addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    const ym = el('monthPickAdmin').value;
    if (!ym) { showNotification('Pilih bulan.', 'warning'); return; }
    generateFairOffForMonth(ym);
    await saveFirestoreJadwalAbsensi(ym);
    showNotification('Regenerasi selesai untuk ' + ym, 'success');
    absensiAdminQuickSync();
  });
  el('btn-save-admin').addEventListener('click', async () => {
    if (!isAbsensiAdmin) { showNotification('Admin saja.', 'error'); return; }
    try {
      await saveKurirListAbsensi();
      const ym = el('monthPickAdmin').value;
      if (jadwalDataAbsensi[ym]) await saveFirestoreJadwalAbsensi(ym);
      showNotification('Data absensi disimpan di Firestore.', 'success');
    } catch (e) { showNotification('Gagal save absensi: ' + e.message, 'error'); }
  });


  async function loadAllAdminData() {
    await Promise.all([loadNotaAdmin(), loadKurirAdmin(), setupOngkirRealtimeAdmin()]);
    buildNoNotaDatalistAdmin();
    renderListAdmin(allDataAdmin);
    fillRekapKurirAdmin();
    updateAdminSummaryBoxes();
  }

  // Function to update the summary boxes
  function updateAdminSummaryBoxes() {
    let totalNotas = 0;
    let totalRevenue = 0;
    Object.values(allDataAdmin).forEach(notes => {
      Object.values(notes).forEach(n => {
        totalNotas++;
        const tambahanNominal = n.tambahans ? Object.values(n.tambahans).reduce((s2, t) => s2 + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0);
        totalRevenue += (Number(n.ongkir) || 0) + tambahanNominal;
      });
    });

    el('totalNotasAdmin').innerText = totalNotas;
    el('totalKurirAdmin').innerText = kurirSetAdmin.size;
    el('totalRevenueAdmin').innerText = money(totalRevenue);
    el('pendingApprovalsAdmin').innerText = pengajuanCacheAbsensi.filter(p => p.status === 'Pending').length;
  }

  // ====================================================================
  // Admin Dashboard: Loaders
  // ====================================================================
  async function loadNotaAdmin() {
    const snap = await get(ref(db, 'nota'));
    allDataAdmin = snap.exists() ? snap.val() : {};
    Object.keys(allDataAdmin).forEach(k => kurirSetAdmin.add(k));
    fillKurirFilterAdmin();
  }

  async function loadKurirAdmin() {
    const snap = await get(ref(db, 'kurir'));
    if (snap.exists()) {
      kurirDataAdmin = snap.val(); // Store full kurir data
      Object.keys(kurirDataAdmin).forEach(k => kurirSetAdmin.add(k));
    }
    fillKurirFilterAdmin();
    fillKurirManageAdmin();
    fillKurirDatalistAdmin();
    renderKurirPasswordsTable(); // Render the password table
  }

  // ====================================================================
  // Admin Dashboard: Kelola Nota
  // ====================================================================
  function fillKurirFilterAdmin() {
    const sel = el('filterKurir');
    sel.innerHTML = '<option value="">— Semua Kurir —</option>' + [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  function fillKurirManageAdmin() {
    el('kurirManage').innerHTML = [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  function fillKurirDatalistAdmin() {
    el('listKurir').innerHTML = [...kurirSetAdmin].sort().map(k => `<option value="${k}">`).join('');
  }

  function buildNoNotaDatalistAdmin() {
    const list = el('listNoNota');
    list.innerHTML = '';
    Object.values(allDataAdmin).forEach(notes => {
      Object.values(notes).forEach(n => {
        if (n.noNota) { const opt = document.createElement('option'); opt.value = n.noNota; list.appendChild(opt); }
      });
    });
  }

  function withinFiltersAdmin(n) {
    const fK = el('filterKurir').value;
    const fD = el('filterTanggal').value; // YYYY-MM-DD
    const fM = el('filterBulan').value; // YYYY-MM
    const fY = el('filterTahun').value; // YYYY

    if (fK && n.kurir !== fK) return false;
    if (fD && (n.createdAt || '').slice(0, 10) !== fD) return false;
    if (fM && (n.createdAt || '').slice(0, 7) !== fM) return false;
    if (fY && (n.createdAt || '').slice(0, 4) !== fY) return false;
    return true;
  }

  window.applyFilter = () => {
    const cariNota = el('filterCariNota').value.trim();
    if (cariNota) {
      const res = {};
      Object.entries(allDataAdmin).forEach(([k, notes]) => {
        Object.values(notes).forEach(n => {
          if ((n.noNota || '') === cariNota) {
            if (!res[k]) res[k] = {};
            res[k][n.id] = n;
          }
        });
      });
      renderListAdmin(res);
      return;
    }
    const res = {};
    Object.entries(allDataAdmin).forEach(([k, notes]) => {
      Object.values(notes).forEach(n => {
        if (withinFiltersAdmin(n)) {
          if (!res[k]) res[k] = {};
          res[k][n.id] = n;
        }
      });
    });
    renderListAdmin(res);
  };

  window.clearFilter = () => {
    el('filterKurir').value = '';
    el('filterTanggal').value = '';
    el('filterBulan').value = '';
    el('filterTahun').value = '';
    el('filterCariNota').value = '';
    renderListAdmin(allDataAdmin);
  };

  function renderListAdmin(data) {
    const wrap = el('notaList');
    wrap.innerHTML = '';
    if (!Object.keys(data || {}).length) { wrap.innerHTML = '<i>Tidak ada data</i>'; return; }
    Object.entries(data).forEach(([user, notes]) => {
      const card = document.createElement('div');
      card.className = 'card';
      const totalUser = Object.values(notes || {}).reduce((s, n) => {
        const tambahanNominal = n.tambahans ? Object.values(n.tambahans).reduce((s2, t) => s2 + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0);
        return s + (Number(n.ongkir) || 0) + tambahanNominal;
      }, 0);

      card.innerHTML = `<h3>Kurir: ${user} — Total: Rp ${money(totalUser)}</h3>`;
      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr><th>No Nota</th><th>Tanggal</th><th>Ongkir</th><th>Tambahan</th><th>Total</th><th>Aksi</th></tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      Object.values(notes || {}).sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || '')).forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.noNota || ''}</td>
                        <td>${n.createdAt ? new Date(n.createdAt).toLocaleString('id-ID') : '-'}</td>
                        <td>Rp ${money(n.ongkir || 0)}</td>
                        <td>Rp ${money(n.tambahans ? Object.values(n.tambahans).reduce((s, t) => s + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0))}</td>
                        <td><b>Rp ${money(
                          (Number(n.ongkir) || 0) + (
                            n.tambahans
                              ? Object.values(n.tambahans).reduce((s, t) => s + (Number(t.nominal) || 0), 0)
                              : (Number(n.tambahan) || 0)
                          )
                        )}</b></td>
                        <td class="flex">
                          <button class="btn secondary" onclick="viewNotaAdmin('${user}','${n.id}')">👁 Lihat</button>
                          <button class="btn" onclick="editNotaAdmin('${user}','${n.id}')">✏️ Edit</button>
                          <button class="btn danger" onclick="delNotaAdmin('${user}','${n.id}')">🗑 Hapus</button>
                        </td>`;
        tb.appendChild(tr);
      });
      card.appendChild(tbl);
      wrap.appendChild(card);
    });
  }

  window.showAddForm = () => {
    editingNotaAdmin = null;
    el('formTitle').innerText = 'Tambah Nota';
    el('formKurir').value = '';
    el('formNoNota').value = '';
    el('formOngkir').value = 0;
    el('formTambahan').value = 0;
    el('formText').value = '';
    qs('#itemTable tbody').innerHTML = '';
    addItemRowAdmin();
    el('formTotal').innerText = '0';
    el('notaForm').classList.remove('hidden');
    fillKurirDatalistAdmin();
  };

  window.cancelNota = () => el('notaForm').classList.add('hidden');

  function addItemRowAdmin(nama = '', qty = 1, harga = 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="iname" value="${nama}"></td>
                    <td><input class="iqty" type="number" value="${qty}"></td>
                    <td><input class="iprice" type="number" value="${harga}"></td>
                    <td><button class="btn danger" onclick="this.closest('tr').remove();calcTotalAdmin()">✖</button></td>`;
    qs('#itemTable tbody').appendChild(tr);
    tr.querySelectorAll('input').forEach(i => i.addEventListener('input', calcTotalAdmin));
    calcTotalAdmin();
  }

  window.addItemRow = addItemRowAdmin;

  function calcTotalAdmin() {
    let total = 0;
    qsa('#itemTable tbody tr').forEach(tr => {
      const q = Number(tr.querySelector('.iqty').value) || 0;
      const h = Number(tr.querySelector('.iprice').value) || 0;
      total += q * h;
    });
    total += Number(el('formOngkir').value || 0);
    total += Number(el('formTambahan').value || 0);
    el('formTotal').innerText = money(total);
  }
  el('formOngkir').addEventListener('input', calcTotalAdmin);
  el('formTambahan').addEventListener('input', calcTotalAdmin);

  window.saveNota = async () => {
    const user = el('formKurir').value.trim();
    if (!user) return showNotification('Isi nama kurir', 'warning');
    const noNota = el('formNoNota').value.trim() || ('NN-' + Date.now().toString().slice(-6));
    const items = qsa('#itemTable tbody tr').map(tr => ({
      nama: tr.querySelector('.iname').value,
      qty: Number(tr.querySelector('.iqty').value) || 0,
      harga: Number(tr.querySelector('.iprice').value) || 0,
    }));
    const ongkir = Number(el('formOngkir').value) || 0;
    const tambahanNominal = Number(el('formTambahan').value) || 0;
    const tambahans = tambahanNominal > 0 ? [{ nominal: tambahanNominal, type: "Tambahan Manual" }] : [];
    const text = el('formText').value || '';
    const total = items.reduce((s, it) => s + it.qty * it.harga, 0) + ongkir + tambahans.reduce((s, t) => s + (Number(t.nominal) || 0), 0);
    let id, createdAt;
    if (editingNotaAdmin) { id = editingNotaAdmin.id; createdAt = editingNotaAdmin.createdAt; } else { id = 'nota_' + Date.now(); createdAt = new Date().toISOString(); }

    const data = { id, kurir: user, noNota, createdAt, items, ongkir, tambahans, total, text };
    try {
      await set(ref(db, `nota/${user}/${id}`), data);
      await set(ref(db, `kurir/${user}`), { username: user, enabled: true, password: 'default_password' }); // Ensure kurir exists
      kurirSetAdmin.add(user);
      await loadNotaAdmin();
      buildNoNotaDatalistAdmin();
      renderListAdmin(allDataAdmin);
      el('notaForm').classList.add('hidden');
      showNotification('Nota disimpan.', 'success');
      updateAdminSummaryBoxes(); // Update summary boxes after saving nota
    } catch (error) {
      console.error("Error saving nota admin:", error);
      showNotification('Gagal menyimpan nota: ' + error.message, 'error');
    }
  };

  window.editNotaAdmin = async (user, id) => {
    const snap = await get(ref(db, `nota/${user}/${id}`));
    if (!snap.exists()) return showNotification('Nota tidak ditemukan', 'error');
    const n = snap.val();
    editingNotaAdmin = { id, createdAt: n.createdAt };
    el('formTitle').innerText = 'Edit Nota';
    el('formKurir').value = user;
    el('formNoNota').value = n.noNota || '';
    el('formOngkir').value = n.ongkir || 0;
    el('formTambahan').value = n.tambahans && n.tambahans.length > 0 ? n.tambahans[0].nominal : (n.tambahan || 0); // Simplified for single manual tambahan
    el('formText').value = n.text || '';
    qs('#itemTable tbody').innerHTML = '';
    (n.items || []).forEach(it => addItemRowAdmin(it.nama, it.qty, it.harga));
    el('notaForm').classList.remove('hidden');
    calcTotalAdmin();
  };

  window.delNotaAdmin = async (user, id) => {
    if (!confirm('Hapus nota ini?')) return;
    try {
      const notaRef = ref(db, `nota/${user}/${id}`);
      const notaSnap = await get(notaRef);
      const notaData = notaSnap.val();

      await remove(notaRef);
      if (notaData && notaData.noNota) {
        await remove(ref(db, `pelacakByNo/${notaData.noNota}/${id}`));
        const keyDate = notaData.createdAt.slice(0, 10);
        await remove(ref(db, `pelacakByDate/${keyDate}/${id}`));
      }
      await loadNotaAdmin();
      renderListAdmin(allDataAdmin);
      showNotification('Nota dihapus.', 'info');
      updateAdminSummaryBoxes(); // Update summary boxes after deleting nota
    } catch (error) {
      console.error("Error deleting nota admin:", error);
      showNotification('Gagal menghapus nota: ' + error.message, 'error');
    }
  };

  window.viewNotaAdmin = async (user, id) => {
    const snap = await get(ref(db, `nota/${user}/${id}`));
    if (!snap.exists()) { showNotification('Nota tidak ditemukan', 'error'); return; }
    const n = snap.val();

    // Build the nota text for preview and copy
    const lines = [];
    lines.push('🧾 NOTA SAHABATKU DELIVERY');
    lines.push('==========================');
    lines.push(`Kurir  : ${n.kurir}`);
    lines.push(`No     : ${n.noNota}`);
    lines.push(`Tanggal: ${new Date(n.createdAt).toLocaleString('id-ID')}`);
    if (n.custPhone) lines.push(`WA     : ${n.custPhone}`);
    lines.push('--------------------------');
    if (n.items.length === 0) {
      lines.push('Tidak ada item.');
    } else {
      n.items.forEach((it, i) => lines.push(`${i + 1}. ${it.name} (${it.qty} x Rp ${it.price.toLocaleString('id-ID')}) = Rp ${it.subtotal.toLocaleString('id-ID')}`));
    }
    lines.push('--------------------------');
    lines.push(`Ongkir   : Rp ${Number(n.ongkir).toLocaleString('id-ID')}`);
    if (n.tambahans && n.tambahans.length > 0) {
      n.tambahans.forEach(t => lines.push(`${t.type}: Rp ${Number(t.nominal).toLocaleString('id-ID')}`));
    } else if (n.tambahan) { // Fallback for old 'tambahan' field if it exists
      lines.push(`Tambahan: Rp ${Number(n.tambahan).toLocaleString('id-ID')}`);
    }
    lines.push(`TOTAL    : Rp ${Number(n.total).toLocaleString('id-ID')}`);
    lines.push('');
    lines.push('Terima kasih sudah menggunakan Sahabatku Delivery 🙏');

    currentNotaPreviewText = lines.join('\n');

    // Display in overlay
    const notaPreviewDiv = document.createElement('pre');
    notaPreviewDiv.style.fontFamily = 'Courier New, Courier, monospace';
    notaPreviewDiv.style.whiteSpace = 'pre-wrap';
    notaPreviewDiv.style.padding = '10px';
    notaPreviewDiv.style.border = '1px solid #eee';
    notaPreviewDiv.style.borderRadius = '8px';
    notaPreviewDiv.textContent = currentNotaPreviewText;

    const overlayContent = el('notaPhotoOverlay').querySelector('.overlay-content');
    const existingPreview = overlayContent.querySelector('pre');
    if (existingPreview) {
      existingPreview.remove();
    }
    overlayContent.insertBefore(notaPreviewDiv, el('notaPhotoImage')); // Insert before image

    // Hide image for text preview
    el('notaPhotoImage').style.display = 'none';

    // Show overlay
    el('notaPhotoOverlay').classList.add('show');
  };

  // Event listener for Save Foto button in overlay
  el('saveNotaPhotoBtn').addEventListener('click', async () => {
    try {
      const node = el('notaPhotoOverlay').querySelector('pre'); // Target the pre element
      if (!node) {
        showNotification('Tidak ada nota untuk disimpan.', 'warning');
        return;
      }
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#fff', logging: false });
      const blob = await canvasToBlob(canvas, 'image/jpeg', 0.9);
      const filename = `nota_preview_${Date.now()}.jpg`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Foto nota diunduh.', 'success');
    } catch (e) {
      console.error("Error saving nota photo from admin view:", e);
      showNotification('Gagal menyimpan foto nota.', 'error');
    }
  });

  // Event listener for Copy Text button in overlay
  el('copyNotaTextBtn').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(currentNotaPreviewText);
      showNotification('Teks nota berhasil disalin!', 'success');
    } catch (err) {
      console.error('Gagal menyalin teks: ', err);
      showNotification('Gagal menyalin teks.', 'error');
    }
  });

  // Close overlay button
  el('closePhotoOverlay').addEventListener('click', () => {
    el('notaPhotoOverlay').classList.remove('show');
    // Clean up the dynamically added pre element
    const overlayContent = el('notaPhotoOverlay').querySelector('.overlay-content');
    const existingPreview = overlayContent.querySelector('pre');
    if (existingPreview) {
      existingPreview.remove();
    }
    el('notaPhotoImage').style.display = 'block'; // Show image again for next use
  });


  window.exportCSV = () => {
    const rows = [["Kurir", "No Nota", "Tanggal", "Ongkir", "Tambahan", "Total"]];
    const cards = qsa('#notaList .card');
    cards.forEach(card => {
      const title = card.querySelector('h3')?.innerText || '';
      const user = title.replace(/^Kurir:\s*/, '').split(' — ')[0];
      card.querySelectorAll('tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        rows.push([user, tds[0].innerText, tds[1].innerText, tds[2].innerText.replace('Rp ', '').replaceAll('.', ''), tds[3].innerText.replace('Rp ', '').replaceAll('.', ''), tds[4].innerText.replace('Rp ', '').replaceAll('.', '')]);
      });
    });
    downloadCSV(rows, 'nota_filtered.csv');
  };

  // ====================================================================
  // Admin Dashboard: Rekap & Riwayat
  // ====================================================================
  function fillRekapKurirAdmin() {
    const sel = el('rekapKurirAdmin');
    sel.innerHTML = '<option value="">— Semua Kurir —</option>' + [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  window.renderRekapAdmin = async () => {
    const k = el('rekapKurirAdmin').value;
    const m = el('rekapBulanAdmin').value; // YYYY-MM

    let rows = [];
    let total = 0;
    let count = 0;
    let totOngkir = 0;
    let totTambahan = 0;

    const push = (n) => {
      const dt = n.createdAt ? new Date(n.createdAt).toLocaleDateString('id-ID') : '-';
      const tambahanSum = n.tambahans ? Object.values(n.tambahans).reduce((s2, t) => s2 + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0);
      const totalNota = (Number(n.ongkir) || 0) + tambahanSum;

      rows.push([dt, n.noNota || '', n.ongkir || 0, tambahanSum, totalNota]);
      count++;
      total += totalNota;
      totOngkir += (Number(n.ongkir) || 0);
      totTambahan += tambahanSum;
    };

    if (k) {
      const notes = allDataAdmin[k] || {};
      Object.values(notes).forEach(n => {
        if (m) { if ((n.createdAt || '').slice(0, 7) !== m) return; }
        push(n);
      });
    } else {
      Object.values(allDataAdmin).forEach(notes => {
        Object.values(notes).forEach(n => {
          if (m) { if ((n.createdAt || '').slice(0, 7) !== m) return; }
          push(n);
        });
      });
    }

    el('rekapRingkasAdmin').innerHTML = `<div class="card">
      <b>Jumlah Nota:</b> ${count} &nbsp; | &nbsp; <b>Total Ongkir:</b> Rp ${money(totOngkir)}
      &nbsp; | &nbsp; <b>Total Tambahan:</b> Rp ${money(totTambahan)} &nbsp; | &nbsp; <b>Total Penghasilan:</b> Rp ${money(total)}
    </div>`;

    const thead = '<thead><tr><th>Tanggal</th><th>No Nota</th><th>Ongkir</th><th>Tambahan</th><th>Total</th></tr></thead>';
    const tbody = '<tbody>' + rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>Rp ${money(r[2])}</td><td>Rp ${money(r[3])}</td><td><b>Rp ${money(r[4])}</b></td></tr>`).join('') + '</tbody>';
    el('rekapTabelAdmin').innerHTML = `<table>${thead}${tbody}</table>`;
  };

  window.exportCSVRekapAdmin = () => {
    const rows = [["Tanggal", "No Nota", "Ongkir", "Tambahan", "Total"]];
    el('rekapTabelAdmin').querySelectorAll('tbody tr').forEach(tr => {
      const t = tr.querySelectorAll('td');
      rows.push([t[0].innerText, t[1].innerText, t[2].innerText.replace('Rp ', '').replaceAll('.', ''), t[3].innerText.replace('Rp ', '').replaceAll('.', ''), t[4].innerText.replace('Rp ', '').replaceAll('.', '')]);
    });
    downloadCSV(rows, 'rekap.csv');
  };

  // ====================================================================
  // Admin Dashboard: Manajemen Kurir
  // ====================================================================
  window.tambahKurirAdmin = async () => {
    const uname = el('kurirBaru').value.trim();
    const pass = el('kurirPass').value.trim();
    if (!uname || pass.length < 4) return showNotification('Isi username & password minimal 4 karakter', 'warning');

    try {
      await set(ref(db, 'kurir/' + uname), {
        username: uname,
        password: pass,
        enabled: true,
        createdAt: new Date().toISOString()
      });
      kurirSetAdmin.add(uname);
      await loadKurirAdmin(); // Reload kurir data to update table
      showNotification('Kurir ditambahkan.', 'success');
      el('kurirBaru').value = '';
      el('kurirPass').value = '';
      updateAdminSummaryBoxes(); // Update summary boxes after adding kurir
    } catch (error) {
      console.error("Error adding kurir:", error);
      showNotification('Gagal menambah kurir: ' + error.message, 'error');
    }
  };

  window.hapusKurirAdmin = async () => {
    const uname = el('kurirManage').value;
    if (!uname) return;
    if (!confirm(`Hapus kurir "${uname}"?`)) return;

    try {
      await remove(ref(db, 'kurir/' + uname));
      kurirSetAdmin.delete(uname);
      await loadKurirAdmin(); // Reload kurir data to update table
      showNotification('Kurir dihapus.', 'info');
      updateAdminSummaryBoxes(); // Update summary boxes after deleting kurir
    } catch (error) {
      console.error("Error deleting kurir:", error);
      showNotification('Gagal menghapus kurir: ' + error.message, 'error');
    }
  };

  window.ubahPasswordKurirAdmin = async () => {
    const uname = el('kurirManage').value;
    if (!uname) return showNotification('Pilih kurir dulu.', 'warning');
    const newPass = prompt(`Masukkan password baru untuk ${uname}:`, "");
    if (!newPass || newPass.length < 4) return showNotification('Password baru minimal 4 karakter.', 'warning');

    try {
      await update(ref(db, 'kurir/' + uname), { password: newPass });
      await loadKurirAdmin(); // Reload kurir data to update table
      showNotification('Password berhasil diubah.', 'success');
    } catch (error) {
      console.error("Error changing password:", error);
      showNotification('Gagal mengubah password: ' + error.message, 'error');
    }
  };

  function renderKurirPasswordsTable() {
    const tbody = el('tableKurirPasswords').querySelector('tbody');
    tbody.innerHTML = '';

    const kurirNames = Object.keys(kurirDataAdmin).sort();
    if (kurirNames.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Tidak ada data kurir.</td></tr>';
      return;
    }

    kurirNames.forEach(name => {
      const kurir = kurirDataAdmin[name];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${kurir.username}</td>
        <td>${kurir.password || 'N/A'}</td>
        <td>${kurir.enabled ? 'Aktif' : 'Nonaktif'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ====================================================================
  // Admin Dashboard: Manajemen Ongkir
  // ====================================================================
  let ongkirDataAdminRealtime = {}; // Data ongkir dari Realtime DB

  function setupOngkirRealtimeAdmin() {
    const ongkirRef = ref(db, 'daftar_ongkir');
    onValue(ongkirRef, (snap) => {
      ongkirDataAdminRealtime = snap.exists() ? snap.val() : {};
      renderOngkirAdmin();
      fillWilayahDatalistAdmin();
    });
  }

  function renderOngkirAdmin() {
    const div = el('ongkirTabel');
    const rows = Object.entries(ongkirDataAdminRealtime || {}).sort((a, b) => a[1].wilayah.localeCompare(b[1].wilayah));
    if (!rows.length) { div.innerHTML = '<i>Belum ada wilayah.</i>'; return; }

    const thead = '<thead><tr><th>Wilayah</th><th>Ongkir</th><th>Aksi</th></tr></thead>';
    const tbody = '<tbody>' + rows.map(([k, v]) => `
      <tr>
        <td><input value="${v.wilayah}" data-key="${k}" class="wilayahName"></td>
        <td><input type="number" value="${v.ongkir}" class="wilayahHarga"></td>
        <td class="flex">
          <button class="btn" onclick="saveOngkirRowAdmin(this)">💾 Save</button>
          <button class="btn danger" onclick="deleteOngkirRowAdmin(this)">🗑 Hapus</button>
        </td>
      </tr>`).join('') + '</tbody>';

    div.innerHTML = `<table>${thead}${tbody}</table>`;
  }

  function fillWilayahDatalistAdmin() {
    const dl = el('wilayahList');
    dl.innerHTML = Object.values(ongkirDataAdminRealtime || {}).sort((a, b) => a.wilayah.localeCompare(b.wilayah))
      .map(v => `<option value="${v.wilayah}">`).join('');
  }

  window.simpanOngkirAdmin = async () => {
    const w = el('wilayahInput').value.trim();
    const h = Number(el('hargaOngkir').value || 0);
    if (!w) return showNotification('Isi wilayah', 'warning');

    try {
      await set(ref(db, 'daftar_ongkir/' + w), { wilayah: w, ongkir: h });
      el('wilayahInput').value = '';
      el('hargaOngkir').value = '';
      showNotification(`Ongkir wilayah "${w}" berhasil disimpan.`, 'success');
    } catch (error) {
      console.error("Error saving ongkir:", error);
      showNotification('Gagal menyimpan ongkir: ' + error.message, 'error');
    }
  };

  window.hapusOngkirAdmin = async () => {
    const namaWilayah = el('wilayahInput').value.trim();
    if (!namaWilayah) return showNotification('Pilih wilayah', 'warning');

    const key = Object.keys(ongkirDataAdminRealtime).find(k => ongkirDataAdminRealtime[k].wilayah === namaWilayah);
    if (!key) return showNotification('Wilayah tidak ditemukan', 'error');

    if (!confirm(`Hapus wilayah "${namaWilayah}"?`)) return;

    try {
      await remove(ref(db, 'daftar_ongkir/' + key));
      showNotification('Wilayah dihapus.', 'info');
    } catch (error) {
      console.error("Error deleting ongkir:", error);
      showNotification('Gagal menghapus wilayah: ' + error.message, 'error');
    }
  };

  window.saveOngkirRowAdmin = async (btn) => {
    const tr = btn.closest('tr');
    const key = tr.querySelector('.wilayahName').dataset.key;
    const nama = tr.querySelector('.wilayahName').value.trim();
    const ongkir = Number(tr.querySelector('.wilayahHarga').value || 0);

    if (!nama) return showNotification('Isi nama wilayah', 'warning');
    if (isNaN(ongkir)) return showNotification('Ongkir harus angka', 'warning');

    try {
      await set(ref(db, 'daftar_ongkir/' + key), { wilayah: nama, ongkir });
      showNotification('Disimpan.', 'success');
    } catch (error) {
      console.error("Error saving ongkir row:", error);
      showNotification('Gagal menyimpan perubahan: ' + error.message, 'error');
    }
  };

  window.deleteOngkirRowAdmin = async (btn) => {
    const tr = btn.closest('tr');
    const key = tr.querySelector('.wilayahName').dataset.key;
    const nama = tr.querySelector('.wilayahName').value.trim();

    if (!confirm(`Hapus wilayah "${nama}"?`)) return;

    try {
      await remove(ref(db, 'daftar_ongkir/' + key));
      showNotification('Dihapus.', 'info');
    } catch (error) {
      console.error("Error deleting ongkir:", error);
      showNotification('Gagal menghapus: ' + error.message, 'error');
    }
  };

  // ====================================================================
  // Utilities
  // ====================================================================
  function downloadCSV(rows, filename) {
    const csv = rows.map(r => r.map(c => {
      const v = (c === undefined || c === null) ? '' : String(c);
      if (/[",\n]/.test(v)) return '"' + v.replace(/"/g, '""') + '"';
      return v;
    }).join(',')).join('\n'); // Changed \\n to \n
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ====================================================================
  // Initial Setup & Event Listeners
  // ====================================================================
  // Initial display
  showSection('initialLoginChoice');

  // Kurir Nav Tabs
  qsa('#kurirNavTabs button').forEach(b => b.addEventListener('click', () => setActiveTab('kurirNavTabs', b.dataset.tab)));

  // Admin Nav Tabs
  qsa('#adminDashboard .tabs button').forEach(b => b.addEventListener('click', () => setActiveTab('adminDashboard .tabs', b.dataset.tab)));

  // Absensi Init
  listenMasterKurirAbsensi();
  listenPengajuanAbsensi();
  listenJadwalAbsensi(absensiMonthPick.value); // Initial load for absensi (kurir dashboard)

  // Admin Pending Approvals Popup
  el('pendingApprovalsBtn').addEventListener('click', () => {
    renderPendingApprovalsPopup();
    el('pendingApprovalsPopup').classList.add('show');
  });

  el('closePendingApprovalsPopup').addEventListener('click', () => {
    el('pendingApprovalsPopup').classList.remove('show');
  });

  // Fungsi untuk merender daftar pengajuan pending di pop-up
  function renderPendingApprovalsPopup() {
    const listEl = el('pendingApprovalsList');
    listEl.innerHTML = ''; // Bersihkan daftar sebelumnya

    const pending = pengajuanCacheAbsensi.filter(p => p.status === 'Pending');

    if (pending.length === 0) {
      listEl.innerHTML = '<p class="small" style="text-align: center;">Tidak ada pengajuan pending.</p>';
      return;
    }

    pending.forEach(item => {
      const div = document.createElement('div');
      div.className = 'card'; // Menggunakan kelas card untuk styling
      div.innerHTML = `
        <div style="font-weight: 600;">Tanggal: ${item.tanggal}</div>
        <div>Dari: ${item.asal}</div>
        <div>Pengganti: ${item.pengganti}</div>
        <div class="btnbar" style="margin-top: 10px; justify-content: flex-end;">
          <button class="btn-mini btn-on" onclick="approvePendingApproval('${item.id}', '${item.tanggal}', '${item.tukarTanggal}')">Approve</button>
          <button class="btn-mini btn-off" style="margin-left: 6px;" onclick="rejectPendingApproval('${item.id}')">Tolak</button>
        </div>
      `;
      listEl.appendChild(div);
    });
  }

  // Fungsi approve dan reject yang dipanggil dari pop-up
  window.approvePendingApproval = async (id, tanggal, tukarTanggal) => {
    if (!confirm('Yakin ingin menyetujui pengajuan ini?')) return;
    const ym = tanggal.slice(0, 7);
    if (!jadwalDataAbsensi[ym]) {
      showNotification('Data jadwal tidak ditemukan untuk bulan ini.', 'error');
      return;
    }
    const row = jadwalDataAbsensi[ym].find(it => it.tanggal === tanggal);
    const swapRow = jadwalDataAbsensi[ym].find(it => it.tanggal === tukarTanggal);

    if (row && swapRow) {
      const tmp = row.off;
      row.off = swapRow.off;
      swapRow.off = tmp;
      row.pengganti = '';
      swapRow.pengganti = '';
      try {
        await updateDoc(doc(PENGAJUAN_COLLECTION, id), { status: 'Approved', approvedBy: ABSENSI_ADMIN_UID });
        await saveFirestoreJadwalAbsensi(ym);
        showNotification('Approval berhasil: ' + tanggal + ' ↔ ' + tukarTanggal, 'success');
        updateAdminSummaryBoxes();
        renderPendingApprovalsPopup(); // Refresh popup
      } catch (e) {
        console.error("Error approving:", e);
        showNotification('Gagal menyetujui pengajuan: ' + e.message, 'error');
      }
    } else {
      showNotification('Tanggal pengajuan atau tanggal tukar tidak valid.', 'error');
    }
  };

  window.rejectPendingApproval = async (id) => {
    if (!confirm('Yakin ingin MENOLAK pengajuan ini?')) return;
    try {
      await updateDoc(doc(PENGAJUAN_COLLECTION, id), { status: 'Rejected', rejectedBy: ABSENSI_ADMIN_UID });
      showNotification('Pengajuan ditolak.', 'info');
      updateAdminSummaryBoxes();
      renderPendingApprovalsPopup(); // Refresh popup
    } catch (e) {
      console.error("Error rejecting:", e);
      showNotification('Gagal menolak pengajuan: ' + e.message, 'error');
    }
  };
</script>
</body>
</html>

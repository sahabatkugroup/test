<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SahabatKu Food App | Katalog Final</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkzzZBgIzaac7jSgRDct8PXeHHJCvXFo0&libraries=places" async defer></script>
    
    <style>
        /* ========================================================= */
        /* 1. Global & Theme Variables */
        /* ========================================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #00CAFF; /* Biru Cerah */
            --secondary-color: #4CAF50; /* Hijau (Aksi) */
            --price-color: #FF7043; /* Oranye/Coral untuk Harga */
            --text-color: #333;
            --bg-light: #f8f9fa; 
            --bg-card: #ffffff;
            --shadow-soft: 0 8px 25px rgba(0,0,0,0.06); 
            --radius: 12px; 
            --font-size-base: 14px; 
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-light); 
            color: var(--text-color); 
            line-height: 1.6;
            padding-bottom: 80px; 
            font-size: var(--font-size-base);
            min-height: 100vh;
        }
        main { max-width: 1000px; margin: 0 auto; padding: 0 15px; }
        .icon-small { font-size: 14px; margin-right: 5px; }
        .flex-row { display: flex; align-items: center; }
        .add-to-cart-home { 
            padding: 5px 6px; /* Tambah padding agar tombol terisi */
            width: auto;
            height: 30px; /* Diperbesar dari 22px menjadi 30px */
            border-radius: 4px;
            font-size: 12px; /* Diperbesar dari 10px menjadi 12px */
            font-weight: 600;
        }
        /* General Button Style (Modern & Keren - TIDAK OVER) */
        .btn-modern {
            border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .btn-modern.btn-primary {height: 30px; padding: 5px 6px; font-size: 12px;}
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4); }
        .btn-modern:active { transform: translateY(1px); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* L40: 1. Global & Theme Variables */
        /* ========================================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* ... existing variables ... */
        }
        /* NEW: Variabel Dark Mode */
        [data-theme="dark"] {
            --primary-color: #38b6ff;
            --secondary-color: #69f0ae;
            --price-color: #ff9a7c; 
            --text-color: #f0f0f0; 
            --bg-light: #121212; 
            --bg-card: #1e1e1e; 
            --shadow-soft: 0 8px 25px rgba(0,0,0,0.3); 
        }
        
        /* L100: NEW CSS for Theme Toggle Button */
        .theme-toggle-btn {
            position: absolute; 
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            color: var(--text-color);
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 101; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        [data-theme="dark"] .theme-toggle-btn {
            border-color: #333;
        }
        /* ========================================================= */
        /* 2. Layout & Header & Dynamic Greeting (NEW/MODIFIED for Stylish Centering) */
        /* ========================================================= */
        /* --- NEW CSS for Point 1: Galeri/Favorit Header Compact --- */
        .home-section-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 5px; 
            margin-bottom: 10px;
        }
        .home-section-header h2 {
            margin: 5px 0 10px; 
            font-size: 16px; /* Lebih kecil di mobile */
        }
        .home-section-header .favorite-filter-btn {
            padding: 5px 10px; /* Lebih kecil */
            font-size: 12px;
        }
        header {
            background: var(--bg-card);
            padding: 20px 0; /* Padding vertikal sedikit ditingkatkan */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: sticky; 
            top: 0; 
            z-index: 100;
            /* [MODIFIKASI 1: Animasi Stylish] */
            transition: padding 0.3s ease, box-shadow 0.3s ease;  
        }
        .header:hover {
            box-shadow: 0 6px 20px rgba(0, 202, 255, 0.15); /* Subtle primary color glow */
        }
        
        .header-content {
            display: flex;
            align-items: center; /* Tetap penting untuk menyelaraskan elemen flex */
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px; 
            position: relative; 
            /* NEW: Atur min-height untuk memastikan ada tinggi yang stabil, walau sudah ada padding di header */
            min-height: 24px; 
        }
        .back-btn { 
            background: var(--bg-card, #ffffff); /* Gunakan warna latar belakang header/putih */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); /* Bayangan yang jelas */
            border: none; 
            font-size: 24px; /* Sedikit lebih besar */
            color: var(--primary-color); 
            padding: 8px 10px; /* Padding lebih besar agar area klik nyaman */
            border-radius: 8px;
            cursor: pointer;
            position: absolute; 
            left: 15px; 
            z-index: 10;
            top: 50%;
            transform: translateY(-50%) translateX(0) scale(1.05); 
            
            /* PENTING: Sembunyikan dan Nonaktifkan Klik */
            opacity: 0; 
            pointer-events: none; 
            
            transition: opacity 0.4s ease, transform 0.4s ease, box-shadow 0.2s;
        }
        
        .back-btn.active {
            opacity: 1;
            transform: translateY(-50%) translateX(0) scale(1.05);
            pointer-events: auto; /* Aktifkan klik saat terlihat */
        }
        .logo {
            display: flex;
            justify-content: center; /* Center the content */
            align-items: center;
            width: 100%; /* Take full width to ensure centering works */
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s ease;        }
        
        /* Modifikasi agar logo bergeser saat tombol kembali aktif */
        .logo.shifted {
            transform: translateX(15px); /* Geser sedikit ke kanan agar tidak terlalu dekat dengan tombol back */
        }
        .logo > i { /* Hide the small icon when the text is centered, show only back button if active */
            display: none; 
        }

        /* Dynamic Greeting Styles (Centered & Stylish) */
        .greeting-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the text inside the container */
            margin-left: 0; /* Remove old margin */
            overflow: hidden;
            flex-grow: 0; /* Remove old flex-grow */
        }
        .greeting-time {
            font-size: 13px; 
            font-weight: 500; 
            color: #555;
            opacity: 0;
            transform: translateY(-10px);
            animation: fadeInDown 0.5s forwards 0.2s;
        }
        .app-title-small {
            font-size: 20px; 
            font-weight: 800; 
            color: var(--primary-color); 
            line-height: 1.1;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s forwards 0.4s;
        }

        /* NEW Stylish Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Keep original slideUp definition for other elements if they rely on it */
        @keyframes slideUp { 
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Transition & Routing */
        .content-wrapper { overflow: hidden; position: relative; min-height: 80vh; }
        .section { 
            padding-top: 20px; position: absolute; top: 0; width: 100%; 
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s ease-out; 
            min-height: 100%;
        }
        #menuListView { transform: translateX(0); opacity: 1; position: relative; } 
        #restaurantDetail { transform: translateX(100%); opacity: 0; position: absolute; left: 0; top: 0; padding-bottom: 50px;}
        #restaurantDetail.active { transform: translateX(0); opacity: 1; }
        #menuListView.hidden { transform: translateX(-100%); opacity: 0; }
        
        /* Search Bar */
        .search-container { margin: 15px 0; }
        .search-container input {
            width: 100%; padding: 10px 15px; border: 1px solid #eee; border-radius: 10px;
            font-family: 'Poppins', sans-serif; background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);font-size: 13px;
        }

        /* ========================================================= */
        /* 3. Story Bar */
        /* ========================================================= */
        .gallery-story-bar {
            display: flex; overflow-x: auto; padding: 0 0 15px 0; 
            gap: 15px; -webkit-overflow-scrolling: touch;
            margin-left: -15px; margin-right: -15px;
            padding-left: 15px; background: var(--bg-card);
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .gallery-story-bar::-webkit-scrollbar { display: none; }
        .story-item {
            flex-shrink: 0; text-align: center; cursor: pointer;
            width: 80px; padding-top: 5px;
        }
        .story-circle-wrapper {
            width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--primary-color); 
            padding: 3px; display: flex; justify-content: center; align-items: center;
            overflow: hidden; margin-bottom: 5px; background: white; margin-left: auto;margin-right: auto;
        }
        .story-circle-image { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .story-item span { 
            font-size: 11px; font-weight: 500; color: #555; display: block; 
            height: 2.2em;
            white-space: normal; 
            overflow: hidden; 
            line-height: 1.1;
            text-align: center;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }

        /* ========================================================= */
        /* 4. Menu List & Cart Control (Home) */
        /* ========================================================= */
        .category-bar { display: flex; overflow-x: auto; padding: 5px 0 15px; gap: 10px; -webkit-overflow-scrolling: touch; }
        .category-bar::-webkit-scrollbar { display: none; }
        /* MODIFIKASI STYLING CATEGORY BAR UNTUK TAMPILAN LEBIH KEREN */
        .category-item { 
            flex-shrink: 0; text-align: center; cursor: pointer; width: 60px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease; 
        }
        .category-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .category-icon { 
            width: 60px; height: 60px; 
            background: #ffffff; /* Putih bersih */
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 20px; /* Lebih besar */
            color: var(--primary-color); /* Warna Primary */
            margin-bottom: 3px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); 
            transition: all 0.3s ease; 
            border: 2px solid #eee; /* Sedikit border tipis */
        }
        
        .category-item.active .category-icon { 
            background: linear-gradient(45deg, var(--primary-color), #007bff); 
            color: white; 
            box-shadow: 0 8px 20px rgba(0, 202, 255, 0.6); 
            transform: scale(1.05); /* Sedikit membesar saat aktif */
            border-color: var(--primary-color);
        }
        
        .category-item span { 
            font-size: 10px; font-weight: 600; 
            color: #555; 
        }
        /* --- NEW FAVORITE STYLES --- */
        .favorite-icon-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.85);
            color: #ccc;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 5;
            transition: color 0.2s, background 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .favorite-icon-btn.is-favorite {
            color: #ff3838;
            background: rgba(255, 255, 255, 0.95);
        }
        /* Favorite icon for Kedai List/Detail */
        .favorite-icon-kedai {
            position: absolute;
            top: 10px;
            right: 10px; 
            background: var(--bg-card);
            color: #ccc;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: color 0.2s;
        }
        .favorite-icon-kedai.is-favorite {
            color: #ff3838;
        }
        /* Favorite button in Kedai Detail: Diletakkan agak di atas box informasi */
        .detail-profile-box .favorite-icon-kedai {
            top: -20px; 
            right: 15px;
            width: 45px;
            height: 45px;
            font-size: 20px;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        /* Menu Item Detail Favorite Icon */
        .menu-item-detail { position: relative; }
        .menu-item-detail .favorite-icon-btn {
            top: 5px; 
            bottom: auto; 
            right: 5px;
            width: 25px;
            height: 25px;
            font-size: 12px;
        }
        /* Filter button style */
        .favorite-filter-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px 10px !important;
            font-size: 12px !important;
            font-weight: 600;
            color: #777;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .favorite-filter-btn.active {
            background: #ff3838;
            color: white;
            border-color: #ff3838;
            box-shadow: 0 4px 10px rgba(255, 56, 56, 0.4);
        }
        /* TATA LETAK MENU UTAMA: 2 KOLOM */
        /* ========================================================= */
        /* üîß PERBAIKAN TAMPILAN CART CONTROL di MENU LIST HOME üîß */
        /* ========================================================= */
        
        /* Kartu menu di home */
        .menu-list-home { 
            display: grid !important;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
            overflow-x: hidden !important;
            padding-bottom: 15px;
            -webkit-overflow-scrolling: touch; 
        }
        .menu-list-home::-webkit-scrollbar { display: none; }
        
        .menu-card-home {
            width: auto !important;
            height: auto;
            background: var(--bg-card); 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            padding: 0;
            position: relative;
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        .menu-card-home:active { transform: scale(0.98); }
        
        .menu-card-home .menu-img { 
            width: 100%; 
            height: auto; 
            object-fit: cover; 
            aspect-ratio: 1 / 1;
            border-radius: 8px 8px 0 0;
        }
        .menu-card-home .menu-info-home { 
            padding: 8px;
        }
        .menu-info-home h3 { 
            font-size: 15px; 
            margin-bottom: 2px; 
            color: var(--text-color);
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .menu-info-home .menu-category-tag { 
            font-size: 9px; 
            color: var(--secondary-color); 
            font-weight: 600; 
            display: block; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
        }
        .menu-info-home p.price { 
            font-size: 15px; 
            color: var(--price-color);
            font-weight: 800; 
        }
        
        /* ========================================================= */
        /* üéØ CART CONTROL GROUP ‚Äî Disamakan dengan Tombol +Tambah */
        /* ========================================================= */
        
        /* ========================================================= */
        /* üîß PERBAIKAN TOMBOL +TAMBAH DAN + / - (FINAL RESPONSIF) */
        /* ========================================================= */
        
        /* Wrapper kontrol kuantitas */
        .cart-control-group {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid var(--primary-color);
            border-radius: 6px;
            background: var(--bg-card);
            height: 36px;
            padding: 0 6px;
            box-sizing: border-box;
            opacity: 1;
            transform: scale(1);
            transition: all 0.25s ease;
        }
        
        /* Tombol tambah/kurang */
        .control-btn-menu {
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 28px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-minus-menu { background: var(--price-color); }
        .control-plus-menu { background: var(--secondary-color); }
        
        .quantity-display {
            font-size: 14px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
            color: var(--primary-color);
            margin: 0 6px;
        }
        
        /* ========================================================= */
        /* Tombol +Tambah ‚Äî sama tinggi dan animasi transisi halus */
        /* ========================================================= */
        .add-to-cart-btn-detail {
            height: 36px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 100%;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .add-to-cart-btn-detail:hover {
            background: #00b2e6;
        }
        
        /* ========================================================= */
        /* ‚ú® ANIMASI TRANSISI TOMBOL +TAMBAH <-> KONTROL + / - */
        /* ========================================================= */
        .add-to-cart-btn-detail,
        .cart-control-group {
            transition: all 0.3s ease-in-out;
        }
        .add-to-cart-btn-detail.fade-out {
            opacity: 0;
            transform: scale(0.9);
        }
        .cart-control-group.fade-in {
            opacity: 1;
            transform: scale(1);
        }
        /* ========================================================= */
        /* üîß SINKRONISASI UKURAN TOMBOL +TAMBAH DAN + / - */
        /* ========================================================= */
        /* üîß SINKRONISASI UKURAN TOMBOL +TAMBAH DAN + / - */
        /* ========================================================= */
         	 	 
        /* Untuk tombol +Tambah di Home & Detail */
        .add-to-cart-home,
        .add-to-cart-btn-detail {
          height: 36px !important; 
          border-radius: 6px !important;
          font-size: 12px !important;
          font-weight: 700 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          
          /* PERUBAHAN UTAMA UNTUK MEMPERPANJANG TOMBOL */
          padding: 0 0 !important; /* MENGHAPUS padding horizontal (12px) */
          width: 100% !important; /* MENAMBAH: Memaksa tombol mengambil lebar penuh kartu */
          
          background: var(--primary-color) !important;
          color: #fff !important;
          border: none !important;
          cursor: pointer !important;
          transition: all 0.2s ease !important;
        }
         	 	 
        /* Untuk grup + / - (TIDAK ADA PERUBAHAN) */
        .cart-control-group {
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          height: 36px !important; 
          border-radius: 6px !important;
          border: 1.5px solid var(--primary-color) !important;
          background: var(--bg-card) !important;
          padding: 0 6px !important;
          box-sizing: border-box !important;
        }
         	 	 
        /* Tombol + dan - (TIDAK ADA PERUBAHAN) */
        .control-btn-menu {
          width: 25px !important;
          height: 25px !important;
          border: none !important;
          border-radius: 4px !important;
          font-size: 16px !important;
          font-weight: 700 !important;
          color: #fff !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          cursor: pointer !important;
          transition: background 0.25s ease !important;
        }
        .control-minus-menu { background: var(--price-color) !important; }
        .control-plus-menu { background: var(--secondary-color) !important; }
         	 	 
        /* Angka di tengah (TIDAK ADA PERUBAHAN) */
        .quantity-display {
          font-size: 14px !important;
          font-weight: 700 !important;
          min-width: 28px !important;
          text-align: center !important;
          color: var(--primary-color) !important;
          margin: 0 6px !important;
        }
         	 	 
        /* Responsif biar rapi di HP kecil (TIDAK ADA PERUBAHAN PENTING) */
        @media (max-width: 480px) {
          .add-to-cart-home,
          .add-to-cart-btn-detail,
          .cart-control-group {
            height: 32px !important; 
          }
          .control-btn-menu {
            width: 28px !important;
            height: 26px !important;
            font-size: 14px !important;
          }
          .quantity-display {
            font-size: 13px !important;
          }
        }
        /* ========================================================= */
        /* üì± RESPONSIF UNTUK LAYAR KECIL */
        /* ========================================================= */
        @media (max-width: 480px) {
            .add-to-cart-btn-detail,
            .cart-control-group {
                height: 32px; /* sedikit lebih kecil di layar kecil */
                border-radius: 5px;
            }
            .control-btn-menu {
                width: 28px;
                height: 26px;
                font-size: 14px;
            }
            .quantity-display {
                font-size: 13px;
                min-width: 24px;
                margin: 0 4px;
            }
        } 
        .menu-card-home .menu-info-home { 
            padding: 8px; /* Pastikan padding ini ada untuk memberi jarak pada konten lain di kartu */
        }
        /* ========================================================= */
        .kedai-list-bottom {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Grid 2 Kolom Responsif */
            gap: 10px; /* Jarak antar kartu lebih rapat */
            overflow-x: hidden; /* Matikan scroll horizontal */
            padding: 0;
            margin-left: 0; 
            margin-right: 0;
        }
        .kedai-list-bottom::-webkit-scrollbar { display: none; } /* Hide scrollbar for neatness */
        
        .kedai-card-bottom {
            flex-shrink: 0; 
            width: 100%; 
            background: var(--bg-card); border-radius: 10px; overflow: hidden; /* Pastikan overflow: hidden; ada di sini */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; 
            transition: transform 0.2s;
            height: auto; 
            position: relative; 
            padding: 0;
        }
        .kedai-card-bottom:active { transform: scale(0.98); }
        .kedai-card-bottom img { 
            width: 100%; 
            aspect-ratio: 1 / 1;
            height: auto; 
            object-fit: cover; 
        }
        .kedai-info-bottom {
            padding: 8px 10px 10px 10px; /* Padding: Atas 8px, Kanan 10px, Bawah 10px, Kiri 10px */
        }
        .kedai-info-bottom .address-text {
            padding: 0;
            font-size: 14px;
            color: #777;
            /* HAPUS margin-top/bottom di sini karena sudah diatur di status tag */
            margin-top: 0;
            margin-bottom: 4px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        /* PASTIKAN HEADING (NAMA TOKO) TERPOTONG RAPI */
        .kedai-info-bottom h3 { 
            font-size: 15px; 
            margin-bottom: 2px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            padding: 0; /* Tambahkan padding agar tidak menempel */
        }
        .kedai-status-tag { 
            display: block !important; /* PAKSA elemen ini berada di baris baru */
            width: fit-content !important; /* Batasi lebar hanya sepanjang isinya (misal: "Buka") */
            max-width: 90% !important; /* Batas maksimum agar tidak terlalu mepet ke kanan */
            
            /* Properti Teks */
            padding: 2px 6px !important; 
            border-radius: 4px !important; 
            font-size: 14px !important; 
            font-weight: 700 !important; 
            
            /* Properti Jarak */
            margin-top: 3px !important; 
            margin-bottom: 5px !important; 
            margin-left: 0px !important; /* Tambahkan jarak 10px dari tepi kiri kartu (seperti h3) */
            
            /* Properti Pemotongan (jika teks status sangat panjang, walau jarang terjadi) */
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        /* Open/Closed color scheme */
        .kedai-card-bottom.open .kedai-status-tag { background-color: #e6ffed; color: var(--secondary-color); }
        .kedai-card-bottom.closed .kedai-status-tag { background-color: #ffe6e6; color: var(--price-color); } /* UPDATED COLOR */
        
        .menu-count-bottom { 
            font-size: 9px; 
            color: #555;
            margin-top: 5px; 
            padding: 0; /* Tambahkan padding di bawah */
        }

        /* PASTIKAN DETAIL INFO JUGA TERPOTONG (JIKA BERUPA TULISAN PANJANG) */
        .kedai-info-details {
            font-size: 11px;
            color: #777; 
            margin-top: 5px; 
            margin-bottom: 5px;
            white-space: nowrap; /* Ditambahkan */
            overflow: hidden; /* Ditambahkan */
            text-overflow: ellipsis; /* Ditambahkan */
            padding: 0; /* Tambahkan padding agar tidak menempel */
        }
        /* ========================================================= */
        /* 6. Detail Kedai & Menu List di Detail */
        /* ========================================================= */
        .detail-header-img { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            display: block; 
        }
        .detail-profile-box { 
            background: var(--bg-card); padding: 25px; border-radius: var(--radius); 
            box-shadow: var(--shadow-soft); margin-top: -35px; position: relative; z-index: 5;
            margin-bottom: 20px;
        }
        .detail-name { font-size: 25px; margin-bottom: 5px; color: var(--primary-color); }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: 700; margin-top: 8px;}
        .status-open { background-color: #e6ffed; color: var(--secondary-color); }
        .status-closed { background-color: #ffe6e6; color: var(--price-color); } /* UPDATED COLOR */

        .order-direct-btn { padding: 15px 25px; border-radius: 12px; width: 100%; font-size: 16px; margin-top: 15px; }

        /* Detail Kedai Menu List */
        .section-title { 
            font-size: 20px; 
            margin-top: 25px; 
            margin-bottom: 15px; 
            color: #555; 
        }
        .menu-list-detail { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
        }
        .menu-item-detail { 
            /* PENTING: Atur tinggi 100% dan Flexbox Column */
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            
            background: var(--bg-card); 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            padding: 0; 
            align-items: stretch;
        }
        .menu-img-detail { 
            width: 100%; /* Gambar ambil lebar penuh kontainer */
            height: auto;
            aspect-ratio: 1 / 1;
            flex-shrink: 0; 
            border-radius: 8px 8px 0 0; 
            object-fit: cover; 
            margin-right: 0; /* Tidak perlu margin kanan karena layout vertikal */
        }
        /* TAMBAHKAN KODE INI */
        .menu-name-detail {
            font-size: 16px; /* Bisa disesuaikan */
            font-weight: 700; /* Membuat teks tebal (bold) */
            color: var(--text-color); /* Atau warna yang Anda inginkan */
            margin-bottom: 4px; /* Jarak dari kategori di bawah */
            /* Pastikan juga terpotong rapi */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        /* KONTEN DETAIL: Perbaikan Utama untuk Perataan */
        .menu-details-detail > :first-child { 
            font-weight: 700; /* Membuat teks tebal (bold) */
            font-size: 16px;  /* Sedikit lebih besar dari 15px */
            color: var(--text-color);
            margin-bottom: 2px;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
       }
        .menu-price-detail { 
            font-size: 15px; 
            color: var(--price-color); 
            font-weight: 800; 
            margin-bottom: 0; /* Hilangkan margin-bottom */
        } /* UPDATED COLOR */
        .menu-category-text-detail {
            font-size: 12px; 
            color: var(--primary-color); 
            font-weight: 600; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.2;
            max-height: 2.4em;
            white-space: normal;
            transition: max-height 0.3s ease;
        }

        
        /* ========================================================= */
        /* Penambahan Wrapper untuk Harga dan Kontrol Aksi (Wajib di HTML Anda) */
        /* ========================================================= */
        
        .price-action-wrapper {
            display: flex;
            justify-content: space-between; /* Harga di kiri, kontrol di kanan */
            align-items: center; /* Sejajarkan vertikal */
            margin-top: auto; /* Mendorong ke dasar container */
            padding-top: 5px; /* Sedikit padding di atas untuk pemisah visual */
        }
         
        /* Dynamic Cart Control Group (Detail Menu List - Larger) */
        .add-to-cart-btn-detail { /* Use this class for + button when cart is 0 */
            background: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            width: 28px; 
            height: 28px; 
            font-size: 16px; 
            flex-shrink: 0;
            /* Perbaikan: Hapus align-self dan margin yang mengganggu */
            margin: 0; 
            align-self: unset;
        }
         
        .menu-item-detail .cart-control-group {
            height: 30px; 
            font-size: 12px;
            /* Perbaikan: Hapus margin yang mengganggu */
            margin: 0; 
            flex-shrink: 0;
        }
        .menu-item-detail .control-btn-menu {
            padding: 10px;
        }
        .menu-item-detail .quantity-display {
            font-size: 12px;
            min-width: 20px; /* Diperkecil agar lebih ringkas */
            text-align: center;
        }

        /* Gallery Carousel (Untuk Detail Kedai & Modal Preview) */
        .gallery-carousel { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; -webkit-overflow-scrolling: touch;}
        .gallery-carousel::-webkit-scrollbar { display: none; }
        .gallery-item { 
            flex-shrink: 0; 
            width: 180px; 
            height: 120px; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            cursor: pointer;
        }
        .gallery-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        /* ========================================================= */
        /* 7. Modal Order & Cart Controls */
        /* ========================================================= */
        #orderModal .modal-content {
            padding: 15px; /* Lebih kecil */
            border: 2px solid var(--primary-color);
            margin: 15px; /* Margin agar tidak mentok di tepi HP */
            max-width: 90%; /* Pastikan pas di layar kecil */
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; color: #555;}
        .form-group input, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 14px; background-color: var(--bg-light);
            font-family: 'Poppins', sans-serif;
        }
        .whatsapp-btn-submit { 
            width: 100%; 
            padding: 12px; /* Lebih ringkas */
            font-size: 15px; 
            border-radius: 10px; 
        }        
        #orderSummary {
            border: 1px solid var(--primary-color); 
            background-color: #f0faff; 
        }
        #summaryList li {
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
            font-size: 13px;
            list-style: none; 
            padding-left: 0;
        }
        #totalPriceModal { 
            font-size: 20px; 
            font-weight: 800; 
            color: var(--price-color); /* UPDATED COLOR */
            margin-top: 15px; 
            text-align: right; 
        }
        
        .address-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        .address-input-group input {
            flex-grow: 1;
            margin-bottom: 0; 
        }
        .address-input-group .btn-location {
            flex-shrink: 0;
            padding: 10px 15px; 
            font-size: 14px;
            height: 40px; 
            border-radius: 6px;
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .address-status {
            font-size: 11px;
            margin-top: 5px;
            color: #777;
            font-style: italic;
            min-height: 1.2em;
        }

        /* Cart Item Controls in Modal (Fitur Hapus) */
        .cart-item-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #ccc;
            padding: 8px 0;
            font-size: 14px;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        .control-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .control-minus { background: #ffeded; color: var(--price-color); } /* UPDATED COLOR */
        .control-plus { background: #edfff1; color: var(--secondary-color); }
        .control-remove { 
            background: #e0e0e0; 
            color: var(--text-color); /* Darker color for clear removal */
            margin-left: 5px; /* Add space for the trash icon */
        }
        
        /* ========================================================= */
        /* 8. MODAL GALLERY VIEWER (Fitur Kembali) */
        /* ========================================================= */
        #galleryViewerModal {
            background-color: rgba(0, 0, 0, 0.95); 
            padding: 0;
            width: 100vw;
            height: 100vh;
        }

        .modal-gallery-viewer-wrapper {
            display: flex; 
            height: 100%; 
            transition: transform 0.5s ease-in-out; 
            align-items: center;
            overflow: hidden; 
        }

        .modal-gallery-slide-full {
            flex-shrink: 0;
            height: 100%; 
            position: relative;
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        .modal-gallery-slide-full img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }

        .modal-gallery-slide-full img.zoomed {
            max-width: none;
            max-height: none;
            width: auto;
            height: auto;
            object-fit: contain; 
            cursor: grab;
            touch-action: none;
        }

        .gallery-viewer-header #galleryViewerKedaiName {
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent) !important;
            padding: 0 5px;font-size: 14px !important; 
        }

        /* Styling for the close/back button in viewer */
        .gallery-viewer-close {
            font-size: 18px !important; 
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.2s;
        }

        /* ========================================================= */
        /* 9. Floating WA Admin Button (NEW) */
        /* ========================================================= */
        .floating-admin-wa {
            position: fixed;
            bottom: 80px; 
            right: 15px;
            z-index: 1000;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: #25D366;
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.6);
            font-size: 26px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .floating-admin-wa:hover {
            transform: scale(1.05);
        }
        /* ===== PERBAIKAN PENUH UNTUK TOMBOL +/- ===== */
        .cart-control-group {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 1.5px solid var(--primary-color) !important;
            border-radius: 6px !important;
            height: 36px !important;
            padding: 0 6px !important; /* üîπ beri ruang di kiri-kanan */
            background: var(--bg-card) !important;
            box-sizing: border-box !important;
        }
        
        .control-btn-menu {
            width: 32px !important;
            height: 28px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            border: none !important;
            border-radius: 4px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: background 0.2s ease !important;
        }
        
        .control-minus-menu {
            background: var(--price-color) !important;
        }
        
        .control-plus-menu {
            background: var(--secondary-color) !important;
        }
        
        .quantity-display {
            font-size: 14px !important;
            font-weight: 700 !important;
            min-width: 28px !important;
            text-align: center !important;
            color: var(--primary-color) !important;
            margin: 0 6px !important; /* üîπ jarak aman antar tombol */
            line-height: 1 !important;
        }
        
        /* Samakan tinggi tombol ‚Äú+ Tambah‚Äù agar transisi tidak loncat */
        .add-to-cart-btn-detail {
            height: 36px !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
            width: 100% !important;
            cursor: pointer !important;
            transition: background 0.2s ease !important;
        }
        .add-to-cart-btn-detail:hover {
            background: #00b2e6 !important;
        }
        /* ========================================================= */
        /* 9. Notifikasi Sementara (PERUBAHAN untuk Kanan Atas) */
        /* ========================================================= */
        #tempNotification {
            position: fixed;
            top: 20px; /* Jarak dari atas */
            right: 20px; /* Jarak dari kanan */
            z-index: 10000;
            background-color: #333; /* Warna latar gelap */
            color: white;
            padding: 8px 12px; /* Padding lebih kecil */
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            text-align: left;
            max-width: 250px; /* Batasi lebar */
            opacity: 0; 
            transition: opacity 0.5s ease-in-out; 
            visibility: hidden;
            font-size: 13px; /* Ukuran teks lebih kecil */
        }
        #tempNotification.show {
            opacity: 1;
            visibility: visible;
        }
        #tempNotification p {
            margin-bottom: 3px;
            font-size: 12px;        }
        #tempNotification a {
            color: var(--primary-color, #00CAFF); 
            text-decoration: underline; /* Tautan dijadikan underline saja */
            font-weight: bold;
            display: inline;
            margin-top: 0;
            padding: 0;
            border: none;
        }
        #tempNotification strong {
            font-size: 13px;
        }
      /* Styling untuk Tombol Close */
      .close-btn {
          position: absolute;
          top: 0px; /* Geser sedikit ke atas */
          right: 5px; /* Geser sedikit ke kanan */
          color: #f1f1f1;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          background: none;
          border: none;
          padding: 5px;
          line-height: 1;
      }
      
      .close-btn:hover {
          color: white;
      }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <button class="back-btn" id="backButton" onclick="showMenuListView()"><i class="fas fa-arrow-left"></i></button>
            <div class="logo">
                <i class="fas fa-utensils" style="color: var(--primary-color);"></i>
                <div class="greeting-container">
                    <span class="app-title-small" id="headerTitle">SahabatKu Food App</span>
                    <span class="greeting-time" id="dynamicGreeting">Memuat...</span>
                </div>
            </div>
        </div>
    </header>
    <div id="tempNotification">
        <button class="close-btn" id="closeNotificationBtn">&times;</button>
        <p>
            <strong>PEMBERITAHUAN!</strong><br><br>
            Jika menu yang Anda inginkan tidak tersedia di aplikasi ini, silakan hubungi langsung WhatsApp Admin untuk pemesanan khusus atau informasi lebih lanjut.
        </p>
        <a href="#" id="tempNotificationWaLink" target="_blank">Hubungi Admin Via WhatsApp</a>
    </div>
    <main>
        <div class="content-wrapper">
            <section id="menuListView" class="section">
                <div class="home-section-header"> 
                    <h2><i class="fas fa-camera-retro" style="color: var(--primary-color);"></i>  Cerita Kedai</h2>
                    <button id="toggleFavoriteFilter" class="favorite-filter-btn" onclick="toggleFavoriteFilter()">
                        <i class="far fa-heart icon-small"></i>Favoritmu
                    </button>
                </div>
                <div class="gallery-story-bar" id="galleryStoryBarContainer">
                    <p style="text-align: center; color: #999; padding: 10px 15px; width: 100%;">Memuat galeri cerita...</p>
                </div>
                
                <div class="search-container">
                    <input type="text" id="searchMenu" placeholder="Memuat pesan apa hari ini?" onkeyup="renderMenuListView()">
                </div>

                <div class="category-bar" id="categoryBar">
                    <p style="text-align: center; color: #999; padding: 10px 0;">Memuat kategori...</p>
                </div>
                
                <div class="menu-list-home" id="menuItemsListView">
                    <p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">Memuat daftar menu...</p>
                </div>

                <h2 style="margin: 30px 0 15px; font-size: 20px; border-top: 1px solid #eee; padding-top: 20px;"><i class="fas fa-store" style="color: #007bff;"></i> Rekomendasi Kami </h2>
                
                <div class="search-container" style="margin-top: -5px; margin-bottom: 15px;">
                    <input type="text" id="searchKedai" placeholder="Telusuri Kedai Rekomendasi..." onkeyup="renderRestaurantListAtBottom()">
                </div>
                
                <div class="kedai-list-bottom" id="kedaiItemsListAtBottom">
                    <p style="text-align: center; color: #999; padding: 20px; grid-column: 1 / -1;">Memuat kedai...</p>
                </div>
            </section>

            <section id="restaurantDetail" class="section">
                
                <img id="detailImage" class="detail-header-img" src="">
                <div class="detail-profile-box">
                    <h1 id="detailName" class="detail-name"></h1>
                    <p class="flex-row" style="font-size: 12px; color: #777;"><i class="icon-small fas fa-map-marker-alt"></i> <span id="detailAddress"></span></p>
                    <div class="status-badge" id="detailStatus"></div>
                    
                    <p class="detail-description" id="detailDescription" style="margin-top: 10px; font-size: 13px; color: #555;"></p>

                    <button class="order-direct-btn btn-modern btn-whatsapp" onclick="openOrderModal('direct')"><i class="fab fa-whatsapp"></i> Pesan Langsung (WhatsApp)</button>
                </div>

                <h3 class="section-title"><i class="fas fa-images"></i> Galeri Foto</h3>
                <div id="galleryContainer">
                    <div class="gallery-carousel" id="galleryCarousel">
                        <p style="font-size: 13px; color: #999; padding: 0 15px;">Tidak ada foto galeri yang dipublikasikan.</p>
                    </div>
                </div>
                
                <h3 class="section-title"><i class="fas fa-list-alt"></i> Daftar Menu Kedai Ini</h3>
                <div class="search-container" style="margin: 0 0 20px;">
                    <input type="text" id="searchMenuDetail" placeholder="Cari nama menu di kedai ini..." onkeyup="renderMenuDetail(currentRestaurantId)">
                </div>
                
                <div class="category-bar" id="categoryBarDetail">
                    <p style="text-align: center; color: #999; padding: 10px 0;">Memuat kategori...</p>
                </div>
                <div class="menu-list-detail" id="menuItemsContainerDetail">
                    <p style="font-size: 13px; color: #999; padding: 10px 0;">Menu belum tersedia untuk kedai ini.</p>
                </div>
            </section>
        </div>
    </main>
    
    <button class="floating-admin-wa" onclick="openDirectWhatsappAdmin()" title="Pesan Langsung ke Admin">
        <i class="fab fa-whatsapp"></i>
    </button>
    
    <div class="floating-cart-bar" id="cartBar" style="position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 20px; background: white; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 500;">
        <div class="cart-info" style="font-weight: 600; font-size: 15px; color: var(--primary-color);">
            <i class="fas fa-shopping-cart" style="margin-right: 8px;"></i>
            <span id="cartCount">0 Item</span>
        </div>
        <button class="order-btn btn-modern btn-secondary" style="box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);" onclick="openOrderModal('cart')">Pesan Sekarang</button>
    </div>


    <div id="galleryViewerModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; padding: 0; z-index: 4000;">
        <div class="gallery-viewer-content" id="galleryViewerContent" style="background: none; max-width: 100%; height: 100%; padding: 0; position: relative;">
            <div class="gallery-viewer-header" style="position: absolute; top: 0; left: 0; right: 0; color: white; display: flex; justify-content: space-between; align-items: center; z-index: 10;">
                <span id="galleryViewerTitle">Galeri Kedai</span>
                <span class="gallery-viewer-counter" id="galleryCounter">1/1</span>
                <span class="gallery-viewer-close" onclick="closeModal('galleryViewerModal')">&times;</span>
            </div>
            
            <div class="modal-gallery-viewer-wrapper" id="modalGalleryViewerWrapper">
                </div>
            
            <button class="viewer-nav-btn" id="viewerPrevSlide" onclick="navigateGalleryViewer(-1)" style="position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 15px 18px; cursor: pointer; z-index: 10; font-size: 20px; border-radius: 50%; left: 10px;"><i class="fas fa-chevron-left"></i></button>
            <button class="viewer-nav-btn" id="viewerNextSlide" onclick="navigateGalleryViewer(1)" style="position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 15px 18px; cursor: pointer; z-index: 10; font-size: 20px; border-radius: 50%; right: 10px;"><i class="fas fa-chevron-right"></i></button>

            <button id="viewerOrderButton" class="btn-modern btn-whatsapp" onclick="openOrderModal('direct', true)" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 12px; font-weight: 700; cursor: pointer; z-index: 10;"><i class="fab fa-whatsapp"></i> Pesan Sekarang</button>
        </div>
    </div>


    <div id="orderModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 15px; z-index: 3100;">
        <div class="modal-content" style="background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; box-shadow: var(--shadow-soft); position: relative; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeModal('orderModal')" style="position: absolute; top: 10px; right: 20px; font-size: 30px; color: #999; cursor: pointer;">&times;</span>
            <h3 style="margin-bottom: 25px; color: var(--primary-color);"><i class="fas fa-clipboard-list"></i> <span id="modalTitle">Formulir Pesanan</span></h3>
            
            <div id="directOrderGalleryPreview" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 10px;">
                <h4 style="font-size: 16px; color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-images"></i> Pratinjau Galeri Kedai</h4>
                <div class="gallery-carousel" id="orderModalGalleryCarousel">
                    <p style="font-size: 13px; color: #999; padding: 0 15px;">Memuat foto...</p>
                </div>
                <p style="font-size: 11px; color: #777; margin-top: 10px;">*Klik foto untuk melihat galeri layar penuh.</p>
            </div>


            <div id="orderSummary" style="display:none; border: 1px solid var(--primary-color); padding: 15px; border-radius: 10px; margin-bottom: 20px; background-color: #f0faff;">
                <h4 style="font-size: 16px; color: var(--primary-color); margin-bottom: 10px;">Ringkasan Pesanan (<span id="summaryKedaiName"></span>)</h4>
                <ul id="summaryList" style="list-style: none; font-size: 14px; padding-left: 0;">
                    </ul>
                <div id="totalPriceModal" style="font-size: 20px; font-weight: 800; color: var(--price-color); margin-top: 15px; text-align: right;">Total: Rp 0</div>
                <p id="ongkirDisclaimer" style="font-size: 11px; color: #555; text-align: right; margin-top: 5px;">*Total ini belum termasuk ongkos kirim (ongkir)</p>
            </div>

            <form id="orderForm">
                <div class="form-group">
                    <label for="customerAddress"><i class="fas fa-truck icon-small"></i> Alamat Pengiriman</label>
                    <div class="address-input-group">
                        <input type="text" id="customerAddress" placeholder="Jalan, Nomor Rumah, RT/RW (Cth: Jl. Kenanga No. 12)">
                        <button type="button" class="btn-location btn-modern" onclick="getLocation()"><i class="fas fa-map-marked-alt"></i> Google Maps</button>
                    </div>
                    <div id="addressStatus" class="address-status">
                         Gunakan tombol Google Maps untuk mengisi alamat otomatis, atau isi alamat manual di kolom di atas.
                    </div>
                </div>

                <div class="form-group">
                    <label for="customerName"><i class="fas fa-user icon-small"></i> Nama Pemesan</label>
                    <input type="text" id="customerName" placeholder="Nama Anda" required>
                </div>

                <div class="form-group">
                    <label for="customerNotes"><i class="fas fa-comment-alt icon-small"></i> Catatan (Cth: Rasa, Level Pedas, Detail)</label>
                    <textarea id="customerNotes" rows="3" placeholder="Contoh: Ayam Geprek level 3, Kopi susu gula aren normal."></textarea>
                </div>

                <button type="submit" class="whatsapp-btn-submit btn-modern btn-whatsapp"><i class="fab fa-whatsapp"></i> Kirim Pesanan via WhatsApp</button>
            </form>
        </div>
    </div>
    
    
    <script>
        // =========================================================
        // JAVASCRIPT LOGIC
        // =========================================================
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyApP7-PPtMf3c4yn_Yzm-xYvkKPf9K1N4Y",
          authDomain: "daftarkedaikemitraan.firebaseapp.com",
          databaseURL: "https://daftarkedaikemitraan-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "daftarkedaikemitraan",
          storageBucket: "daftarkedaikemitraan.firebasestorage.app",
          messagingSenderId: "543218937987",
          appId: "1:543218937987:web:a40e427d6befb6c866ebb6",
          measurementId: "G-C66WQ6FHX1"
        };
        
        const DEFAULT_RESTAURANT_IMAGE = 'https://res.cloudinary.com/sahabatkugroup/image/upload/v1762000455/tgaeu7hv7jmkhcqazbip.png';
        const DEFAULT_MENU_IMAGE = 'https://res.cloudinary.com/sahabatkugroup/image/upload/v1762108703/ywifsbuhnvwlxgtvriwg.jpg';
        const WHATSAPP_ADMIN_NUMBER = '6282219313326'; // GANTI DENGAN NOMOR WHATSAPP ADMIN

        let geocoder;
        const ADDRESS_STATUS_EL = () => document.getElementById('addressStatus');

        // --- UTILS & HELPERS ---
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID').format(number);
        };
        const getCurrentWibTimeComponents = () => {
            const date = new Date();
            const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            const wibDate = new Date(utc + (3600000 * 7)); // UTC + 7 hours for WIB
            return {
                hour: wibDate.getHours(),
                minute: wibDate.getMinutes(),
                fullDate: wibDate
            };
        };
        const getGreeting = () => { // NEW: Dynamic Greeting Function
            const { hour } = getCurrentWibTimeComponents();
            if (hour >= 4 && hour < 10) return "Selamat Pagi, Sahabat!";
            if (hour >= 10 && hour < 15) return "Selamat Siang, Sahabat!";
            if (hour >= 15 && hour < 18) return "Selamat Sore, Sahabat!";
            return "Selamat Malam, Sahabat!";
        };
        const setMenuSearchPlaceholder = () => {
            const searchEl = document.getElementById('searchMenu');
            if (!searchEl) return;
            const { hour } = getCurrentWibTimeComponents();
            let placeholder = "Mau pesan apa hari ini?"; // Default
            if (hour >= 4 && hour < 10) {
                placeholder = "Menu sarapan apa yang Kakak mau?";
            } else if (hour >= 10 && hour < 15) {
                placeholder = "Enaknya makan siang dengan menu apa?";
            } else if (hour >= 15 && hour < 18) {
                placeholder = "Jajanan atau camilan sore yang asik!";
            } else if (hour >= 18 || hour < 4) {
                placeholder = "Menu makan malam atau begadang yang lezat?";
            }
            searchEl.placeholder = placeholder;
        };
        const checkRestaurantStatus = (r) => {
            const openTime = r.openTime;
            const closeTime = r.closeTime;
            const statusMode = r.statusMode;
            const manualStatus = r.manualStatus;
            
            if (statusMode === 'manual') {
                const statusText = manualStatus === 'open' ? 'Buka (Manual)' : 'Tutup (Manual)';
                return { status: statusText, is_open: manualStatus === 'open' };
            }
            
            if (!openTime || !closeTime) return { status: 'Unknown', is_open: false };
            
            const { hour: nowHour, minute: nowMinute } = getCurrentWibTimeComponents();
            const nowMinutes = nowHour * 60 + nowMinute;

            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };

            const openMinutes = toMinutes(openTime);
            const closeMinutes = toMinutes(closeTime);
            
            let isOpen;
            if (openMinutes <= closeMinutes) {
                isOpen = nowMinutes >= openMinutes && nowMinutes < closeMinutes;
            } else { // Overnight status
                isOpen = nowMinutes >= openMinutes || nowMinutes < closeMinutes;
            }

            const status = isOpen ? 'Buka' : 'Tutup';
            return { status: status, is_open: isOpen };
        };
        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };
        const openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
        };
    // --- NEW FAVORITE FEATURE CONSTANTS & HELPERS ---
        const LS_FAVORITE_KEDAI = 'sahabat_fav_kedai';
        const LS_FAVORITE_MENU = 'sahabat_fav_menu';
        let isFavoriteFilterActive = false; // State untuk filter favorit
    
        const getFavoriteKedaiIds = () => {
            try {
                return new Set(JSON.parse(localStorage.getItem(LS_FAVORITE_KEDAI) || '[]'));
            } catch (e) {
                console.error("Error reading favorite kedai from localStorage:", e);
                return new Set();
            }
        };
    
        const getFavoriteMenuIds = () => {
            try {
                return new Set(JSON.parse(localStorage.getItem(LS_FAVORITE_MENU) || '[]'));
            } catch (e) {
                console.error("Error reading favorite menu from localStorage:", e);
                return new Set();
            }
        };
    
        const toggleFavoriteKedai = (kedaiId) => {
            const favorites = getFavoriteKedaiIds();
            if (favorites.has(kedaiId)) {
                favorites.delete(kedaiId);
            } else {
                favorites.add(kedaiId);
            }
            localStorage.setItem(LS_FAVORITE_KEDAI, JSON.stringify(Array.from(favorites)));
            updateKedaiFavoriteStatus(kedaiId); 
            renderRestaurantListAtBottom(); // Re-render list kedai
            // Jika sedang di halaman detail kedai, update status tombol
            if (currentRestaurantId === kedaiId) {
                const detailBtn = document.getElementById('favoriteKedaiButton');
                const isFav = getFavoriteKedaiIds().has(kedaiId);
                detailBtn.innerHTML = `<i class="${isFav ? 'fas fa-heart' : 'far fa-heart'}"></i>`;
                detailBtn.classList.toggle('is-favorite', isFav);
            }
        };
    
        const toggleFavoriteMenu = (menuId, event) => {
            if (event) event.stopPropagation(); // Mencegah klik kartu saat klik tombol
            const favorites = getFavoriteMenuIds();
            if (favorites.has(menuId)) {
                favorites.delete(menuId);
            } else {
                favorites.add(menuId);
            }
            localStorage.setItem(LS_FAVORITE_MENU, JSON.stringify(Array.from(favorites)));
            renderMenuListView(); // Re-render menu list view
            if (currentRestaurantId) renderMenuDetail(currentRestaurantId); // Re-render detail menu view 
        };
    
        const updateKedaiFavoriteStatus = (kedaiId) => {
            const button = document.getElementById('favoriteKedaiButton');
            if (!button) return;
            const isFav = getFavoriteKedaiIds().has(kedaiId);
            button.className = `favorite-icon-kedai ${isFav ? 'is-favorite fas' : 'far'} fa-heart`;
            button.title = isFav ? 'Hapus dari Favorit' : 'Tambahkan ke Favorit';
        };
    
        const toggleFavoriteFilter = () => {
            isFavoriteFilterActive = !isFavoriteFilterActive;
            const button = document.getElementById('toggleFavoriteFilter');
            if (isFavoriteFilterActive) {
                button.classList.add('active');
                button.innerHTML = '<i class="fas fa-heart icon-small"></i> Favorit Aktif';
            } else {
                button.classList.remove('active');
                button.innerHTML = '<i class="far fa-heart icon-small"></i> Tampilkan Favorit';
            }
            // Reset filter lain untuk fokus ke favorit
            document.getElementById('searchMenu').value = ''; 
            currentCategoryFilter = 'semua'; 
            renderCategoryBar();
            renderMenuListView();
            renderRestaurantListAtBottom();
        };
        // --- END NEW FAVORITE FEATURE ---
        // --- DYNAMIC CART CONTROL HELPER (NEW) ---
        const getCartControlHtml = (menuId, restaurantId, isDetailView = false) => {
            const item = cart.find(i => i.menuId === menuId);
            const quantity = item ? item.quantity : 0;
            const sizeClass = isDetailView ? '' : 'add-to-cart-home';
            const btnMinusClass = isDetailView ? 'control-btn-menu control-minus-menu' : 'control-btn-menu control-minus-menu';
            const btnPlusClass = isDetailView ? 'control-btn-menu control-plus-menu' : 'control-btn-menu control-plus-menu';

            if (quantity > 0) {
                return `
                    <div class="cart-control-group">
                        <button type="button" class="${btnMinusClass}" onclick="event.stopPropagation(); removeFromCart('${menuId}')"><i class="fas fa-minus"></i></button>
                        <span class="quantity-display">${quantity}</span>
                        <button type="button" class="${btnPlusClass}" onclick="event.stopPropagation(); addToCart('${menuId}', '${restaurantId}')"><i class="fas fa-plus"></i></button>
                    </div>
                `;
            }
            return `<button type="button" class="btn-modern btn-primary ${sizeClass}" onclick="event.stopPropagation(); addToCart('${menuId}', '${restaurantId}')"><i class="fas fa-cart-plus icon-small"></i> Tambah</button>`;
        };

        // --- DATA LOADING & INITIAL RENDERING ---
        const CATEGORY_ICONS = { 
            'makanan': 'fa-utensils', 
            'minuman': 'fa-coffee', 
            'snack': 'fa-cookie-bite', 
            'kopi': 'fa-mug-hot', 
            'non-kopi': 'fa-cocktail', 
            'bakmi': 'fa-bowl-food', 
            'seafood': 'fa-fish', 
            'roti': 'fa-bread-slice', 
            'sate': 'fa-utensils', 
            'bakso & soto': 'fa-bowl-food', 
            'martabak': 'fa-plate-wheat', 
            'gorengan': 'fa-fire', 
            'cemilan': 'fa-bacon', 
            'mie': 'fa-bowl-food', 
            'jus': 'fa-blender', 
            'es teh': 'fa-glass-water-droplet', 
            'lauk': 'fa-egg', 
            'ikan': 'fa-fish-fins', 
            'nasi goreng': 'fa-wok', 
            'seblak': 'fa-pepper-hot', 
            'sarapan pagi': 'fa-sun', 
            'ayam geprek': 'fa-hand-fist', 
            'minuman kekinian': 'fa-star', 
            'chiken': 'fa-drumstick-bite', 
            'makanan manis': 'fa-cookie',
            // Ikon Tambahan dari Permintaan
            'jajanan': 'fa-cookie-bite',
            'aneka nasi': 'fa-bowl-food', 
            'ayam & bebek': 'fa-drumstick-bite', 
            'semua': 'fa-grip-vertical', 
            'default': 'fa-utensils' 
        };
        
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.database();
        const RESTAURANT_REF = db.ref('restaurants');
        const MENU_REF = db.ref('menus');
        const GALLERY_REF = db.ref('galleries');

        let RESTAURANTS = {};
        let MENUS = {};
        let GALLERIES = {};
        let OPEN_RESTAURANT_IDS = new Set();
        let cart = []; // Array of { menuId, name, price, quantity, restaurantId }
        let currentRestaurantId = null; // ID of the currently displayed detail page
        let currentCategoryFilter = 'semua';
        let currentDetailCategoryFilter = 'semua'; // NEW STATE FOR DETAIL VIEW
        let currentGalleryViewerKedaiId = null;
        let currentGalleryViewerIndex = 0;
        let modalGalleryPhotos = [];
        let isOpenedFromOrderModal = false; // NEW state for Gallery Viewer

        // NEW: Form data storage for returning from Gallery Viewer
        let savedOrderFormData = { name: '', address: '', notes: '', statusText: '', statusColor: '' };
        
        const loadData = () => {
            const promises = [
                RESTAURANT_REF.once('value').then(s => { RESTAURANTS = s.val() || {}; }),
                MENU_REF.once('value').then(s => { MENUS = s.val() || {}; }),
                GALLERY_REF.once('value').then(s => { GALLERIES = s.val() || {}; })
            ];

            Promise.all(promises)
                .then(() => {
                    // 1. Cek status kedai dan isi OPEN_RESTAURANT_IDS
                    OPEN_RESTAURANT_IDS.clear();
                    Object.values(RESTAURANTS).forEach(r => {
                        const { is_open } = checkRestaurantStatus(r);
                        if (is_open && r.isPublished !== false) {
                            OPEN_RESTAURANT_IDS.add(r.id);
                        }
                    });

                    // 2. Render semua komponen Home View
                    renderGalleryStoryBar();
                    renderCategoryBar();
                    renderMenuListView();
                    renderRestaurantListAtBottom();
                    updateCartBar();
                })
                .catch(error => {
                    console.error("Error loading data:", error);
                    document.getElementById('menuItemsListView').innerHTML = `<p style="color: var(--price-color); padding: 50px; grid-column: 1 / -1;">Gagal memuat data kedai. Cek koneksi Firebase Anda.</p>`;
                });
        };

        // --- RENDERING GALERI STORY BAR (Hanya Kedai BUKA) ---
        const renderGalleryStoryBar = () => {
            const container = document.getElementById('galleryStoryBarContainer');
            container.innerHTML = '';

            const storyData = {};
            Object.values(GALLERIES)
                .filter(g => g.isPublished !== false && OPEN_RESTAURANT_IDS.has(g.restaurantId))
                .forEach(g => {
                    if (!storyData[g.restaurantId]) {
                        storyData[g.restaurantId] = { 
                            kedaiName: RESTAURANTS[g.restaurantId].name,
                            kedaiImage: RESTAURANTS[g.restaurantId].image,
                            gallery: [] 
                        };
                    }
                    storyData[g.restaurantId].gallery.push(g.image || DEFAULT_RESTAURANT_IMAGE);
                });
            
            const storyIds = Object.keys(storyData).sort((a,b) => storyData[a].kedaiName.localeCompare(storyData[b].kedaiName));

            if (storyIds.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; padding: 10px 15px; width: 100%;">Tidak ada cerita dari kedai yang buka saat ini.</p>`;
                return;
            }

            storyIds.forEach(id => {
                const data = storyData[id];
                const story = document.createElement('div');
                story.className = 'story-item';
                story.onclick = () => openGalleryViewer(id);
                story.innerHTML = `
                    <div class="story-circle-wrapper">
                        <img class="story-circle-image" src="${data.kedaiImage || DEFAULT_RESTAURANT_IMAGE}" alt="${data.kedaiName}">
                    </div>
                    <span>${data.kedaiName}</span>
                `;
                container.appendChild(story);
            });
        };

        // --- RENDERING CATEGORY BAR (Home View) ---
        const renderCategoryBar = () => {
            const container = document.getElementById('categoryBar');
            container.innerHTML = '';
            
            const categories = new Set();
            Object.values(MENUS)
                .filter(m => OPEN_RESTAURANT_IDS.has(m.restaurantId))
                .forEach(m => {
                    if (m.category && Array.isArray(m.category)) {
                        m.category.forEach(cat => categories.add(cat.toLowerCase()));
                    }
                });

            let categoriesList = Array.from(categories);
            categoriesList.sort();
            
            const categoriesMap = { 
                'semua': 'Semua', 
                ...categoriesList.reduce((acc, cat) => {
                    acc[cat] = cat.charAt(0).toUpperCase() + cat.slice(1);
                    return acc;
                }, {}) 
            };

            Object.keys(categoriesMap).forEach(cat => {
                const name = categoriesMap[cat];
                const iconClass = CATEGORY_ICONS[cat] || CATEGORY_ICONS['default'];
                
                const item = document.createElement('div');
                item.className = `category-item ${cat === currentCategoryFilter ? 'active' : ''}`;
                item.onclick = () => selectCategory(cat);
                item.innerHTML = `<div class="category-icon"><i class="fas ${iconClass}"></i></div><span>${name}</span>`;
                container.appendChild(item);
            });
        };

        const selectCategory = (cat) => {
            currentCategoryFilter = cat;
            renderCategoryBar();
            renderMenuListView();
        }

        // --- RENDERING MENU LIST VIEW (Hanya Menu dari Kedai BUKA) ---
        const renderMenuListView = () => {
            const container = document.getElementById('menuItemsListView');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('searchMenu').value.toLowerCase().trim();

            let menuList = Object.values(MENUS)
                .filter(m => OPEN_RESTAURANT_IDS.has(m.restaurantId))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (searchTerm) {
                menuList = menuList.filter(m => m.name.toLowerCase().includes(searchTerm));
            }

            if (currentCategoryFilter !== 'semua') {
                menuList = menuList.filter(m => m.category && m.category.map(c => c.toLowerCase()).includes(currentCategoryFilter)
                );
            }

        // 3. Filter FAVORIT GABUNGAN (Menu ATAU Kedai)
            if (isFavoriteFilterActive) { 
                const favMenuIds = getFavoriteMenuIds();
                const favKedaiIds = getFavoriteKedaiIds(); 
                
                menuList = menuList.filter(m => 
                    // Kriteria 1: Menu itu sendiri difavoritkan
                    favMenuIds.has(m.id) ||              
                    // Kriteria 2: Kedai tempat menu berada difavoritkan
                    favKedaiIds.has(m.restaurantId)      
                );
                
                // Pesan saat Filter Favorit AKTIF dan tidak ada hasil
                if (menuList.length === 0) {
                    container.innerHTML = `<p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">Anda belum menambahkan menu atau kedai ke favorit. Silakan tandai dengan ikon hati!</p>`;
                    return;
                }
            }
        
            if (menuList.length === 0) {
                const message = isFavoriteFilterActive
                    ? `Anda belum menambahkan menu atau kedai ke favorit yang BUKA. Silakan tandai dengan ikon hati!`
                    : `Tidak ditemukan menu dari kedai yang **BUKA** atau sesuai kriteria Anda.`;
                    
                container.innerHTML = `<p style="text-align: center; color: #999; padding: 50px; grid-column: 1 / -1;">${message}</p>`;
                return;
            }
            menuList.forEach(m => {
                const r = RESTAURANTS[m.restaurantId];
                if (!r) return;
                const isFav = getFavoriteMenuIds().has(m.id); // NEW Check Favorite
                const card = document.createElement('div');
                card.className = 'menu-card-home';
                card.onclick = () => showRestaurantDetail(r.id);
                card.innerHTML = `
                    <button class="favorite-icon-btn ${isFav ? 'is-favorite fas' : 'far'}" 
                            onclick="toggleFavoriteMenu('${m.id}', event)" title="${isFav ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}">
                        <i class="${isFav ? 'fas fa-heart' : 'far fa-heart'}"></i>
                    </button>
                    <img class="menu-img" src="${m.image || DEFAULT_MENU_IMAGE}" alt="${m.name}">
                    <div class="menu-info-home">
                        <div>
                            <h3>${m.name}</h3>
                            <div class="menu-category-tag">${m.category?.join(', ') || 'Menu Utama'}</div>
                            <div class="kedai-link" style="font-size: 10px; color: #777; margin-top: 5px;">
                                <i class="fas fa-store icon-small"></i> ${r.name}
                            </div>
                        </div>
                        <div class="price-and-action">
                            <p class="price">Rp ${formatRupiah(m.price)}</p>
                            ${getCartControlHtml(m.id, r.id)}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        // --- RENDERING KEDAI LIST (Hanya Kedai BUKA) ---
        // UPDATED: Added search functionality
        const renderRestaurantListAtBottom = () => {
            const container = document.getElementById('kedaiItemsListAtBottom');
            container.innerHTML = '';

            const searchTerm = document.getElementById('searchKedai').value.toLowerCase().trim();

            let restaurantList = Object.values(RESTAURANTS)
                .filter(r => OPEN_RESTAURANT_IDS.has(r.id))
                .sort((a, b) => a.name.localeCompare(b.name));

            if (searchTerm) {
                restaurantList = restaurantList.filter(r => r.name.toLowerCase().includes(searchTerm));
            }
            if (isFavoriteFilterActive) {
                const favKedaiIds = getFavoriteKedaiIds();
                restaurantList = restaurantList.filter(r => favKedaiIds.has(r.id));
            }        
            if (restaurantList.length === 0) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const message = isFavoriteFilterActive
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // MODIFIKASI PESAN INI
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ? 'Anda belum menambahkan kedai ke favorit. Silakan tandai dengan ikon hati!' 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† : 'Tidak ditemukan kedai yang BUKA atau sesuai kriteria.';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
                const padding = isFavoriteFilterActive ? '50px' : '20px'; // Tambahkan padding lebih besar jika pesan favorit kosong
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† container.innerHTML = `<p style="text-align: center; color: #999; padding: ${padding}; grid-column: 1 / -1;">${message}</p>`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† }

            restaurantList.forEach(r => {
                const isFav = getFavoriteKedaiIds().has(r.id); // NEW Favorite Check
                const { status, is_open } = checkRestaurantStatus(r);
                const menuCount = Object.values(MENUS).filter(m => m.restaurantId === r.id).length;
                
                const card = document.createElement('div');
                card.className = `kedai-card-bottom ${is_open ? 'open' : 'closed'}`;
                card.onclick = () => showRestaurantDetail(r.id);
                card.innerHTML = `
                    <button class="favorite-icon-kedai ${isFav ? 'is-favorite fas' : 'far'}" 
                            onclick="event.stopPropagation(); toggleFavoriteKedai('${r.id}')" title="${isFav ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}">
                        <i class="${isFav ? 'fas fa-heart' : 'far fa-heart'}"></i>
                    </button>
                    <img src="${r.image || DEFAULT_RESTAURANT_IMAGE}" alt="${r.name}">
                    <div class="kedai-info-bottom">
                        <h3>${r.name}</h3>
                        <span class="kedai-status-tag">${status}</span>
                        <div class="address-text"><i class="icon-small fas fa-map-marker-alt"></i> ${r.address}</div>
                        <p class="menu-count-bottom"><i class="icon-small fas fa-list"></i> ${menuCount} Menu</p>
                    </div>
                `;
                container.appendChild(card);
            });
        };

        // --- ROUTING & DETAIL VIEW ---
        // UPDATED: Header title/greeting visibility
        const showRestaurantDetail = (id) => {
            const r = RESTAURANTS[id];
            if (!r) return;

            currentRestaurantId = id;
            document.getElementById('searchMenuDetail').value = '';
            document.getElementById('headerTitle').style.display = 'none';
            document.getElementById('dynamicGreeting').style.display = 'none'; // NEW: Hide greeting
            document.getElementById('backButton').classList.add('active');
            document.querySelector('.logo').classList.add('shifted');
            document.getElementById('menuListView').classList.add('hidden');
            document.getElementById('restaurantDetail').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('detailImage').src = r.image || DEFAULT_RESTAURANT_IMAGE;
            document.getElementById('detailName').textContent = r.name;
            document.getElementById('detailAddress').textContent = r.address;
            const desc = r.description || "Selamat datang! Silakan jelajahi menu kami di bawah atau gunakan tombol Pesan Langsung.";
            document.getElementById('detailDescription').textContent = desc;

            const { status, is_open } = checkRestaurantStatus(r);
            const statusEl = document.getElementById('detailStatus');
            statusEl.textContent = status;
            statusEl.className = `status-badge ${is_open ? 'status-open' : 'status-closed'}`;

            // NEW: Reset category filter and render category bar for detail view
            currentDetailCategoryFilter = 'semua'; 
            renderDetailCategoryBar(id); 

            renderGalleryDetail(id);
            renderMenuDetail(id);
            updateKedaiFavoriteStatus
        };

        // UPDATED: Header title/greeting visibility
        const showMenuListView = () => {
            document.getElementById('backButton').classList.remove('active');
            document.querySelector('.logo').classList.remove('shifted');
            document.getElementById('headerTitle').style.display = 'block';
            document.getElementById('dynamicGreeting').style.display = 'block'; // NEW: Show greeting
            document.getElementById('restaurantDetail').classList.remove('active');
            document.getElementById('menuListView').classList.remove('hidden');
            currentRestaurantId = null;
            updateCartBar();
            document.getElementById('searchMenu').value = '';
            document.getElementById('searchKedai').value = ''; // Reset Kedai search
            renderMenuListView();
            renderRestaurantListAtBottom();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        // Render Galeri di Halaman Detail Kedai
        const renderGalleryDetail = (restaurantId) => {
            const container = document.getElementById('galleryCarousel');
            container.innerHTML = '';

            const galleryList = Object.values(GALLERIES)
                .filter(g => g.restaurantId === restaurantId && g.isPublished !== false)
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            if (galleryList.length === 0) {
                container.innerHTML = `<p style="font-size: 13px; color: #999; padding: 0 15px;">Tidak ada foto galeri yang dipublikasikan.</p>`;
                return;
            }

            galleryList.forEach((g) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.onclick = () => openGalleryViewer(restaurantId);
                item.innerHTML = `<img src="${g.image || DEFAULT_RESTAURANT_IMAGE}" alt="Galeri Foto">`;
                container.appendChild(item);
            });
        };

        // --- NEW CATEGORY FILTER LOGIC FOR DETAIL VIEW ---
        const renderDetailCategoryBar = (restaurantId) => {
            const container = document.getElementById('categoryBarDetail');
            if (!container) return;
            container.innerHTML = '';
            
            // 1. Ambil semua kategori unik dari menu kedai ini
            const categories = new Set();
            Object.values(MENUS)
                .filter(m => m.restaurantId === restaurantId)
                .forEach(m => {
                    if (m.category && Array.isArray(m.category)) {
                        m.category.forEach(cat => categories.add(cat.toLowerCase()));
                    }
                });

            let categoriesList = Array.from(categories);
            categoriesList.sort();

            // 2. Tambahkan filter 'Semua'
            const categoriesMap = { 'semua': 'Semua', ...categoriesList.reduce((acc, cat) => {
                acc[cat] = cat.charAt(0).toUpperCase() + cat.slice(1);
                return acc;
            }, {}) };

            // 3. Render Bar
            Object.keys(categoriesMap).forEach(cat => {
                const name = categoriesMap[cat];
                const iconClass = CATEGORY_ICONS[cat] || CATEGORY_ICONS['default'];
                
                const item = document.createElement('div');
                item.className = `category-item ${cat === currentDetailCategoryFilter ? 'active' : ''}`;
                item.onclick = () => selectDetailCategory(cat, restaurantId);
                item.innerHTML = `<div class="category-icon"><i class="fas ${iconClass}"></i></div><span>${name}</span>`;
                container.appendChild(item);
            });
        };

        const selectDetailCategory = (cat, restaurantId) => {
            currentDetailCategoryFilter = cat;
            renderDetailCategoryBar(restaurantId);
            renderMenuDetail(restaurantId);
        }
        // --- END NEW CATEGORY FILTER LOGIC FOR DETAIL VIEW ---


        // Render Menu List di Halaman Detail Kedai
        const renderMenuDetail = (restaurantId) => {
            const container = document.getElementById('menuItemsContainerDetail');
            container.innerHTML = '';
            const isDetailFavoriteFilterActive = false; // GANTI dengan variabel global Anda
            const searchTerm = document.getElementById('searchMenuDetail').value.toLowerCase().trim();
            
            let menuList = Object.values(MENUS)
                .filter(m => m.restaurantId === restaurantId)
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (searchTerm) {
                menuList = menuList.filter(m => m.name.toLowerCase().includes(searchTerm));
            }
            
            // NEW: Apply category filter
            if (currentDetailCategoryFilter !== 'semua') {
                menuList = menuList.filter(m => m.category && m.category.map(c => c.toLowerCase()).includes(currentDetailCategoryFilter)
                );
            }
        // 2. NEW: Filter Favorit (Hanya Menu Favorit)
            if (isDetailFavoriteFilterActive) {
                const favMenuIds = getFavoriteMenuIds();
                menuList = menuList.filter(m => favMenuIds.has(m.id));
            }
            if (menuList.length === 0) {
                const message = isDetailFavoriteFilterActive
                    ? `Tidak ada menu favorit yang ditemukan di kedai ini.`
                    : `Menu belum tersedia atau tidak ditemukan di kedai ini.`;
                    
                container.innerHTML = `<p style="font-size: 13px; color: #999; padding: 10px 0;">${message}</p>`;
                return;
            }

            menuList.forEach(m => {
                const isFav = getFavoriteMenuIds().has(m.id); // NEW Check Favorite
                const item = document.createElement('div');
                item.className = 'menu-item-detail';
                item.innerHTML = `
                    <img class="menu-img-detail" src="${m.image || DEFAULT_MENU_IMAGE}" alt="${m.name}">
                    <div class="menu-details-detail">
                        <div class="menu-name-detail">${m.name}</div>
                        <div class="menu-price-detail">Rp ${formatRupiah(m.price)}</div>
                        <div class="menu-category-text-detail">${m.category?.join(', ') || 'Menu Utama'}</div>
                    </div>
                    ${getCartControlHtml(m.id, m.restaurantId, true)}
                    <button class="favorite-icon-btn ${isFav ? 'is-favorite fas' : 'far'}" 
                            onclick="toggleFavoriteMenu('${m.id}', event)" title="${isFav ? 'Hapus dari Favorit' : 'Tambah ke Favorit'}">
                        <i class="${isFav ? 'fas fa-heart' : 'far fa-heart'}"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        };

        // --- GALLERY VIEWER MODAL LOGIC (UPDATED with back feature) ---
        let touchStartX = 0;
        let touchEndX = 0;
        
        const openGalleryViewer = (kedaiId, fromOrderModal = false) => {
            currentGalleryViewerKedaiId = kedaiId;
            currentGalleryViewerIndex = 0;
            isOpenedFromOrderModal = fromOrderModal;
            
            modalGalleryPhotos = Object.values(GALLERIES)
                .filter(g => g.restaurantId === kedaiId && g.isPublished !== false)
                .map(g => g.image || DEFAULT_RESTAURANT_IMAGE);

            if (modalGalleryPhotos.length === 0) {
                alert("Galeri kedai ini kosong.");
                return;
            }

            const kedaiName = RESTAURANTS[kedaiId].name;
            document.getElementById('galleryViewerTitle').textContent = kedaiName;

            const wrapper = document.getElementById('modalGalleryViewerWrapper');
            wrapper.innerHTML = '';
            wrapper.style.width = `${modalGalleryPhotos.length * 100}vw`;

            modalGalleryPhotos.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'modal-gallery-slide-full';
                slide.style.width = `100vw`;
                slide.innerHTML = `<img src="${url}" onclick="toggleZoom(this)" id="slideImage_${index}" style="touch-action: pan-y;">`;
                wrapper.appendChild(slide);
            });

            // Adjust Viewer Header & Buttons
            const closeBtn = document.querySelector('#galleryViewerModal .gallery-viewer-close');
            const orderBtn = document.getElementById('viewerOrderButton');
            if (fromOrderModal) {
                closeBtn.innerHTML = '&larr; Kembali ke Form';
                closeBtn.onclick = returnToOrderModal; // Function to restore form data
                orderBtn.style.display = 'none'; // Hide order button
            } else {
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => closeModal('galleryViewerModal');
                orderBtn.style.display = 'block'; // Show order button
            }

            // Add swipe handlers
            wrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            wrapper.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleGallerySwipe();
            }, false);


            updateGalleryViewerSlide();
            openModal('galleryViewerModal');
        };
        
        const handleGallerySwipe = () => {
            if (touchEndX < touchStartX - 50) { // Swipe left
                navigateGalleryViewer(1);
            } else if (touchEndX > touchStartX + 50) { // Swipe right
                navigateGalleryViewer(-1);
            }
        };

        const navigateGalleryViewer = (direction) => {
            currentGalleryViewerIndex += direction;
            if (currentGalleryViewerIndex < 0) {
                currentGalleryViewerIndex = modalGalleryPhotos.length - 1;
            } else if (currentGalleryViewerIndex >= modalGalleryPhotos.length) {
                currentGalleryViewerIndex = 0;
            }
            updateGalleryViewerSlide();
        };

        const updateGalleryViewerSlide = () => {
            const wrapper = document.getElementById('modalGalleryViewerWrapper');
            const newTranslateX = -currentGalleryViewerIndex * 100;
            wrapper.style.transform = `translateX(${newTranslateX}vw)`;
            
            document.getElementById('galleryCounter').textContent = `${currentGalleryViewerIndex + 1}/${modalGalleryPhotos.length}`;

            // Reset zoom on slide change
            document.querySelectorAll('.modal-gallery-slide-full img').forEach(img => {
                img.classList.remove('zoomed');
                img.style.transform = 'scale(1)';
            });
        };

        const toggleZoom = (img) => {
            img.classList.toggle('zoomed');
            if (img.classList.contains('zoomed')) {
                // To enable panning, we rely on the CSS/Browser defaults for oversized content
                // Setting transform: scale(1.5) as an example of zoom
                img.style.transform = 'scale(1.5)';
            } else {
                img.style.transform = 'scale(1)';
            }
        };

        // --- ORDER MODAL LOGIC (UPDATED with form data storage) ---
        const saveOrderFormData = () => {
            savedOrderFormData.name = document.getElementById('customerName').value;
            savedOrderFormData.address = document.getElementById('customerAddress').value;
            savedOrderFormData.notes = document.getElementById('customerNotes').value;
            savedOrderFormData.statusText = ADDRESS_STATUS_EL().textContent;
            savedOrderFormData.statusColor = ADDRESS_STATUS_EL().style.color;
        };

        const restoreOrderFormData = () => {
            document.getElementById('customerName').value = savedOrderFormData.name;
            document.getElementById('customerAddress').value = savedOrderFormData.address;
            document.getElementById('customerNotes').value = savedOrderFormData.notes;
            ADDRESS_STATUS_EL().textContent = savedOrderFormData.statusText || 'Gunakan tombol Google Maps untuk mengisi alamat otomatis, atau isi alamat manual di kolom di atas.';
            ADDRESS_STATUS_EL().style.color = savedOrderFormData.statusColor || '#777';
        };

        const returnToOrderModal = () => {
            closeModal('galleryViewerModal');
            // Reopen the modal with type 'direct' and restore the form data
            currentRestaurantId = currentGalleryViewerKedaiId;
            openOrderModal('direct', true); // Pass true to indicate returning from viewer
        };

        const updateRenderViews = () => {
            updateCartBar();
            renderMenuListView();
            if (currentRestaurantId) {
                renderMenuDetail(currentRestaurantId);
            }
        };

        const addToCart = (menuId, restaurantId) => {
            const menu = MENUS[menuId];
            const existingItem = cart.find(item => item.menuId === menuId);
        
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
        
                cart.push({
                    menuId: menuId,
                    name: menu.name,
                    price: menu.price,
                    quantity: 1,
                    restaurantId: restaurantId
                });
            }
            updateRenderViews();
            if (document.getElementById('orderModal').style.display === 'flex') {
                openOrderModal('cart');
            }
        };

        // Decrease quantity or remove item (Home/Detail View Controls & Modal Controls)
        const removeFromCart = (menuId) => {
            const existingItemIndex = cart.findIndex(item => item.menuId === menuId);
            if (existingItemIndex !== -1) {
                const existingItem = cart[existingItemIndex];
                existingItem.quantity -= 1;
                if (existingItem.quantity <= 0) {
                    cart.splice(existingItemIndex, 1);
                }
            }
            updateRenderViews();
            if (document.getElementById('orderModal').style.display === 'flex') {
                if (cart.length === 0) {
                    closeModal('orderModal');
                } else {
                    openOrderModal('cart');
                }
            }
        };

        // Remove item entirely from cart (Modal Trash Icon) (Feature Hapus Item Pilihan)
        const removeItemFromCart = (menuId) => {
            const existingItemIndex = cart.findIndex(item => item.menuId === menuId);
            if (existingItemIndex !== -1) {
                cart.splice(existingItemIndex, 1);
            }
            updateRenderViews();
            if (document.getElementById('orderModal').style.display === 'flex') {
                if (cart.length === 0) {
                    closeModal('orderModal');
                } else {
                    openOrderModal('cart');
                }
            }
        };

        const updateCartBar = () => {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const cartBar = document.getElementById('cartBar');
            const cartCountEl = document.getElementById('cartCount');
            const orderBtn = document.querySelector('.floating-cart-bar .order-btn');
            
            cartCountEl.textContent = `${totalItems} Item | Rp ${formatRupiah(totalPrice)}`;
            
            if (totalItems > 0) {
                cartBar.style.transform = 'translateY(0)';
                // Check if items in cart are from multiple restaurants
                const kedaiIds = new Set(cart.map(i => i.restaurantId));
                if (kedaiIds.size > 1) {
                    orderBtn.textContent = 'Pesan Sekarang (Multi-Kedai)';
                } else {
                    orderBtn.textContent = 'Pesan Sekarang';
                }
            } else {
                cartBar.style.transform = 'translateY(100%)';
            }
        };

        const openOrderModal = (type, isReturningFromViewer = false) => {
            document.getElementById('orderForm').onsubmit = (e) => {
                e.preventDefault();
                sendOrderViaWhatsapp();
            };
            
            // Set default address status
            ADDRESS_STATUS_EL().textContent = "Gunakan tombol Google Maps untuk mengisi alamat otomatis, atau isi alamat manual di kolom di atas.";
            ADDRESS_STATUS_EL().style.color = '#777';
            document.getElementById('customerAddress').disabled = false;
            
            if (isReturningFromViewer) {
                restoreOrderFormData(); // Restore saved data if returning from viewer
            } else { 
                // If it's a fresh open or from floating cart bar, initialize/reset
                saveOrderFormData(); // Save empty/default state
            }
            
            const galleryPreviewContainer = document.getElementById('directOrderGalleryPreview');
            const galleryCarousel = document.getElementById('orderModalGalleryCarousel');

            if (type === 'cart') {
                // --- Cart Order Logic ---
                const kedaiIdsInCart = [...new Set(cart.map(i => i.restaurantId))];

                if (cart.length === 0) {
                    alert("Keranjang Anda kosong. Silakan tambahkan menu terlebih dahulu.");
                    return;
                }
                
                document.getElementById('modalTitle').textContent = `Formulir Pesanan Keranjang`;
                document.getElementById('summaryKedaiName').textContent = kedaiIdsInCart.length > 1 ? 'Multiple Kedai' : RESTAURANTS[kedaiIdsInCart[0]].name;
                document.getElementById('orderSummary').style.display = 'block';
                galleryPreviewContainer.style.display = 'none';

                const summaryList = document.getElementById('summaryList');
                summaryList.innerHTML = '';
                let total = 0;

                const groupedCart = cart.reduce((acc, item) => {
                    const kedaiId = item.restaurantId;
                    if (!acc[kedaiId]) {
                        acc[kedaiId] = { name: RESTAURANTS[kedaiId]?.name || 'Kedai Tak Dikenal', items: [] };
                    }
                    acc[kedaiId].items.push(item);
                    return acc;
                }, {});

                Object.values(groupedCart).forEach(group => {
                    // Kedai Header
                    const kedaiHeader = document.createElement('h5');
                    kedaiHeader.style.cssText = 'margin-top: 15px; margin-bottom: 5px; color: var(--secondary-color); font-size: 14px; font-weight: 700; border-top: 1px dashed #ddd; padding-top: 10px;';
                    kedaiHeader.innerHTML = `<i class="fas fa-store icon-small"></i> ${group.name}`;
                    summaryList.appendChild(kedaiHeader);

                    // List Items
                    group.items.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        total += itemTotal;
                        const li = document.createElement('li');
                        li.style.borderBottom = 'none';
                        li.innerHTML = `
                            <div class="cart-item-summary">
                                <div class="cart-item-info">
                                    <span>${item.name} (${item.quantity}x)</span>
                                    <div style="font-size: 12px; color: #999;">Rp ${formatRupiah(item.price)}</div>
                                </div>
                                <div class="cart-item-controls">
                                    <button type="button" class="control-btn control-minus" onclick="removeFromCart('${item.menuId}')" title="Kurangi 1"><i class="fas fa-minus"></i></button>
                                    <span style="font-weight: 700; min-width: 20px; text-align: center;">${item.quantity}</span>
                                    <button type="button" class="control-btn control-plus" onclick="addToCart('${item.menuId}', '${item.restaurantId}')" title="Tambah 1"><i class="fas fa-plus"></i></button>
                                    <button type="button" class="control-btn control-remove" onclick="removeItemFromCart('${item.menuId}')" title="Hapus Item"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        summaryList.appendChild(li);
                    });
                });

                document.getElementById('totalPriceModal').textContent = `Total: Rp ${formatRupiah(total)}`;

            } else {
                // --- Direct Order Logic ---
                if (!currentRestaurantId && !currentGalleryViewerKedaiId) {
                     alert("Kesalahan: Kedai tidak teridentifikasi untuk Pesanan Langsung.");
                     return;
                }
                const kedaiId = currentRestaurantId || currentGalleryViewerKedaiId;
                const kedai = RESTAURANTS[kedaiId];
                
                document.getElementById('modalTitle').textContent = `Pesan Langsung ke Kedai ${kedai.name}`;
                document.getElementById('orderSummary').style.display = 'none';
                galleryPreviewContainer.style.display = 'block';

                // Render gallery preview
                galleryCarousel.innerHTML = '';
                const galleryList = Object.values(GALLERIES)
                    .filter(g => g.restaurantId === kedaiId && g.isPublished !== false)
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

                if (galleryList.length > 0) {
                    galleryList.slice(0, 5).forEach(g => { // Show up to 5 photos
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        item.onclick = (e) => {
                            e.stopPropagation();
                            saveOrderFormData(); // Save current form state before opening viewer
                            openGalleryViewer(kedaiId, true);
                            return false
                        };
                        item.innerHTML = `<img src="${g.image || DEFAULT_RESTAURANT_IMAGE}" alt="${g.name}">`;
                        galleryCarousel.appendChild(item);
                    });
                } else {
                    galleryCarousel.innerHTML = `<p style="font-size: 13px; color: #999; padding: 0 15px;">Kedai ini belum memiliki foto galeri yang dipublikasikan.</p>`;
                }
            }

            openModal('orderModal');
        };

        // --- NEW GEOLOCATION FUNCTIONS ---
        const initMapAndGeocoder = () => {
            if (typeof google !== 'undefined' && typeof google.maps.Geocoder !== 'undefined') {
                geocoder = new google.maps.Geocoder();
                console.log("Google Maps Geocoder initialized.");
            } else {
                console.warn("Google Maps API (Geocoder) belum dimuat. Pastikan Anda telah menambahkan script Google Maps dengan API Key yang benar di bagian <head>.");
                ADDRESS_STATUS_EL().textContent = "Gagal memuat fitur Google Maps. Silakan isi alamat secara manual.";
                ADDRESS_STATUS_EL().style.color = 'var(--price-color)';
            }
        };

        const reverseGeocode = ({ lat, lng }) => {
            const statusEl = ADDRESS_STATUS_EL();
            const addressInput = document.getElementById('customerAddress');
            
            geocoder.geocode({ 'location': { lat: lat, lng: lng } }, (results, status) => {
                addressInput.disabled = false;
                if (status === 'OK' && results[0]) {
                    const address = results[0].formatted_address;
                    addressInput.value = address;
                    statusEl.textContent = "Lokasi terdeteksi otomatis (Google Maps). Silakan koreksi jika perlu.";
                    statusEl.style.color = 'var(--secondary-color)';
                } else {
                    statusEl.textContent = 'Geocoding gagal: ' + status;
                    statusEl.style.color = 'var(--price-color)';
                }
            });
        };

        const getLocation = () => {
            const statusEl = ADDRESS_STATUS_EL();
            const addressInput = document.getElementById('customerAddress');

            if (!navigator.geolocation) {
                statusEl.textContent = "Error: Browser tidak mendukung Geolocation.";
                statusEl.style.color = 'var(--price-color)';
                return;
            }

            if (!geocoder) {
                statusEl.textContent = "Fitur Google Maps tidak aktif. Silakan isi alamat secara manual.";
                statusEl.style.color = 'var(--price-color)';
                return;
            }

            statusEl.textContent = "Mencari lokasi otomatis...";
            statusEl.style.color = "orange";
            addressInput.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    reverseGeocode({ lat: lat, lng: lng });
                },
                (error) => {
                    addressInput.disabled = false;
                    let errorMessage = "Gagal mengambil lokasi.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Izin lokasi ditolak. Mohon aktifkan lokasi di browser Anda.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Informasi lokasi tidak tersedia.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Permintaan waktu habis.";
                            break;
                        default:
                            errorMessage = `Error: ${error.message}`;
                    }
                    statusEl.textContent = errorMessage;
                    statusEl.style.color = 'var(--price-color)';
                }
            );
        };
        // --- END NEW GEOLOCATION FUNCTIONS ---
        
        const openDirectWhatsappAdmin = () => {
            const encodedMessage = encodeURIComponent("Halo Admin, saya ingin Order!");
            const waLink = `https://wa.me/${WHATSAPP_ADMIN_NUMBER}?text=${encodedMessage}`;
            window.open(waLink, '_blank');
        };

        const sendOrderViaWhatsapp = () => {
            const customerName = document.getElementById('customerName').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            const customerNotes = document.getElementById('customerNotes').value.trim();
            const isCartOrder = document.getElementById('orderSummary').style.display !== 'none';

            if (isCartOrder && cart.length === 0) {
                alert("Keranjang Anda kosong.");
                closeModal('orderModal');
                return;
            }

            let orderDetails = `*PESANAN BARU (SahabatKu Food App)*\n\n`;
            
            orderDetails += `*Nama Pemesan:* ${customerName}\n`;
            orderDetails += `*Alamat Pengiriman:* ${customerAddress}\n\n`;

            if (isCartOrder) {
                // --- Cart Order Message ---
                const groupedCart = cart.reduce((acc, item) => {
                    const kedaiId = item.restaurantId;
                    if (!acc[kedaiId]) {
                        acc[kedaiId] = { name: RESTAURANTS[kedaiId]?.name || 'Kedai Tak Dikenal', items: [] };
                    }
                    acc[kedaiId].items.push(item);
                    return acc;
                }, {});

                let totalPrice = 0;
                
                orderDetails += `*TIPE PESANAN: DARI KERANJANG (${cart.length} item)*\n\n`;

                Object.values(groupedCart).forEach(group => {
                    orderDetails += `*--- Pesanan dari ${group.name} ---*\n`;
                    group.items.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        totalPrice += itemTotal;
                        orderDetails += `${item.quantity}x ${item.name} (Rp ${formatRupiah(item.price)}) = Rp ${formatRupiah(itemTotal)}\n`;
                    });
                    orderDetails += '\n';
                });

                orderDetails += `*TOTAL HARGA MENU:* Rp ${formatRupiah(totalPrice)}\n`;
                orderDetails += `*Catatan Tambahan:* ${customerNotes || 'Tidak Ada Catatan'}\n\n`;
                orderDetails += `*(Total ini belum termasuk ongkos kirim (ongkir). Admin akan konfirmasi pesanan anda.)*`;
            
            } else {
                // --- Direct Order Message ---
                const kedaiId = currentRestaurantId || currentGalleryViewerKedaiId;
                const kedai = RESTAURANTS[kedaiId];
                
                if (!kedai) {
                     alert("Kesalahan: Kedai tidak teridentifikasi untuk Pesanan Langsung.");
                     return;
                }
                orderDetails += `*Dari Kedai:* ${kedai.name}\n`;
                orderDetails += `\n*TIPE PESANAN: LANGSUNG (CEK GALERI/DETAIL)*\n`;
                orderDetails += `\n*Catatan/Detail Pesanan:* \n${customerNotes || 'Catatan/Detail Pesanan Tidak Diisi'}\n`;
                orderDetails += `\n*Admin akan menghubungi Anda kembali untuk detail pesanan dan total biaya. Terima kasih!*`;
            }

            const encodedMessage = encodeURIComponent(orderDetails);
            const waLink = `https://wa.me/${WHATSAPP_ADMIN_NUMBER}?text=${encodedMessage}`;

            window.open(waLink, '_blank');
            
            closeModal('orderModal');
            alert(`Pesanan telah dikirimkan ke WhatsApp Admin. Silakan lanjutkan di chat.`);
            
            cart = [];
            updateRenderViews();
            
            if(!document.getElementById('restaurantDetail').classList.contains('active')) {
                showMenuListView(); 
            }
        };

        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initMapAndGeocoder(); 
            document.getElementById('dynamicGreeting').textContent = getGreeting(); 
            setMenuSearchPlaceholder(); 
            
            // NEW FIX: Pastikan Tombol Kembali nonaktif saat halaman dimuat
            document.getElementById('backButton').classList.remove('active');
            
            // Pastikan juga logo tidak bergeser di awal
            document.querySelector('.logo').classList.remove('shifted'); 
        // === START: TAMBAHAN LOGIKA NOTIFIKASI SEMENTARA ===
            const notification = document.getElementById('tempNotification');
            const waLinkElement = document.getElementById('tempNotificationWaLink');
            const closeBtn = document.getElementById('closeNotificationBtn'); // Dapatkan tombol tutup            
 
            const hideNotification = () => {
                notification.classList.remove('show');
            };
            // 1. Set link WhatsApp menggunakan WHATSAPP_ADMIN_NUMBER
            const WA_MESSAGE = encodeURIComponent("Halo Admin, saya ingin Order!.");
            waLinkElement.href = `https://wa.me/${WHATSAPP_ADMIN_NUMBER}?text=${WA_MESSAGE}`;
            
            const showTimer = setTimeout(() => {
                notification.classList.add('show');
                
                const hideTimer = setTimeout(hideNotification, 60000); // Durasi tampil 10 detik
                
                // Tambahkan event listener untuk tombol hapus/close
                closeBtn.addEventListener('click', () => {
                    clearTimeout(hideTimer); // Batalkan timer otomatis hilang 10 detik
                    hideNotification(); // Langsung sembunyikan
                }, { once: true }); 

            }, 300000); // Tampil setelah 5 menit
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery - Login</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* Global Styles (Gabungan dari semua modul) */
    :root {
      --main-bg-color: #0BA6DF;
      --card-bg: #fff;
      --glass: rgba(255,255,255,0.85);
      --border: #c9dbf8;
      --shadow-light: rgba(74,144,226,0.15);
      --shadow-strong: rgba(74,144,226,0.3);
      --sky-light: #d0e8ff;
      --sky: #a3c9ff;
      --sky-strong: #4a90e2;
      --accent: #0077c8;
      --muted: #4a6fa5;
      --text-primary: #0b3b5a;
      --text-secondary: #506273;
      --success-color: #28a745;
      --error-color: #dc3545;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --transition-speed: 0.3s;
      /* Absensi Colors */
      --absensi-primary: #3a8dde;
      --absensi-primary-dark: #1e5fa8;
      --absensi-bg: #e8f4fd;
      --absensi-ok: #43a047;
      --absensi-danger: #e53935;
      --absensi-pending: #f9a825;
      --absensi-text: #1a2e4a;
      --absensi-text-muted: #5a6d8c;
      --absensi-radius: 16px;
      --absensi-shadow-light: rgba(58,141,222,0.15);
      --absensi-shadow-strong: rgba(58,141,222,0.25);
      /* Cek Ongkir Specific */
      --ongkir-brand:#2f80ed;
      --ongkir-brand-2:#5ea3ff;
      --ongkir-shadow: 0 20px 45px rgba(4,32,66,.18);
    }
    /* Notification Pop-up & Overlay */
    .notification-popup { 
      position: fixed; 
      top: 20px; /* Lebih ke atas */
      left: 50%; 
      transform: translateX(-50%) translateY(-100px); /* Start above, slide down */
      background-color: var(--success-color); 
      color: #fff; 
      padding: 10px 20px; /* Lebih kecil */
      border-radius: 10px; /* Lebih kecil */
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); /* Shadow lebih halus */
      z-index: 10000; 
      opacity: 0; 
      visibility: hidden; 
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; 
      font-size: 0.9rem; /* Ukuran font lebih kecil */
      font-weight: 600; /* Lebih ringan */
      text-align: center; 
      min-width: 200px; /* Lebar minimum */
    }
    .notification-popup.show { 
      opacity: 1; 
      visibility: visible; 
      transform: translateX(-50%) translateY(0); /* Animasi slide down */
    }
    .notification-popup.success { background-color: var(--success-color); }
    .notification-popup.error { background-color: var(--error-color); }
    .notification-popup.info { background-color: var(--info-color); }
    .notification-popup.warning { background-color: var(--warning-color); }

    /* Mobile */
    @media (max-width: 600px) { 
      .container { padding: 10px 12px; margin: 12px auto; } 
      .card { padding: 18px 20px; border-radius: 16px; margin-bottom: 16px; } 
      h1 { font-size: clamp(20px, 6vw, 28px); } 
      h2, h3 { font-size: 1.1rem; margin: 6px 0 12px 0; } 
      label { font-size: 13px; margin-top: 10px; } 
      input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select { padding: 10px 12px; border-radius: 10px; font-size: 0.85rem; } 
      .btn { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; } 
      .btnbar { gap: 6px; flex-direction: column; align-items: stretch; } 
      .notification-popup { padding: 10px 15px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Halaman Login Pilihan -->
  <div id="initialLoginChoice" class="card">
    <h1>Selamat Datang di Sahabatku Delivery</h1>
    <p style="text-align:center; margin-bottom:20px; color:var(--muted);">Pilih jenis login Anda:</p>
    <div class="grid grid-2" style="max-width: 400px; margin: 0 auto; gap: 20px;">
      <button id="showKurirLogin" class="btn full"><i class="fa-solid fa-user"></i> Login Kurir</button>
      <button id="showAdminLogin" class="btn secondary full"><i class="fa-solid fa-user-gear"></i> Login Admin</button>
    </div>
  </div>

  <!-- Form Login Kurir -->
  <div id="kurirLoginForm" class="card hidden">
    <h2>Login Kurir</h2>
    <div class="grid grid-3">
      <div><label>Username</label><input id="kurirLoginUser" type="text" placeholder="Nama kurir (contoh: Tom Haye)" autocomplete="username"></div>
      <div><label>Password</label><input id="kurirLoginPass" type="password" placeholder="ID Card (contoh: 12345)" autocomplete="current-password"></div>
      <div style="align-self:end"><div class="btnbar"><button id="kurirLoginBtn" class="btn full">Masuk</button><button id="backToInitialKurir" class="btn secondary full">Kembali</button></div></div>
    </div>
    <p id="kurirLoginMsg" class="small" style="color:var(--error-color);margin-top:8px"></p>
  </div>

  <!-- Form Login Admin -->
  <div id="adminLoginForm" class="card hidden">
    <h2>Login Admin</h2>
    <div class="grid grid-3">
      <div><label>Email</label><input id="adminLoginEmail" type="email" placeholder="admin@email.com"></div>
      <div><label>Password</label><input id="adminLoginPass" type="password" placeholder="••••••••"></div>
      <div style="align-self:end"><div class="btnbar"><button id="adminLoginBtn" class="btn full">Masuk</button><button id="backToInitialAdmin" class="btn secondary full">Kembali</button></div></div>
    </div>
    <p id="adminLoginMsg" class="small" style="color:var(--error-color);margin-top:8px"></p>
  </div>
</div>

<!-- Pop Notifikasi -->
<div id="notificationPopup" class="notification-popup"></div>
<audio id="notificationSound" src="https://www.soundjay.com/buttons/button-3.mp3" preload="auto"></audio>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Firebase config Anda
  const firebaseConfig = {
    apiKey: "AIzaSyCtva8TeL40-WotK4kFL_vL8uUXL3GDfww",
    authDomain: "sahabatkuu-bisa.firebaseapp.com",
    databaseURL: "https://sahabatkuu-bisa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sahabatkuu-bisa",
    storageBucket: "sahabatkuu-bisa.firebasestorage.app",
    messagingSenderId: "315555564115",
    appId: "1:315555564115:web:56f46dbceb8c154589d4a6",
    measurementId: "G-PFGYL96VPS"
  };

  // Inisialisasi Firebase Apps
  const app = initializeApp(firebaseConfig, "mainApp"); 
  const db = getDatabase(app); // Realtime Database
  const auth = getAuth(app); // Authentication

  try { getAnalytics(app); } catch(e) {} // Optional analytics

  // UID Admin
  const ADMIN_UID = "kSW4ThusrwhUFCQeTsnPV1VNaR72"; 

  // ====================================================================
  // Helper Functions (UI & Notifikasi)
  // ====================================================================
  const el = (id) => document.getElementById(id);
  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));

  function showNotification(message, type = 'success') {
    const popup = el('notificationPopup');
    popup.textContent = message;
    popup.className = `notification-popup show ${type}`;
    el('notificationSound').play();
    setTimeout(() => {
      popup.classList.remove('show');
    }, 3000);
  }

  function showSection(id) {
    qsa('.container > div').forEach(div => div.classList.add('hidden'));
    el(id).classList.remove('hidden');
  }

  // ====================================================================
  // Initial Login Choice
  // ====================================================================
  el('showKurirLogin').addEventListener('click', () => showSection('kurirLoginForm'));
  el('showAdminLogin').addEventListener('click', () => showSection('adminLoginForm'));

  // ====================================================================
  // Kurir Login
  // ====================================================================
  el('kurirLoginBtn').addEventListener('click', doKurirLogin);
  el('backToInitialKurir').addEventListener('click', () => showSection('initialLoginChoice'));

  async function doKurirLogin() {
    const u = el('kurirLoginUser').value.trim();
    const p = el('kurirLoginPass').value.trim();
    const msgEl = el('kurirLoginMsg');
    msgEl.innerText = '';

    try {
      const snap = await get(ref(db, 'kurir/' + u));
      if (snap.exists()) {
        const data = snap.val();
        if (!data.enabled) {
          msgEl.innerText = 'Akun ini dinonaktifkan! Silakan hubungi admin.';
          showNotification('Akun diblokir!', 'error');
          return;
        }
        if (data.password !== p) {
          msgEl.innerText = 'Password salah!';
          showNotification('Password salah!', 'error');
          return;
        }
        localStorage.setItem('currentUser', data.username);
        window.location.href = 'kurir.html'; // Redirect to kurir dashboard
      } else {
        msgEl.innerText = 'User tidak ditemukan!';
        showNotification('User tidak ditemukan!', 'error');
      }
    } catch (err) {
      console.error("Firebase error:", err);
      msgEl.innerText = 'Gagal konek Firebase atau user tidak ditemukan!';
      showNotification('Login gagal!', 'error');
    }
  }

  // Auto-login kurir if already in localStorage
  window.addEventListener('load', () => {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      el('kurirLoginUser').value = savedUser;
      // Optionally, attempt to auto-login or just show the form with pre-filled username
      // For security, it's better to require password re-entry or use Firebase Auth for persistent sessions.
      // For this example, we'll just pre-fill.
    }
  });

  // ====================================================================
  // Admin Login
  // ====================================================================
  el('adminLoginBtn').addEventListener('click', doAdminLogin);
  el('backToInitialAdmin').addEventListener('click', () => showSection('initialLoginChoice'));

  async function doAdminLogin() {
    const email = el('adminLoginEmail').value.trim();
    const password = el('adminLoginPass').value.trim();
    const msgEl = el('adminLoginMsg');
    msgEl.innerText = '';

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password); 
      if (userCredential.user.uid === ADMIN_UID) {
        localStorage.setItem('isAdminLoggedIn', 'true'); // Simple flag for admin session
        window.location.href = 'admin.html'; // Redirect to admin dashboard
      } else {
        msgEl.innerText = 'Anda bukan admin yang berwenang.';
        showNotification('Login gagal!', 'error');
      }
    } catch (error) {
      console.error("Admin login error:", error);
      msgEl.innerText = 'Login gagal: ' + error.message;
      showNotification('Login Admin Gagal!', 'error');
    }
  }

  // Check admin auth state on load
  onAuthStateChanged(auth, (user) => {
    if (user && user.uid === ADMIN_UID) {
      // If admin is already logged in via Firebase Auth, redirect directly
      window.location.href = 'admin.html';
    } else {
      // If not admin, or no user, show initial choice
      showSection('initialLoginChoice');
    }
  });
</script>
</body>
</html>

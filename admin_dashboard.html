<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery - Dashboard Admin</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <!-- Dashboard Admin -->
    <div id="adminDashboard">
      <header>
        <div class="bar">
          <div class="flex"><strong>📊 Admin Panel</strong><span class="badge">👑 Admin</span></div>
          <button id="adminLogoutBtn" class="btn danger">Logout</button>
        </div>
      </header>
      <div class="card">
        <div class="tabs">
          <button class="btn active" data-tab="tabNotaAdmin">📝 Kelola Nota</button>
          <button class="btn" data-tab="tabRekapAdmin">📈 Rekap & Riwayat</button>
          <button class="btn" data-tab="tabKurirAdmin">👥 Manajemen Kurir</button>
          <button class="btn" data-tab="tabOngkirAdmin">🚚 Manajemen Ongkir</button>
        </div>
      </div>

      <!-- Kelola Nota Admin -->
      <div id="tabNotaAdmin" class="card tab">
        <div class="row">
          <div><label>Nama Kurir</label><select id="filterKurir"><option value="">— Semua Kurir —</option></select></div>
          <div><label>Tanggal</label><input type="date" id="filterTanggal"></div>
          <div><label>Bulan</label><input type="month" id="filterBulan"></div>
          <div><label>Tahun</label><input type="number" id="filterTahun" min="2020" placeholder="2025"></div>
        </div>
        <div class="row">
          <div><label>Cari Nota (No Nota)</label><input id="filterCariNota" list="listNoNota" placeholder="Pilih/ketik No Nota"><datalist id="listNoNota"></datalist></div>
          <div style="align-self:end">
            <button class="btn secondary" onclick="applyFilter()">Filter</button>
            <button class="btn secondary" onclick="clearFilter()">Reset</button>
            <button class="btn" onclick="showAddForm()">+ Tambah Nota</button>
            <button class="btn secondary" onclick="exportCSV()">⬇ Export CSV (hasil filter)</button>
          </div>
        </div>
        <div id="notaList"></div>

        <!-- Form Tambah/Edit Nota Admin -->
        <div id="notaForm" class="card hidden">
          <h3 id="formTitle">Tambah Nota</h3>
          <div class="row">
            <div><label>Kurir (dropdown / ketik manual)</label><input id="formKurir" list="listKurir" placeholder="Pilih/ketik kurir"><datalist id="listKurir"></datalist></div>
            <div><label>No Nota</label><input id="formNoNota" placeholder="NN-001 / otomatis"></div>
          </div>
          <h4>Item</h4>
          <table id="itemTable">
            <thead><tr><th>Nama</th><th>Qty</th><th>Harga</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="flex"><button class="btn ghost" onclick="addItemRow()">+ Item</button></div>
          <div class="row">
            <div><label>Ongkir</label><input id="formOngkir" type="number" value="0"></div>
            <div><label>Tambahan</label><input id="formTambahan" type="number" value="0"></div>
            <div><label>Keterangan</label><input id="formText" placeholder="Catatan…"></div>
          </div>
          <h4>Total: Rp <span id="formTotal">0</span></h4>
          <div class="flex">
            <button class="btn" onclick="saveNota()">Simpan</button>
            <button class="btn danger" onclick="cancelNota()">Batal</button>
          </div>
        </div>
      </div>

      <!-- Rekap & Riwayat Admin -->
      <div id="tabRekapAdmin" class="card tab hidden">
        <div class="row">
          <div><label>Kurir</label><select id="rekapKurirAdmin"><option value="">— Semua Kurir —</option></select></div>
          <div><label>Bulan</label><input type="month" id="rekapBulanAdmin"></div>
          <div style="align-self:end"><button class="btn secondary" onclick="renderRekapAdmin()">Terapkan</button></div>
        </div>
        <div class="flex">
          <span class="pill">Mode: Total Nota per Kurir</span>
          <span class="pill">Mode: Penghasilan (tanggal, jumlah, ongkir, tambahan, total)</span>
        </div>
        <div id="rekapRingkasAdmin" style="margin-top:10px"></div>
        <div id="rekapTabelAdmin"></div>
        <div class="flex"><button class="btn secondary" onclick="exportCSVRekapAdmin()">⬇ Export CSV (Rekap)</button></div>
      </div>

      <!-- Manajemen Kurir Admin -->
      <div id="tabKurirAdmin" class="card tab hidden">
        <div class="grid grid-2" style="gap: 12px;">
          <div>
            <label>Tambah Kurir Baru</label>
            <input id="kurirBaru" placeholder="Nama kurir (username)">
          </div>
          <div>
            <label>Password (kurir)</label>
            <input id="kurirPass" type="password" placeholder="minimal 6 karakter">
          </div>
          <div style="grid-column: span 2;">
            <button class="btn full" onclick="tambahKurirAdmin()">+ Tambah Kurir</button>
            <small style="display: block; margin-top: 8px; color: var(--muted);">Akun dibuat di Realtime DB. (Penghapusan akun Auth penuh memerlukan server admin.)</small>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
        <div class="grid grid-2" style="gap: 12px;">
          <div>
            <label>Pilih Kurir</label>
            <select id="kurirManage"></select>
          </div>
          <div style="align-self:end;">
            <button class="btn danger full" onclick="hapusKurirAdmin()">Hapus Kurir</button>
          </div>
          <div style="grid-column: span 2;">
            <button class="btn secondary full" onclick="ubahPasswordKurirAdmin()">Ubah Password Kurir</button>
          </div>
          <div style="grid-column: span 2;">
            <button class="btn secondary full" onclick="blokirKurirAdmin()">Blokir Kurir</button>
          </div>
          <div style="grid-column: span 2;">
            <button class="btn secondary full" onclick="bukaBlokirKurirAdmin()">Buka Blokir Kurir</button>
          </div>
        </div>
        <small style="display: block; margin-top: 12px; color: var(--muted);">Catatan: Menghapus kurir akan menonaktifkan akses di aplikasi kurir dengan menghapus entri kurir di DB. Blokir/Buka Blokir akan mengubah status 'enabled' kurir.</small>
        <div class="table-wrap" style="margin-top: 20px;">
          <table id="tableKurirAdmin">
            <thead>
              <tr>
                <th>Username</th>
                <th>Password</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              <!-- Kurir data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Manajemen Ongkir Admin -->
      <div id="tabOngkirAdmin" class="card tab hidden">
        <div class="row">
          <div><label>Wilayah</label><input id="wilayahInput" list="wilayahList" placeholder="Pilih/ketik wilayah"><datalist id="wilayahList"></datalist></div>
          <div><label>Harga Ongkir</label><input id="hargaOngkir" type="number" placeholder="0"></div>
          <div style="align-self:end">
            <button class="btn" onclick="simpanOngkirAdmin()">💾 Save/Update</button>
            <button class="btn danger" onclick="hapusOngkirAdmin()">🗑 Hapus</button>
          </div>
        </div>
        <h4>Data Wilayah</h4>
        <div id="ongkirTabel"></div>
      </div>
    </div>
  </div>

  <!-- Pop Notifikasi -->
  <div id="notificationPopup" class="notification-popup"></div>
  <audio id="notificationSound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>

  <script type="module" src="firebase_config.js"></script>
  <script type="module" src="common_script.js"></script>
  <script type="module" src="admin_script.js"></script>
</body>
</html>

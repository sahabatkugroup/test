<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Sahabatku Delivery - Admin</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Global Styles (Gabungan dari semua modul) */
    :root {
      --main-bg-color: #0BA6DF;
      --card-bg: #fff;
      --glass: rgba(255,255,255,0.85);
      --border: #c9dbf8;
      --shadow-light: rgba(74,144,226,0.15);
      --shadow-strong: rgba(74,144,226,0.3);
      --sky-light: #d0e8ff;
      --sky: #a3c9ff;
      --sky-strong: #4a90e2;
      --accent: #0077c8;
      --muted: #4a6fa5;
      --text-primary: #0b3b5a;
      --text-secondary: #506273;
      --success-color: #28a745;
      --error-color: #dc3545;
      --info-color: #17a2b8;
      --warning-color: #ffc107;
      --transition-speed: 0.3s;
      /* Absensi Colors */
      --absensi-primary: #3a8dde;
      --absensi-primary-dark: #1e5fa8;
      --absensi-bg: #e8f4fd;
      --absensi-ok: #43a047;
      --absensi-danger: #e53935;
      --absensi-pending: #f9a825;
      --absensi-text: #1a2e4a;
      --absensi-text-muted: #5a6d8c;
      --absensi-radius: 16px;
      --absensi-shadow-light: rgba(58,141,222,0.15);
      --absensi-shadow-strong: rgba(58,141,222,0.25);
      /* Cek Ongkir Specific */
      --ongkir-brand:#2f80ed;
      --ongkir-brand-2:#5ea3ff;
      --ongkir-shadow: 0 20px 45px rgba(4,32,66,.18);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', system-ui, Arial, Helvetica, sans-serif; background: var(--main-bg-color); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.6; }
    .container { max-width: 960px; margin: 0 auto; padding: 16px 20px; }
    .card { 
      background: var(--card-bg); 
      border-radius: 20px; 
      padding: 24px 28px; 
      box-shadow: 0 12px 30px var(--shadow-light); 
      margin-bottom: 20px; 
      border: 1px solid var(--border); 
      transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease; 
    }
    .card:hover { 
      box-shadow: 0 16px 40px var(--shadow-strong); 
      transform: translateY(-3px); 
    }
    h1, h2, h3, h4 { margin: 8px 0 16px 0; color: var(--sky-strong); font-weight: 700; letter-spacing: 0.02em; }
    h1 { font-size: clamp(24px, 4vw, 36px); text-align: center; }
    h2 { font-size: clamp(20px, 3.5vw, 28px); }
    h3 { font-size: clamp(18px, 3vw, 24px); }
    h4 { font-size: clamp(16px, 2.5vw, 20px); }
    label { display: block; margin-top: 12px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: 0.01em; }
    input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1.5px solid var(--border); margin-top: 8px; background: var(--glass); outline: none; font-size: 0.95rem; color: var(--text-primary); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, input[type="email"]:focus, textarea:focus, select:focus { border-color: var(--sky-strong); box-shadow: 0 0 8px var(--sky-strong); background: #f0f8ff; }
    .btn { 
      background: var(--sky-strong); 
      color: #fff; 
      border: none; 
      padding: 10px 16px; 
      border-radius: 14px; 
      cursor: pointer; 
      box-shadow: 0 6px 18px var(--shadow-light); 
      font-weight: 700; 
      font-size: 0.9rem; 
      letter-spacing: 0.02em; 
      transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease; 
    }
    .btn:hover { 
      background: #3a6fc1; 
      box-shadow: 0 8px 24px var(--shadow-strong); 
      transform: translateY(-2px); 
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px var(--shadow-light);
    }
    .btn.secondary { 
      background: #f5f7fa; 
      color: var(--text-primary); 
      border: 1.5px solid var(--border); 
      box-shadow: none; 
      font-weight: 600; 
    }
    .btn.secondary:hover { 
      background: #e1e9f8; 
      border-color: var(--sky-strong); 
      color: var(--sky-strong); 
    }
    .btn.ghost { 
      background: transparent; 
      color: var(--text-primary); 
      border: 1.5px dashed var(--border); 
      font-weight: 600; 
    }
    .btn.ghost:hover { 
      border-color: var(--sky-strong); 
      color: var(--sky-strong); 
    }
    .btn.danger { 
      background: #ff6b6b; 
      box-shadow: none; 
      font-weight: 700; 
    }
    .btn.danger:hover { 
      background: #e04e4e; 
    }
    .btn.full { width: 100%; }
    .btnbar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end; }
    nav.tab { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive tabs */
      gap: 10px; 
      margin-bottom: 16px; 
      background: var(--card-bg); 
      padding: 10px; 
      border-radius: 16px; 
      box-shadow: 0 6px 18px rgba(0,0,0,0.1); 
    }
    nav.tab button { 
      padding: 12px 0; 
      border-radius: 14px; 
      border: 1.5px solid var(--border); 
      background: var(--card-bg); 
      color: var(--text-primary); 
      font-weight: 700; 
      font-size: 0.9rem; 
      letter-spacing: 0.02em; 
      transition: background var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease, transform var(--transition-speed) ease; 
      cursor: pointer; 
    }
    nav.tab button:hover {
      transform: translateY(-2px);
    }
    nav.tab button.active { 
      background: linear-gradient(90deg, var(--sky-strong), #6fc2ff); 
      color: #fff; 
      border-color: transparent; 
      box-shadow: 0 6px 18px var(--shadow-light); 
      transform: translateY(0); /* Reset transform for active tab */
    }
    .row { display: flex; gap: 12px; align-items: flex-start; }
    .col { flex: 1; }
    .hidden { display: none !important; }
    .small { font-size: 12px; color: var(--muted); font-weight: 600; }
    .stack { display: flex; flex-direction: column; gap: 10px; }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: repeat(2,1fr); }
    .grid-3 { grid-template-columns: repeat(3,1fr); }
    .grid-4 { grid-template-columns: repeat(4,1fr); }
    .section-title { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-weight: 700; color: var(--sky-strong); font-size: 1rem; }
    .list-v { display: flex; flex-direction: column; gap: 10px; }
    .line-card { 
      border: 1.5px solid var(--border); 
      border-radius: 16px; 
      background: var(--card-bg); 
      padding: 12px 16px; 
      display: grid; 
      grid-template-columns: 2.5fr 80px 160px 120px 90px; 
      gap: 10px; 
      align-items: center; 
      box-shadow: 0 3px 9px rgba(74,144,226,0.07); 
      transition: box-shadow var(--transition-speed) ease; 
    }
    .line-card:hover { box-shadow: 0 6px 18px var(--shadow-light); }
    .line-card .sub { font-weight: 700; text-align: center; color: var(--sky-strong); font-size: 0.9rem; }
    .line-card .mini-btn { 
      width: 100%; 
      border-radius: 12px; 
      padding: 6px 0; 
      font-weight: 600; 
      font-size: 0.85rem; 
      background: var(--sky); 
      color: var(--text-primary); 
      border: none; 
      cursor: pointer; 
      transition: background var(--transition-speed) ease, transform var(--transition-speed) ease; 
    }
    .line-card .mini-btn:hover { 
      background: var(--sky-strong); 
      color: #fff; 
      transform: translateY(-1px);
    }
    .line-card-tambahan { 
      border: 1.5px solid var(--border); 
      border-radius: 16px; 
      background: var(--card-bg); 
      padding: 12px 16px; 
      display: grid; 
      grid-template-columns: 1.8fr 1.2fr 120px; 
      gap: 10px; 
      align-items: center; 
      box-shadow: 0 3px 9px rgba(74,144,226,0.07); 
      transition: box-shadow var(--transition-speed) ease; 
    }
    .line-card-tambahan:hover { box-shadow: 0 6px 18px var(--shadow-light); }
    .nota-box { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; background: #f5faff; padding: 18px 20px; border-radius: 14px; border: 1.5px solid #c9dbf8; min-height: 140px; color: var(--text-primary); font-size: 0.9rem; box-shadow: inset 0 0 8px #dbeeff; line-height: 1.4; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; color: var(--text-primary); }
    th, td { padding: 10px 8px; border: 1.5px solid var(--border); text-align: center; font-weight: 600; }
    th { background: linear-gradient(90deg, var(--sky-strong), #6fc2ff); color: #fff; letter-spacing: 0.03em; }
    
    /* Notification Pop-up & Overlay */
    .notification-popup { 
      position: fixed; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%) translateY(-100px); /* Start above, slide down */
      background-color: var(--success-color); 
      color: #fff; 
      padding: 10px 20px; 
      border-radius: 10px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
      z-index: 10000; 
      opacity: 0; 
      visibility: hidden; 
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; 
      font-size: 0.9rem; 
      font-weight: 600; 
      text-align: center; 
      min-width: 200px; 
    }
    .notification-popup.show { 
      opacity: 1; 
      visibility: visible; 
      transform: translateX(-50%) translateY(0); /* Animasi slide down */
    }
    .notification-popup.success { background-color: var(--success-color); }
    .notification-popup.error { background-color: var(--error-color); }
    .notification-popup.info { background-color: var(--info-color); }
    .notification-popup.warning { background-color: var(--warning-color); }

    /* Custom Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 28px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 90%;
      transform: scale(0.8);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      position: relative;
    }
    .modal-overlay.show .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    .modal-content.large {
      max-width: 700px;
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text-primary);
      font-size: 1.4rem;
      text-align: center;
    }
    .modal-content p {
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-secondary);
    }
    .modal-content .modal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .modal-content .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--muted);
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .modal-content .modal-close:hover {
      color: var(--text-primary);
    }

    /* Autocomplete */
    .autocomplete-suggestions { border: 1px solid #999; background: #fff; cursor: default; overflow: auto; max-height: 150px; position: absolute; z-index: 100; width: calc(100% - 28px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .autocomplete-suggestion { padding: 8px 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem; display: block; }
    .autocomplete-suggestion.selected { background: var(--sky-light); color: var(--text-primary); }
    .autocomplete-suggestion strong { font-weight: 700; color: var(--sky-strong); }
    /* Cek Ongkir Specific */
    .cek-ongkir-module .hero { position: relative; background: radial-gradient(1100px 400px at 10% -10%, rgba(255,255,255,.22), rgba(255,255,255,0)), linear-gradient(135deg, var(--ongkir-brand-2), var(--ongkir-brand)); border-radius: 20px; padding: 28px clamp(16px,3vw,36px); color: #fff; box-shadow: var(--ongkir-shadow); overflow: hidden; margin-bottom: 20px; }
    .cek-ongkir-module .hero:after { content: ""; position: absolute; right: -120px; top: -120px; width: 280px; height: 280px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%); filter: blur(2px); transform: rotate(15deg); }
    .cek-ongkir-module .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .8px; text-transform: uppercase; font-size: clamp(18px, 2.4vw, 22px); }
    .cek-ongkir-module .brand i { background: #fff; color: var(--ongkir-brand); width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,.15), inset 0 -2px 3px rgba(0,0,0,.08); }
    .cek-ongkir-module .headline { font-size: clamp(22px, 3.2vw, 30px); font-weight: 700; margin: 12px 0 6px; }
    .cek-ongkir-module .sub { opacity: .95; font-weight: 500; }
    .cek-ongkir-module .card__body { padding: clamp(16px, 2.8vw, 28px); }
    .cek-ongkir-module .field .label { font-size: 14px; font-weight: 600; color: #2a3b58; margin: 2px 0 8px 6px; display: flex; align-items: center; gap: 8px; }
    .cek-ongkir-module .control { position: relative; }
    .cek-ongkir-module .control .licon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #6c84a8; }
    .cek-ongkir-module .control .clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: #f1f6ff; color: #1e429f; width: 30px; height: 30px; border-radius: 9px; cursor: pointer; }
    .cek-ongkir-module .control .clear-btn:hover { filter: brightness(0.98); }
    .cek-ongkir-module .suggest { position: absolute; z-index: 40; left: 0; right: 0; top: calc(100% + 6px); background: #fff; border: 1px solid #e8eef8; border-radius: 14px; overflow: hidden; box-shadow: 0 14px 40px rgba(17,38,87,.15); max-height: 320px; overflow-y: auto; display: none; }
    .cek-ongkir-module .s-item { padding: 12px 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .cek-ongkir-module .s-item:hover, .cek-ongkir-module .s-item.active { background: #f6faff; }
    .cek-ongkir-module .s-icon { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; background: #eef5ff; color: #2161ff; flex: 0 0 28px; }
    .cek-ongkir-module .s-text { line-height: 1.2; }
    .cek-ongkir-module .s-name { font-weight: 600; }
    .cek-ongkir-module .s-price { font-size: 12px; color: #5a6d89; margin-top: 2px; }
    .cek-ongkir-module mark { background: #ffefb3; padding: 0 .15em; border-radius: 4px; }
    .cek-ongkir-module .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
    .cek-ongkir-module .btn-primary { color: #fff; background: linear-gradient(180deg, #3b82f6, #1d4ed8); box-shadow: 0 12px 30px rgba(30,64,175, .35); }
    .cek-ongkir-module .btn-primary:hover { filter: brightness(1.03); }
    .cek-ongkir-module .btn-ghost { background: #eff5ff; color: #1d4ed8; border: 1px solid #d9e7ff; }
    .cek-ongkir-module .btn-ghost:hover { background: #e9f1ff; }
    .cek-ongkir-module .btn-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .cek-ongkir-module .btn-danger:hover { filter: brightness(0.99); }
    .cek-ongkir-module .results { margin-top: 18px; display: grid; gap: 14px; grid-template-columns: 1fr 1fr; }
    .cek-ongkir-module .pellet { display: inline-flex; align-items: center; gap: 8px; background: #f3f7ff; color: #1e40af; border: 1px solid #e9f2ff; padding: 8px 12px; border-radius: 999px; font-size: 13px; font-weight: 600; }
    .cek-ongkir-module .kartu { border: 1px solid #eaf0fb; border-radius: 16px; padding: 18px; background: linear-gradient(180deg, #ffffff, #fbfdff); }
    .cek-ongkir-module .kartu h4 { margin: 0 0 8px; font-size: 16px; letter-spacing: .2px; display: flex; align-items: center; gap: 8px; }
    .cek-ongkir-module .harga { font-size: 28px; font-weight: 800; color: #0b5bd3; }
    .cek-ongkir-module .muted { color: #607599; font-size: 13px; }
    .cek-ongkir-module .formula { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas; background: #f6f9ff; border: 1px dashed #d9e7ff; padding: 10px 12px; border-radius: 10px; display: inline-block; margin-top: 8px; }
    .cek-ongkir-module .footer { text-align: center; color: #eaf2ff; margin-top: 18px; font-size: 13px; }
    /* Absensi Module Specific */
    .absensi-module .topbar, .absensi-module .admin-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center; margin: 12px 0 20px; }
    .absensi-module .topbar .btn, .absensi-module .admin-bar .btn { padding: 12px 18px; border: none; border-radius: 14px; background: var(--absensi-primary); color: #fff; font-weight: 700; cursor: pointer; transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease; box-shadow: 0 4px 12px rgba(0,0,0,0.12); user-select: none; }
    .absensi-module .topbar .btn:hover, .absensi-module .admin-bar .btn:hover, .absensi-module .topbar .btn:focus, .absensi-module .admin-bar .btn:focus { filter: brightness(0.9); transform: translateY(-2px); outline: none; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .absensi-module .topbar .btn.ghost { background: #e8f4fb; color: var(--absensi-primary-dark); box-shadow: none; border: 1.5px solid var(--absensi-primary); }
    .absensi-module .topbar .btn.active { background: var(--absensi-primary-dark); box-shadow: 0 6px 20px var(--absensi-shadow-strong); }
    .absensi-module .admin-bar .btn.alt { background: #e8f4fb; color: var(--absensi-primary-dark); box-shadow: none; border: 1.5px solid var(--absensi-primary); }
    .absensi-module .admin-bar .btn.danger { background: var(--absensi-danger); box-shadow: none; }
    .absensi-module .admin-bar { display: none; }
    .absensi-module .tab { display: none; }
    .absensi-module .tab.active { display: block; }
    .absensi-module .table-wrap { overflow-x: auto; border-radius: var(--absensi-radius); border: 1.5px solid #d6e4f0; margin-top: 16px; box-shadow: 0 6px 20px rgba(58,141,222,0.05); }
    .absensi-module table { width: 100%; border-collapse: collapse; font-size: 15px; color: var(--absensi-text); min-width: 600px; }
    .absensi-module thead th { position: sticky; top: 0; background: var(--absensi-primary); color: #fff; font-weight: 700; padding: 14px 16px; letter-spacing: 0.03em; z-index: 10; text-align: center; user-select: none; box-shadow: inset 0 -3px 6px rgba(0,0,0,0.1); }
    .absensi-module tbody td { padding: 14px 16px; border-bottom: 1.5px solid #d6e4f0; text-align: center; transition: background var(--transition-speed) ease; }
    .absensi-module tbody tr:hover td { background: #d9eaff; cursor: default; }
    .absensi-module .badge { display: inline-block; padding: 7px 16px; border-radius: 9999px; font-weight: 700; font-size: 13px; user-select: none; transition: background var(--transition-speed) ease, color var(--transition-speed) ease; white-space: nowrap; }
    .absensi-module .badge.on { background: #e9f7ef; color: #1b5e20; border: 1.5px solid #cdebd6; }
    .absensi-module .badge.off { background: #ffebee; color: #b71c1c; border: 1.5px solid #ffcdd2; }
    .absensi-module .badge.pending { background: #fff8e1; color: #f9a825; border: 1.5px solid #ffe082; }
    .absensi-module .btn-mini { padding: 8px 14px; border: none; border-radius: 14px; color: #fff; font-weight: 700; cursor: pointer; transition: filter var(--transition-speed) ease, transform var(--transition-speed) ease; box-shadow: 0 4px 12px rgba(0,0,0,0.12); user-select: none; font-size: 14px; }
    .absensi-module .btn-on { background: var(--absensi-ok); }
    .absensi-module .btn-off { background: var(--absensi-danger); }
    .absensi-module .btn-pending { background: var(--absensi-pending); }
    .absensi-module .btn-on:hover, .absensi-module .btn-off:hover, .absensi-module .btn-pending:hover, .absensi-module .btn-on:focus, .absensi-module .btn-off:focus, .absensi-module .btn-pending:focus { filter: brightness(0.9); transform: translateY(-2px); outline: none; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .absensi-module .login { background: #fff; width: min(92vw, 460px); border-radius: 20px; box-shadow: 0 12px 30px var(--absensi-shadow-light); padding: 28px 32px; text-align: center; user-select: none; }
    .absensi-module .login h3 { color: var(--absensi-primary-dark); margin-bottom: 20px; font-weight: 800; font-size: 1.5rem; letter-spacing: 0.03em; }
    .absensi-module .login input { width: 100%; padding: 14px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; margin: 12px 0; font-size: 1rem; color: var(--absensi-text); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
    .absensi-module .login input:focus { border-color: var(--absensi-primary); box-shadow: 0 0 12px var(--absensi-primary); outline: none; background: #f0f8ff; }
    .absensi-module .login .btn { width: 100%; padding: 14px 0; border: none; border-radius: 14px; background: var(--absensi-primary); color: #fff; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: background var(--transition-speed) ease, box-shadow var(--transition-speed) ease; user-select: none; }
    .absensi-module .login .btn:hover, .absensi-module .login .btn:focus { background: var(--absensi-primary-dark); box-shadow: 0 8px 24px var(--absensi-shadow-strong); outline: none; }
    .absensi-module select { padding: 12px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; min-width: 220px; background: #f8fcff; cursor: pointer; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; font-weight: 600; color: var(--absensi-text); user-select: none; }
    .absensi-module select:hover, .absensi-module select:focus { border-color: var(--absensi-primary); box-shadow: 0 6px 18px rgba(58,141,222,0.25); outline: none; }
    .absensi-module input { width: 100%; padding: 12px 16px; border: 1.5px solid #cfe5f5; border-radius: 14px; background: #f8fcff; color: var(--absensi-text); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; font-size: 1rem; }
    .absensi-module input:focus { border-color: var(--absensi-primary); box-shadow: 0 6px 18px rgba(58,141,222,0.25); outline: none; }
    /* Mobile */
    @media (max-width: 900px) { 
      .grid-3 { grid-template-columns: 1fr; } 
      .line-card, .line-card-tambahan { grid-template-columns: 1fr 80px 120px 100px 80px; padding: 12px 16px; } 
      .cek-ongkir-module .results { grid-template-columns: 1fr; } 
      .absensi-module .topbar, .absensi-module .admin-bar { justify-content: flex-start; } 
      .absensi-module .table-wrap { overflow-x: auto; } 
      .absensi-module table { min-width: 100%; font-size: 14px; } 
      .absensi-module .admin-bar { flex-direction: column; align-items: stretch; }
      .absensi-module .admin-bar .btn { width: 100%; }
    }
    @media (max-width: 600px) { 
      .container { padding: 10px 12px; margin: 12px auto; } 
      .card { padding: 18px 20px; border-radius: 16px; margin-bottom: 16px; } 
      h1 { font-size: clamp(20px, 6vw, 28px); } 
      h2, h3 { font-size: 1.1rem; margin: 6px 0 12px 0; } 
      label { font-size: 13px; margin-top: 10px; } 
      input[type="text"], input[type="password"], input[type="number"], input[type="email"], textarea, select { padding: 10px 12px; border-radius: 10px; font-size: 0.85rem; } 
      .btn { padding: 8px 12px; border-radius: 12px; font-size: 0.8rem; } 
      .btnbar { gap: 6px; flex-direction: column; align-items: stretch; } 
      nav.tab { grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; border-radius: 14px; } 
      nav.tab button { padding: 10px 0; font-size: 0.85rem; border-radius: 12px; } 
      .line-card, .line-card-tambahan { grid-template-columns: 3fr 50px 60px 70px; padding: 10px 12px; gap: 6px; } 
      .nota-box { padding: 14px 16px; font-size: 0.8rem; min-height: 100px; } 
      table { font-size: 0.8rem; } 
      th, td { padding: 8px 6px; } 
      .section-title { font-size: 0.9rem; margin-top: 8px; } 
      .small { font-size: 10px; margin-top: 4px; } 
      .notification-popup { padding: 10px 15px; font-size: 0.8rem; } /* Notifikasi lebih kecil di mobile */
      .cek-ongkir-module .brand { font-size: clamp(16px, 2vw, 18px); } 
      .cek-ongkir-module .headline { font-size: clamp(18px, 2.5vw, 24px); } 
      .absensi-module #pengajuanForm { flex-direction: column; gap: 16px; padding: 16px; } 
      .absensi-module #pengajuanForm select, .absensi-module #pengajuanForm button { min-width: 100% !important; width: 100% !important; } 
      .absensi-module .table-wrap { overflow-x: auto; } 
      .absensi-module table { min-width: 100%; font-size: 13px; } 
      .absensi-module thead th, .absensi-module tbody td { padding: 10px 8px; } 
      .absensi-module .badge { padding: 5px 10px; font-size: 11px; } 
      .absensi-module .btn-mini { padding: 6px 10px; font-size: 12px; } 
      .absensi-module .login { width: 90vw; padding: 20px; } 
      .absensi-module .login input { padding: 10px 12px; font-size: 0.9rem; } 
      .absensi-module .login .btn { padding: 12px 0; font-size: 1rem; } 
    }

    /* Admin Header Golden Style */
    .admin-header {
      background: linear-gradient(90deg, #FFD700, #FFA500); /* Golden gradient */
      color: #333;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-header .flex {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .admin-header .badge {
      background: rgba(255,255,255,0.3);
      color: #663300;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Dashboard Admin -->
  <div id="adminDashboard">
    <header class="admin-header">
      <div class="flex"><strong>📊 Admin Panel</strong><span class="badge">👑 Admin</span></div>
      <button id="adminLogoutBtn" class="btn danger">Logout</button>
    </header>
    <div class="card">
      <nav class="tab" id="adminNavTabs">
        <button data-tab="tabNotaAdmin" class="active">📝 Kelola Nota</button>
        <button data-tab="tabRekapAdmin">📈 Rekap & Riwayat</button>
        <button data-tab="tabKurirAdmin">👥 Manajemen Kurir</button>
        <button data-tab="tabOngkirAdmin">🚚 Manajemen Ongkir</button>
        <button data-tab="tabAbsensiAdmin">✅ Manajemen Absensi</button>
      </nav>
    </div>

    <!-- Kelola Nota Admin -->
    <div id="tabNotaAdmin" class="card tab active">
      <div class="grid grid-2">
        <div><label>Nama Kurir</label><select id="filterKurir"><option value="">— Semua Kurir —</option></select></div>
        <div><label>Tanggal</label><input type="date" id="filterTanggal"></div>
        <div><label>Bulan</label><input type="month" id="filterBulan"></div>
        <div><label>Tahun</label><input type="number" id="filterTahun" min="2020" placeholder="2025"></div>
      </div>
      <div class="grid grid-2" style="margin-top: 12px;">
        <div><label>Cari Nota (No Nota)</label><input id="filterCariNota" list="listNoNota" placeholder="Pilih/ketik No Nota"><datalist id="listNoNota"></datalist></div>
        <div class="btnbar" style="align-self:end">
          <button class="btn secondary" onclick="applyFilter()">Filter</button>
          <button class="btn secondary" onclick="clearFilter()">Reset</button>
          <button class="btn" onclick="showAddEditNotaModal()">+ Tambah Nota</button>
          <button class="btn secondary" onclick="exportCSV()">⬇ Export CSV (hasil filter)</button>
        </div>
      </div>
      <div id="notaList" style="margin-top: 20px;"></div>
    </div>

    <!-- Rekap & Riwayat Admin -->
    <div id="tabRekapAdmin" class="card tab hidden">
      <div class="grid grid-2">
        <div><label>Kurir</label><select id="rekapKurirAdmin"><option value="">— Semua Kurir —</option></select></div>
        <div><label>Bulan</label><input type="month" id="rekapBulanAdmin"></div>
        <div class="btnbar" style="align-self:end"><button class="btn secondary" onclick="renderRekapAdmin()">Terapkan</button></div>
      </div>
      <div class="flex" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <span class="pellet">Mode: Total Nota per Kurir</span>
        <span class="pellet">Mode: Penghasilan (tanggal, jumlah, ongkir, tambahan, total)</span>
      </div>
      <div id="rekapRingkasAdmin" style="margin-top:10px"></div>
      <div id="rekapTabelAdmin" style="margin-top:15px;"></div>
      <div class="btnbar" style="margin-top:15px;"><button class="btn secondary" onclick="exportCSVRekapAdmin()">⬇ Export CSV (Rekap)</button></div>
    </div>

    <!-- Manajemen Kurir Admin -->
    <div id="tabKurirAdmin" class="card tab hidden">
      <div class="grid grid-2" style="gap: 12px;">
        <div>
          <label>Tambah Kurir Baru</label>
          <input id="kurirBaru" placeholder="Nama kurir (username)">
        </div>
        <div>
          <label>Password (kurir)</label>
          <input id="kurirPass" type="password" placeholder="minimal 6 karakter">
        </div>
        <div style="grid-column: span 2;">
          <button class="btn full" onclick="tambahKurirAdmin()">+ Tambah Kurir</button>
          <small style="display: block; margin-top: 8px; color: var(--muted);">Akun dibuat di Realtime DB. (Penghapusan akun Auth penuh memerlukan server admin.)</small>
        </div>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin:20px 0">
      <div class="grid grid-2" style="gap: 12px;">
        <div>
          <label>Pilih Kurir</label>
          <select id="kurirManage"></select>
        </div>
        <div style="align-self:end;">
          <button class="btn danger full" onclick="hapusKurirAdmin()">Hapus Kurir</button>
        </div>
        <div style="grid-column: span 2;">
          <button class="btn secondary full" onclick="ubahPasswordKurirAdmin()">Ubah Password Kurir</button>
        </div>
        <div style="grid-column: span 2;">
          <button class="btn secondary full" onclick="blokirKurirAdmin()">Blokir Kurir</button>
        </div>
        <div style="grid-column: span 2;">
          <button class="btn secondary full" onclick="bukaBlokirKurirAdmin()">Buka Blokir Kurir</button>
        </div>
      </div>
      <small style="display: block; margin-top: 12px; color: var(--muted);">Catatan: Menghapus kurir akan menonaktifkan akses di aplikasi kurir dengan menghapus entri kurir di DB. Blokir/Buka Blokir akan mengubah status 'enabled' kurir.</small>
      <div class="table-wrap" style="margin-top: 20px;">
        <table id="tableKurirAdmin">
          <thead>
            <tr>
              <th>Username</th>
              <th>Password</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <!-- Kurir data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Manajemen Ongkir Admin -->
    <div id="tabOngkirAdmin" class="card tab hidden">
      <div class="grid grid-2">
        <div><label>Wilayah</label><input id="wilayahInput" list="wilayahList" placeholder="Pilih/ketik wilayah"><datalist id="wilayahList"></datalist></div>
        <div><label>Harga Ongkir</label><input id="hargaOngkir" type="number" placeholder="0"></div>
        <div class="btnbar" style="grid-column: span 2;">
          <button class="btn" onclick="simpanOngkirAdmin()">💾 Save/Update</button>
          <button class="btn danger" onclick="hapusOngkirAdmin()">🗑 Hapus</button>
        </div>
      </div>
      <h4 style="margin-top: 20px;">Data Wilayah</h4>
      <div id="ongkirTabel" style="margin-top: 10px;"></div>
    </div>

    <!-- Manajemen Absensi Admin -->
    <div id="tabAbsensiAdmin" class="tabContent hidden absensi-module">
      <div class="card">
        <h1>Manajemen Absensi Kurir</h1>
        <div class="topbar" id="absensiTopbar">
          <button class="btn active" data-tab="tab-jadwal">Jadwal Off</button>
          <button class="btn" data-tab="tab-rekap">Rekap & Keaktifan</button>
          <button class="btn" data-tab="tab-absensi">Absensi Harian</button>
          <button class="btn" data-tab="tab-approval">Approval Kurir</button>
          <div class="month-wrap">
            <label for="monthPick"><small>Bulan:</small></label>
            <input type="month" id="monthPick"/>
          </div>
        </div>

        <div class="admin-bar" id="absensiAdminBar">
          <button class="btn alt" id="btn-save">Save Data (Firestore)</button>
          <button class="btn alt" id="btn-regen">Regenerasi Off</button>
          <button class="btn" id="btn-add-kurir-absensi">Tambah Kurir</button>
          <button class="btn danger" id="btn-del-kurir-absensi">Hapus Kurir</button>
          <button class="btn secondary" id="btn-block-kurir-absensi">Blokir Kurir</button>
          <button class="btn secondary" id="btn-unblock-kurir-absensi">Buka Blokir Kurir</button>
        </div>

        <!-- Tabs Absensi -->
        <div id="tab-jadwal" class="tab active">
          <div class="table-wrap">
            <table id="tableJadwal">
              <thead><tr><th>Tanggal</th><th>Hari</th><th>Kurir Off</th><th>Pengganti</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-absensi" class="tab">
          <div class="table-wrap">
            <table id="tableAbsensi">
              <thead><tr><th>Tanggal</th><th>Nama Kurir</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-rekap" class="tab">
          <div class="table-wrap">
            <table id="tableRekap">
              <thead><tr><th>Nama Kurir</th><th>Total On</th><th>Total Off</th><th>Skor Keaktifan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div id="tab-approval" class="tab">
          <div class="table-wrap">
            <table id="tableApproval">
              <thead><tr><th>Tanggal Pengajuan</th><th>Kurir Asal</th><th>Pengganti</th><th>Status</th><th>Aksi</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pop Notifikasi -->
<div id="notificationPopup" class="notification-popup"></div>
<audio id="notificationSound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>

<!-- Custom Confirm Modal -->
<div id="confirmModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" id="confirmClose">&times;</button>
    <h3 id="confirmTitle">Konfirmasi</h3>
    <p id="confirmMessage">Apakah Anda yakin?</p>
    <div class="modal-actions">
      <button id="confirmYes" class="btn">Ya</button>
      <button id="confirmNo" class="btn secondary">Tidak</button>
    </div>
  </div>
</div>

<!-- Custom Prompt Modal -->
<div id="promptModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" id="promptClose">&times;</button>
    <h3 id="promptTitle">Input Diperlukan</h3>
    <p id="promptMessage">Silakan masukkan nilai:</p>
    <input type="text" id="promptInput" class="full" />
    <div class="modal-actions" style="margin-top: 20px;">
      <button id="promptOk" class="btn">OK</button>
      <button id="promptCancel" class="btn secondary">Batal</button>
    </div>
  </div>
</div>

<!-- Modal Tambah/Edit Nota Admin -->
<div id="addEditNotaModal" class="modal-overlay">
  <div class="modal-content large">
    <button class="modal-close" id="closeNotaModal">&times;</button>
    <h3 id="notaModalTitle">Tambah Nota</h3>
    <div class="grid grid-2">
      <div><label>Kurir (dropdown / ketik manual)</label><input id="modalFormKurir" list="listKurir" placeholder="Pilih/ketik kurir"><datalist id="listKurir"></datalist></div>
      <div><label>No Nota</label><input id="modalFormNoNota" placeholder="NN-001 / otomatis"></div>
    </div>
    <h4 style="margin-top: 15px;">Item</h4>
    <table id="modalItemTable">
      <thead><tr><th>Nama</th><th>Qty</th><th>Harga</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="btnbar" style="justify-content: flex-start; margin-top: 10px;"><button class="btn ghost" onclick="addItemRowModal()">+ Item</button></div>
    <div class="grid grid-2">
      <div><label>Ongkir</label><input id="modalFormOngkir" type="number" value="0"></div>
      <div><label>Tambahan</label><input id="modalFormTambahan" type="number" value="0"></div>
      <div style="grid-column: span 2;"><label>Keterangan</label><input id="modalFormText" placeholder="Catatan…"></div>
    </div>
    <h4 style="margin-top: 15px;">Total: Rp <span id="modalFormTotal">0</span></h4>
    <div class="modal-actions" style="margin-top: 20px;">
      <button class="btn" id="saveNotaModalBtn">Simpan</button>
      <button class="btn danger" id="cancelNotaModalBtn">Batal</button>
    </div>
  </div>
</div>

<!-- Modal Tambah/Edit Kurir Admin -->
<div id="addEditKurirModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" id="closeKurirModal">&times;</button>
    <h3 id="kurirModalTitle">Tambah Kurir</h3>
    <div><label>Username</label><input id="modalKurirUsername" type="text" placeholder="Nama kurir (username)"></div>
    <div><label>Password</label><input id="modalKurirPassword" type="password" placeholder="minimal 6 karakter"></div>
    <div class="modal-actions" style="margin-top: 20px;">
      <button class="btn" id="saveKurirModalBtn">Simpan</button>
      <button class="btn secondary" id="cancelKurirModalBtn">Batal</button>
    </div>
  </div>
</div>

<!-- Modal Tambah/Edit Ongkir Admin -->
<div id="addEditOngkirModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" id="closeOngkirModal">&times;</button>
    <h3 id="ongkirModalTitle">Tambah Ongkir</h3>
    <div><label>Wilayah</label><input id="modalWilayahInput" type="text" placeholder="Nama Wilayah"></div>
    <div><label>Harga Ongkir</label><input id="modalHargaOngkir" type="number" placeholder="0"></div>
    <div class="modal-actions" style="margin-top: 20px;">
      <button class="btn" id="saveOngkirModalBtn">Simpan</button>
      <button class="btn secondary" id="cancelOngkirModalBtn">Batal</button>
    </div>
  </div>
</div>


<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, set, get, onValue, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Firebase config Anda
  const firebaseConfig = {
    apiKey: "AIzaSyCtva8TeL40-WotK4kFL_vL8uUXL3GDfww",
    authDomain: "sahabatkuu-bisa.firebaseapp.com",
    databaseURL: "https://sahabatkuu-bisa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sahabatkuu-bisa",
    storageBucket: "sahabatkuu-bisa.firebasestorage.app",
    messagingSenderId: "315555564115",
    appId: "1:315555564115:web:56f46dbceb8c154589d4a6",
    measurementId: "G-PFGYL96VPS"
  };

  // Inisialisasi Firebase Apps
  const app = initializeApp(firebaseConfig, "mainApp"); 
  const db = getDatabase(app); // Realtime Database
  const auth = getAuth(app); // Authentication
  const firestoreDb = getFirestore(app); // Firestore (untuk absensi)

  try { getAnalytics(app); } catch(e) {} // Optional analytics

  // UID Admin
  const ADMIN_UID = "kSW4ThusrwhUFCQeTsnPV1VNaR72"; 

  // ====================================================================
  // Helper Functions (UI & Notifikasi)
  // ====================================================================
  const el = (id) => document.getElementById(id);
  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
  const money = (n) => (Number(n) || 0).toLocaleString('id-ID');
  const leftPad = (num, len = 5) => String(num).padStart(len, '0');

  function showNotification(message, type = 'success') {
    const popup = el('notificationPopup');
    popup.textContent = message;
    popup.className = `notification-popup show ${type}`;
    el('notificationSound').play();
    setTimeout(() => {
      popup.classList.remove('show');
    }, 3000);
  }

  // Custom Confirm Modal
  function showConfirmModal(title, message) {
    return new Promise((resolve) => {
      const modal = el('confirmModal');
      el('confirmTitle').textContent = title;
      el('confirmMessage').textContent = message;

      const onYes = () => {
        modal.classList.remove('show');
        el('confirmYes').removeEventListener('click', onYes);
        el('confirmNo').removeEventListener('click', onNo);
        el('confirmClose').removeEventListener('click', onNo);
        resolve(true);
      };

      const onNo = () => {
        modal.classList.remove('show');
        el('confirmYes').removeEventListener('click', onYes);
        el('confirmNo').removeEventListener('click', onNo);
        el('confirmClose').removeEventListener('click', onNo);
        resolve(false);
      };

      el('confirmYes').addEventListener('click', onYes);
      el('confirmNo').addEventListener('click', onNo);
      el('confirmClose').addEventListener('click', onNo);
      modal.classList.add('show');
    });
  }

  // Custom Prompt Modal
  function showPromptModal(title, message, defaultValue = '') {
    return new Promise((resolve) => {
      const modal = el('promptModal');
      el('promptTitle').textContent = title;
      el('promptMessage').textContent = message;
      const input = el('promptInput');
      input.value = defaultValue;

      const onOk = () => {
        modal.classList.remove('show');
        el('promptOk').removeEventListener('click', onOk);
        el('promptCancel').removeEventListener('click', onCancel);
        el('promptClose').removeEventListener('click', onCancel);
        resolve(input.value);
      };

      const onCancel = () => {
        modal.classList.remove('show');
        el('promptOk').removeEventListener('click', onOk);
        el('promptCancel').removeEventListener('click', onCancel);
        el('promptClose').removeEventListener('click', onCancel);
        resolve(null);
      };

      el('promptOk').addEventListener('click', onOk);
      el('promptCancel').addEventListener('click', onCancel);
      el('promptClose').addEventListener('click', onCancel);
      modal.classList.add('show');
      input.focus();
    });
  }

  function setActiveTab(tabContainerId, tabId) {
    qsa(`#${tabContainerId} button`).forEach(b => {
      b.classList.toggle('active', b.dataset.tab === tabId);
    });
    const parentContainer = el(tabContainerId).closest('.tab-container') || el(tabContainerId).parentNode; 
    qsa('.tab', parentContainer).forEach(t => t.classList.add('hidden')); // Changed from .tabContent to .tab
    el(tabId).classList.remove('hidden');

    // Trigger specific refresh for tabs
    if (tabId === 'tabNotaAdmin') loadAllAdminData(); // Refresh admin nota
    if (tabId === 'tabRekapAdmin') renderRekapAdmin(); // Refresh admin rekap
    if (tabId === 'tabKurirAdmin') fillKurirManageAdmin(); // Refresh admin kurir
    if (tabId === 'tabOngkirAdmin') setupOngkirRealtimeAdmin(); // Refresh admin ongkir
    if (tabId === 'tabAbsensiAdmin') absensiQuickSync(); // Refresh absensi
  }

  // ====================================================================
  // Admin Dashboard Setup
  // ====================================================================
  // Check admin login status
  onAuthStateChanged(auth, (user) => {
    if (!user || user.uid !== ADMIN_UID) {
      window.location.href = 'index.html'; // Redirect to login if not admin
    } else {
      loadAllAdminData();
      listenMasterKurirAbsensi(); // Start listening for absensi data
      listenPengajuanAbsensi(); // Start listening for absensi approvals
      listenJadwalAbsensi(el('monthPick').value); // Initial load for absensi
    }
  });

  el('adminLogoutBtn').addEventListener('click', doAdminLogout);

  async function doAdminLogout() {
    if (!await showConfirmModal('Logout', 'Yakin ingin logout sebagai Admin?')) return;
    try {
      await signOut(auth); 
      localStorage.removeItem('isAdminLoggedIn'); // Clear flag
      window.location.href = 'index.html'; // Redirect to initial login
      showNotification('Admin telah logout.', 'info');
    } catch (error) {
      console.error("Admin logout error:", error);
      showNotification('Gagal logout Admin!', 'error');
    }
  }

  let allDataAdmin = {}; // {kurir:{id:nota}}
  let kurirSetAdmin = new Set();
  let kurirDetailsAdmin = {}; // {username: {password, enabled}}
  let ongkirDataAdmin = {};
  let editingNotaAdmin = null; // {user,id,createdAt}

  async function loadAllAdminData() {
    await Promise.all([loadNotaAdmin(), loadKurirAdmin(), setupOngkirRealtimeAdmin()]);
    buildNoNotaDatalistAdmin();
    renderListAdmin(allDataAdmin);
    fillRekapKurirAdmin();
  }

  // ====================================================================
  // Admin Dashboard: Loaders
  // ====================================================================
  async function loadNotaAdmin() {
    const snap = await get(ref(db, 'nota'));
    allDataAdmin = snap.exists() ? snap.val() : {};
    Object.keys(allDataAdmin).forEach(k => kurirSetAdmin.add(k));
    fillKurirFilterAdmin();
  }

  async function loadKurirAdmin() {
    const snap = await get(ref(db, 'kurir'));
    if (snap.exists()) {
      const obj = snap.val();
      kurirDetailsAdmin = obj; // Store full details
      Object.keys(obj).forEach(k => kurirSetAdmin.add(k));
    }
    fillKurirFilterAdmin();
    fillKurirManageAdmin();
    fillKurirDatalistAdmin();
    renderKurirTableAdmin(); // Render the table
  }

  // ====================================================================
  // Admin Dashboard: Kelola Nota
  // ====================================================================
  function fillKurirFilterAdmin() {
    const sel = el('filterKurir');
    sel.innerHTML = '<option value="">— Semua Kurir —</option>' + [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  function fillKurirManageAdmin() {
    const selectEl = el('kurirManage');
    selectEl.innerHTML = [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  function fillKurirDatalistAdmin() {
    el('listKurir').innerHTML = [...kurirSetAdmin].sort().map(k => `<option value="${k}">`).join('');
  }

  function buildNoNotaDatalistAdmin() {
    const list = el('listNoNota');
    list.innerHTML = '';
    const uniqueNoNotas = new Set();
    Object.values(allDataAdmin).forEach(notes => {
      Object.values(notes).forEach(n => {
        if (n.noNota) { uniqueNoNotas.add(n.noNota); }
      });
    });
    Array.from(uniqueNoNotas).sort().forEach(no => {
      const opt = document.createElement('option');
      opt.value = no;
      list.appendChild(opt);
    });
  }

  function withinFiltersAdmin(n) {
    const fK = el('filterKurir').value;
    const fD = el('filterTanggal').value; // YYYY-MM-DD
    const fM = el('filterBulan').value; // YYYY-MM
    const fY = el('filterTahun').value; // YYYY

    if (fK && n.kurir !== fK) return false;
    if (fD && (n.createdAt || '').slice(0, 10) !== fD) return false;
    if (fM && (n.createdAt || '').slice(0, 7) !== fM) return false;
    if (fY && (n.createdAt || '').slice(0, 4) !== fY) return false;
    return true;
  }

  window.applyFilter = () => {
    const cariNota = el('filterCariNota').value.trim();
    let filteredData = {};

    if (cariNota) {
      Object.entries(allDataAdmin).forEach(([k, notes]) => {
        Object.values(notes).forEach(n => {
          if ((n.noNota || '') === cariNota) {
            if (!filteredData[k]) filteredData[k] = {};
            filteredData[k][n.id] = n;
          }
        });
      });
    } else {
      Object.entries(allDataAdmin).forEach(([k, notes]) => {
        Object.values(notes).forEach(n => {
          if (withinFiltersAdmin(n)) {
            if (!filteredData[k]) filteredData[k] = {};
            filteredData[k][n.id] = n;
          }
        });
      });
    }
    renderListAdmin(filteredData);
    showNotification('Filter diterapkan.', 'info');
  };

  window.clearFilter = () => {
    el('filterKurir').value = '';
    el('filterTanggal').value = '';
    el('filterBulan').value = '';
    el('filterTahun').value = '';
    el('filterCariNota').value = '';
    renderListAdmin(allDataAdmin);
    showNotification('Filter direset.', 'info');
  };

  function renderListAdmin(data) {
    const wrap = el('notaList');
    wrap.innerHTML = '';
    if (!Object.keys(data || {}).length) { wrap.innerHTML = '<i>Tidak ada data</i>'; return; }
    Object.entries(data).forEach(([user, notes]) => {
      const card = document.createElement('div');
      card.className = 'card';
      const totalUser = Object.values(notes || {}).reduce((s, n) => {
        const tambahanNominal = n.tambahans ? Object.values(n.tambahans).reduce((s2, t) => s2 + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0);
        return s + (Number(n.ongkir) || 0) + tambahanNominal;
      }, 0);

      card.innerHTML = `<h3>Kurir: ${user} — Total: Rp ${money(totalUser)}</h3>`;
      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr><th>No Nota</th><th>Tanggal</th><th>Ongkir</th><th>Tambahan</th><th>Total</th><th>Aksi</th></tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      Object.values(notes || {}).sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || '')).forEach(n => {
        const tr = document.createElement('tr');
        const totalNota = (Number(n.ongkir) || 0) + (n.tambahans ? Object.values(n.tambahans).reduce((s, t) => s + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0));
        tr.innerHTML = `<td>${n.noNota || ''}</td>
                        <td>${n.createdAt ? new Date(n.createdAt).toLocaleString('id-ID') : '-'}</td>
                        <td>Rp ${money(n.ongkir || 0)}</td>
                        <td>Rp ${money(n.tambahans ? Object.values(n.tambahans).reduce((s, t) => s + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0))}</td>
                        <td><b>Rp ${money(totalNota)}</b></td>
                        <td class="btnbar">
                          <button class="btn secondary" onclick="viewNotaAdmin('${user}','${n.id}')">👁 Lihat</button>
                          <button class="btn" onclick="showAddEditNotaModal('${user}','${n.id}')">✏️ Edit</button>
                          <button class="btn danger" onclick="delNotaAdmin('${user}','${n.id}')">🗑 Hapus</button>
                        </td>`;
        tb.appendChild(tr);
      });
      card.appendChild(tbl);
      wrap.appendChild(card);
    });
  }

  // Modal Tambah/Edit Nota
  const addEditNotaModal = el('addEditNotaModal');
  const modalFormKurir = el('modalFormKurir');
  const modalFormNoNota = el('modalFormNoNota');
  const modalItemTableBody = qs('#modalItemTable tbody');
  const modalFormOngkir = el('modalFormOngkir');
  const modalFormTambahan = el('modalFormTambahan');
  const modalFormText = el('modalFormText');
  const modalFormTotal = el('modalFormTotal');
  const notaModalTitle = el('notaModalTitle');

  el('closeNotaModal').addEventListener('click', () => addEditNotaModal.classList.remove('show'));
  el('cancelNotaModalBtn').addEventListener('click', () => addEditNotaModal.classList.remove('show'));
  el('saveNotaModalBtn').addEventListener('click', saveNotaModal);

  window.showAddEditNotaModal = async (user = null, id = null) => {
    editingNotaAdmin = null;
    notaModalTitle.innerText = 'Tambah Nota';
    modalFormKurir.value = '';
    modalFormNoNota.value = '';
    modalFormOngkir.value = 0;
    modalFormTambahan.value = 0;
    modalFormText.value = '';
    modalItemTableBody.innerHTML = '';
    addItemRowModal();
    modalFormTotal.innerText = '0';
    fillKurirDatalistAdmin();

    if (user && id) {
      const snap = await get(ref(db, `nota/${user}/${id}`));
      if (!snap.exists()) { showNotification('Nota tidak ditemukan', 'error'); return; }
      const n = snap.val();
      editingNotaAdmin = { id, createdAt: n.createdAt };
      notaModalTitle.innerText = 'Edit Nota';
      modalFormKurir.value = user;
      modalFormNoNota.value = n.noNota || '';
      modalFormOngkir.value = n.ongkir || 0;
      modalFormTambahan.value = n.tambahans && n.tambahans.length > 0 ? n.tambahans[0].nominal : (n.tambahan || 0); // Simplified for single manual tambahan
      modalFormText.value = n.text || '';
      (n.items || []).forEach(it => addItemRowModal(it.nama, it.qty, it.harga));
      calcTotalModal();
    }
    addEditNotaModal.classList.add('show');
  };

  window.addItemRowModal = (nama = '', qty = 1, harga = 0) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="iname" value="${nama}"></td>
                    <td><input class="iqty" type="number" value="${qty}"></td>
                    <td><input class="iprice" type="number" value="${harga}"></td>
                    <td><button class="btn danger mini-btn" onclick="this.closest('tr').remove();calcTotalModal()">✖</button></td>`;
    modalItemTableBody.appendChild(tr);
    tr.querySelectorAll('input').forEach(i => i.addEventListener('input', calcTotalModal));
    calcTotalModal();
  };

  function calcTotalModal() {
    let total = 0;
    qsa('#modalItemTable tbody tr').forEach(tr => {
      const q = Number(tr.querySelector('.iqty').value) || 0;
      const h = Number(tr.querySelector('.iprice').value) || 0;
      total += q * h;
    });
    total += Number(modalFormOngkir.value || 0);
    total += Number(modalFormTambahan.value || 0);
    modalFormTotal.innerText = money(total);
  }
  modalFormOngkir.addEventListener('input', calcTotalModal);
  modalFormTambahan.addEventListener('input', calcTotalModal);

  async function saveNotaModal() {
    const user = modalFormKurir.value.trim();
    if (!user) { showNotification('Isi nama kurir', 'warning'); return; }
    const noNota = modalFormNoNota.value.trim() || ('NN-' + Date.now().toString().slice(-6));
    const items = qsa('#modalItemTable tbody tr').map(tr => ({
      nama: tr.querySelector('.iname').value,
      qty: Number(tr.querySelector('.iqty').value) || 0,
      harga: Number(tr.querySelector('.iprice').value) || 0,
    }));
    const ongkir = Number(modalFormOngkir.value) || 0;
    const tambahanNominal = Number(modalFormTambahan.value) || 0;
    const tambahans = tambahanNominal > 0 ? [{ nominal: tambahanNominal, type: "Tambahan Manual" }] : [];
    const text = modalFormText.value || '';
    const total = items.reduce((s, it) => s + it.qty * it.harga, 0) + ongkir + tambahans.reduce((s, t) => s + (Number(t.nominal) || 0), 0);
    let id, createdAt;
    if (editingNotaAdmin) { id = editingNotaAdmin.id; createdAt = editingNotaAdmin.createdAt; } else { id = 'nota_' + Date.now(); createdAt = new Date().toISOString(); }

    const data = { id, kurir: user, noNota, createdAt, items, ongkir, tambahans, total, text };
    try {
      await set(ref(db, `nota/${user}/${id}`), data);
      // Ensure kurir exists and is enabled in Realtime DB
      await set(ref(db, `kurir/${user}`), { username: user, enabled: true, password: kurirDetailsAdmin[user]?.password || 'default_password' }); 
      kurirSetAdmin.add(user);
      await loadNotaAdmin();
      buildNoNotaDatalistAdmin();
      renderListAdmin(allDataAdmin);
      addEditNotaModal.classList.remove('show');
      showNotification('Nota disimpan.', 'success');
    } catch (error) {
      console.error("Error saving nota admin:", error);
      showNotification('Gagal menyimpan nota: ' + error.message, 'error');
    }
  }

  window.delNotaAdmin = async (user, id) => {
    if (!await showConfirmModal('Hapus Nota', 'Hapus nota ini?')) return;
    try {
      const notaRef = ref(db, `nota/${user}/${id}`);
      const notaSnap = await get(notaRef);
      const notaData = notaSnap.val();

      await remove(notaRef);
      if (notaData && notaData.noNota) {
        await remove(ref(db, `pelacakByNo/${notaData.noNota}/${id}`));
        const keyDate = notaData.createdAt.slice(0, 10);
        await remove(ref(db, `pelacakByDate/${keyDate}/${id}`));
        // Decrement counter for the specific user
        await runTransaction(ref(db, `counters/${user}/lastNoNota`), (currentValue) => {
          return (currentValue || 0) > 0 ? (currentValue || 0) - 1 : 0;
        });
      }
      await loadNotaAdmin();
      renderListAdmin(allDataAdmin);
      showNotification('Nota dihapus.', 'info');
    } catch (error) {
      console.error("Error deleting nota admin:", error);
      showNotification('Gagal menghapus nota: ' + error.message, 'error');
    }
  };

  window.viewNotaAdmin = (user, id) => {
    const n = allDataAdmin?.[user]?.[id];
    if (!n) return;
    const w = window.open('', '_blank');
    w.document.write('<title>Nota ' + (n.noNota || '') + '</title><pre style="font-family:ui-monospace,Consolas,monospace">' + JSON.stringify(n, null, 2) + '</pre>');
    w.document.close();
  };

  window.exportCSV = () => {
    const rows = [["Kurir", "No Nota", "Tanggal", "Ongkir", "Tambahan", "Total"]];
    const cards = qsa('#notaList .card');
    cards.forEach(card => {
      const title = card.querySelector('h3')?.innerText || '';
      const user = title.replace(/^Kurir:\s*/, '').split(' — ')[0];
      card.querySelectorAll('tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        rows.push([user, tds[0].innerText, tds[1].innerText, tds[2].innerText.replace('Rp ', '').replaceAll('.', ''), tds[3].innerText.replace('Rp ', '').replaceAll('.', ''), tds[4].innerText.replace('Rp ', '').replaceAll('.', '')]);
      });
    });
    downloadCSV(rows, 'nota_filtered.csv');
    showNotification('Data nota diekspor ke CSV.', 'success');
  };

  // ====================================================================
  // Admin Dashboard: Rekap & Riwayat
  // ====================================================================
  function fillRekapKurirAdmin() {
    const sel = el('rekapKurirAdmin');
    sel.innerHTML = '<option value="">— Semua Kurir —</option>' + [...kurirSetAdmin].sort().map(k => `<option>${k}</option>`).join('');
  }

  window.renderRekapAdmin = async () => {
    const k = el('rekapKurirAdmin').value;
    const m = el('rekapBulanAdmin').value; // YYYY-MM

    let rows = [];
    let total = 0;
    let count = 0;
    let totOngkir = 0;
    let totTambahan = 0;

    const push = (n) => {
      const dt = n.createdAt ? new Date(n.createdAt).toLocaleDateString('id-ID') : '-';
      const tambahanSum = n.tambahans ? Object.values(n.tambahans).reduce((s2, t) => s2 + (Number(t.nominal) || 0), 0) : (Number(n.tambahan) || 0);
      const totalNota = (Number(n.ongkir) || 0) + tambahanSum;

      rows.push([dt, n.noNota || '', n.ongkir || 0, tambahanSum, totalNota]);
      count++;
      total += totalNota;
      totOngkir += (Number(n.ongkir) || 0);
      totTambahan += tambahanSum;
    };

    if (k) {
      const notes = allDataAdmin[k] || {};
      Object.values(notes).forEach(n => {
        if (m) { if ((n.createdAt || '').slice(0, 7) !== m) return; }
        push(n);
      });
    } else {
      Object.values(allDataAdmin).forEach(notes => {
        Object.values(notes).forEach(n => {
          if (m) { if ((n.createdAt || '').slice(0, 7) !== m) return; }
          push(n);
        });
      });
    }

    el('rekapRingkasAdmin').innerHTML = `<div class="card">
      <b>Jumlah Nota:</b> ${count} &nbsp; | &nbsp; <b>Total Ongkir:</b> Rp ${money(totOngkir)}
      &nbsp; | &nbsp; <b>Total Tambahan:</b> Rp ${money(totTambahan)} &nbsp; | &nbsp; <b>Total Penghasilan:</b> Rp ${money(total)}
    </div>`;

    const thead = '<thead><tr><th>Tanggal</th><th>No Nota</th><th>Ongkir</th><th>Tambahan</th><th>Total</th></tr></thead>';
    const tbody = '<tbody>' + rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>Rp ${money(r[2])}</td><td>Rp ${money(r[3])}</td><td><b>Rp ${money(r[4])}</b></td></tr>`).join('') + '</tbody>';
    el('rekapTabelAdmin').innerHTML = `<table>${thead}${tbody}</table>`;
    showNotification('Rekap dimuat.', 'info');
  };

  window.exportCSVRekapAdmin = () => {
    const rows = [["Tanggal", "No Nota", "Ongkir", "Tambahan", "Total"]];
    el('rekapTabelAdmin').querySelectorAll('tbody tr').forEach(tr => {
      const t = tr.querySelectorAll('td');
      rows.push([t[0].innerText, t[1].innerText, t[2].innerText.replace('Rp ', '').replaceAll('.', ''), t[3].innerText.replace('Rp ', '').replaceAll('.', ''), t[4].innerText.replace('Rp ', '').replaceAll('.', '')]);
    });
    downloadCSV(rows, 'rekap.csv');
    showNotification('Data rekap diekspor ke CSV.', 'success');
  };

  // ====================================================================
  // Admin Dashboard: Manajemen Kurir
  // ====================================================================
  function renderKurirTableAdmin() {
    const tbody = qs('#tableKurirAdmin tbody');
    tbody.innerHTML = '';
    const sortedKurir = Array.from(kurirSetAdmin).sort();

    sortedKurir.forEach(uname => {
      const details = kurirDetailsAdmin[uname] || { password: 'N/A', enabled: false };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${uname}</td>
        <td>${details.password}</td>
        <td><span class="badge ${details.enabled ? 'on' : 'off'}">${details.enabled ? 'Aktif' : 'Blokir'}</span></td>
        <td>
          <button class="btn-mini secondary" onclick="showAddEditKurirModal('${uname}')">Ubah</button>
          <button class="btn-mini ${details.enabled ? 'danger' : 'on'}" onclick="${details.enabled ? `blokirKurirAdmin('${uname}')` : `bukaBlokirKurirAdmin('${uname}')`}">${details.enabled ? 'Blokir' : 'Buka Blokir'}</button>
          <button class="btn-mini danger" onclick="hapusKurirAdminTable('${uname}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Modal Tambah/Edit Kurir
  const addEditKurirModal = el('addEditKurirModal');
  const modalKurirUsername = el('modalKurirUsername');
  const modalKurirPassword = el('modalKurirPassword');
  const kurirModalTitle = el('kurirModalTitle');
  let editingKurirUsername = null;

  el('closeKurirModal').addEventListener('click', () => addEditKurirModal.classList.remove('show'));
  el('cancelKurirModalBtn').addEventListener('click', () => addEditKurirModal.classList.remove('show'));
  el('saveKurirModalBtn').addEventListener('click', saveKurirModal);

  window.showAddEditKurirModal = async (uname = null) => {
    editingKurirUsername = uname;
    kurirModalTitle.innerText = 'Tambah Kurir';
    modalKurirUsername.value = '';
    modalKurirPassword.value = '';
    modalKurirUsername.readOnly = false; // Enable editing for new kurir

    if (uname) {
      kurirModalTitle.innerText = 'Edit Kurir';
      modalKurirUsername.value = uname;
      modalKurirUsername.readOnly = true; // Disable editing username for existing kurir
      const details = kurirDetailsAdmin[uname];
      if (details) {
        modalKurirPassword.value = details.password;
      }
    }
    addEditKurirModal.classList.add('show');
  };

  async function saveKurirModal() {
    const uname = modalKurirUsername.value.trim();
    const pass = modalKurirPassword.value.trim();
    if (!uname || pass.length < 6) { showNotification('Isi username & password min 6 karakter', 'warning'); return; }

    try {
      if (editingKurirUsername) { // Edit existing kurir
        await update(ref(db, 'kurir/' + uname), { password: pass });
        kurirDetailsAdmin[uname].password = pass;
        showNotification('Password kurir berhasil diubah.', 'success');
      } else { // Add new kurir
        const snap = await get(ref(db, 'kurir/' + uname));
        if (snap.exists()) { showNotification('Kurir dengan username ini sudah ada!', 'warning'); return; }

        await set(ref(db, 'kurir/' + uname), {
          username: uname,
          password: pass,
          enabled: true,
          createdAt: new Date().toISOString()
        });
        kurirSetAdmin.add(uname);
        kurirDetailsAdmin[uname] = { username: uname, password: pass, enabled: true };
        // Also update absensi kurir list
        kurirListAbsensi.push(uname);
        await setDoc(doc(firestoreDb, 'appdata', 'master'), { kurirList: kurirListAbsensi }, { merge: true });
        showNotification('Kurir ditambahkan: ' + uname, 'success');
      }
      fillKurirFilterAdmin();
      fillKurirManageAdmin();
      fillKurirDatalistAdmin();
      renderKurirTableAdmin();
      addEditKurirModal.classList.remove('show');
    } catch (error) {
      console.error("Error saving kurir:", error);
      showNotification('Gagal menyimpan kurir: ' + error.message, 'error');
    }
  }

  window.tambahKurirAdmin = () => showAddEditKurirModal(); // Use modal for adding
  window.ubahPasswordKurirAdmin = () => showAddEditKurirModal(el('kurirManage').value); // Use modal for changing password

  window.hapusKurirAdmin = async () => {
    const uname = el('kurirManage').value;
    if (!uname) return showNotification('Pilih kurir yang akan dihapus.', 'warning');
    hapusKurirAdminTable(uname);
  };

  window.hapusKurirAdminTable = async (uname) => {
    if (!await showConfirmModal('Hapus Kurir', `Hapus kurir "${uname}"? Ini akan menghapus akses login dan data kurir ini.`)) return;

    try {
      await remove(ref(db, 'kurir/' + uname));
      kurirSetAdmin.delete(uname);
      delete kurirDetailsAdmin[uname]; // Remove from local cache
      fillKurirFilterAdmin();
      fillKurirManageAdmin();
      fillKurirDatalistAdmin();
      renderKurirTableAdmin(); // Refresh the table
      // Also update absensi kurir list
      kurirListAbsensi = kurirListAbsensi.filter(k => k !== uname);
      await setDoc(doc(firestoreDb, 'appdata', 'master'), { kurirList: kurirListAbsensi }, { merge: true });
      showNotification('Kurir dihapus.', 'info');
    } catch (error) {
      console.error("Error deleting kurir:", error);
      showNotification('Gagal menghapus kurir: ' + error.message, 'error');
    }
  };

  window.blokirKurirAdmin = async (uname = el('kurirManage').value) => {
    if (!uname) return showNotification('Pilih kurir dulu.', 'warning');
    if (!await showConfirmModal('Blokir Kurir', `Yakin ingin memblokir kurir "${uname}"? Ini akan mencegahnya login.`)) return;

    try {
      await update(ref(db, 'kurir/' + uname), { enabled: false });
      kurirDetailsAdmin[uname].enabled = false; // Update local cache
      renderKurirTableAdmin(); // Refresh the table
      showNotification(`Kurir ${uname} diblokir.`, 'info');
    } catch (error) {
      console.error("Error blocking kurir:", error);
      showNotification('Gagal memblokir kurir: ' + error.message, 'error');
    }
  };

  window.bukaBlokirKurirAdmin = async (uname = el('kurirManage').value) => {
    if (!uname) return showNotification('Pilih kurir dulu.', 'warning');
    if (!await showConfirmModal('Buka Blokir Kurir', `Yakin ingin membuka blokir kurir "${uname}"?`)) return;

    try {
      await update(ref(db, 'kurir/' + uname), { enabled: true });
      kurirDetailsAdmin[uname].enabled = true; // Update local cache
      renderKurirTableAdmin(); // Refresh the table
      showNotification(`Kurir ${uname} dibuka blokirnya.`, 'info');
    } catch (error) {
      console.error("Error unblocking kurir:", error);
      showNotification('Gagal membuka blokir kurir: ' + error.message, 'error');
    }
  };

  // ====================================================================
  // Admin Dashboard: Manajemen Ongkir
  // ====================================================================
  let ongkirDataAdminRealtime = {}; // Data ongkir dari Realtime DB

  function setupOngkirRealtimeAdmin() {
    const ongkirRef = ref(db, 'daftar_ongkir');
    onValue(ongkirRef, (snap) => {
      ongkirDataAdminRealtime = snap.exists() ? snap.val() : {};
      renderOngkirAdmin();
      fillWilayahDatalistAdmin();
    });
  }

  function renderOngkirAdmin() {
    const div = el('ongkirTabel');
    const rows = Object.entries(ongkirDataAdminRealtime || {}).sort((a, b) => a[1].wilayah.localeCompare(b[1].wilayah));
    if (!rows.length) { div.innerHTML = '<i>Belum ada wilayah.</i>'; return; }

    const thead = '<thead><tr><th>Wilayah</th><th>Ongkir</th><th>Aksi</th></tr></thead>';
    const tbody = '<tbody>' + rows.map(([k, v]) => `
      <tr>
        <td>${v.wilayah}</td>
        <td>${money(v.ongkir)}</td>
        <td class="btnbar">
          <button class="btn-mini secondary" onclick="showAddEditOngkirModal('${v.wilayah}', ${v.ongkir})">Edit</button>
          <button class="btn-mini danger" onclick="deleteOngkirRowAdmin('${v.wilayah}')">Hapus</button>
        </td>
      </tr>`).join('') + '</tbody>';

    div.innerHTML = `<table>${thead}${tbody}</table>`;
  }

  function fillWilayahDatalistAdmin() {
    const dl = el('wilayahList');
    dl.innerHTML = Object.values(ongkirDataAdminRealtime || {}).sort((a, b) => a.wilayah.localeCompare(b.wilayah))
      .map(v => `<option value="${v.wilayah}">`).join('');
  }

  // Modal Tambah/Edit Ongkir
  const addEditOngkirModal = el('addEditOngkirModal');
  const modalWilayahInput = el('modalWilayahInput');
  const modalHargaOngkir = el('modalHargaOngkir');
  const ongkirModalTitle = el('ongkirModalTitle');
  let editingOngkirWilayah = null;

  el('closeOngkirModal').addEventListener('click', () => addEditOngkirModal.classList.remove('show'));
  el('cancelOngkirModalBtn').addEventListener('click', () => addEditOngkirModal.classList.remove('show'));
  el('saveOngkirModalBtn').addEventListener('click', saveOngkirModal);

  window.showAddEditOngkirModal = (wilayah = null, harga = 0) => {
    editingOngkirWilayah = wilayah;
    ongkirModalTitle.innerText = 'Tambah Ongkir';
    modalWilayahInput.value = '';
    modalHargaOngkir.value = 0;
    modalWilayahInput.readOnly = false;

    if (wilayah) {
      ongkirModalTitle.innerText = 'Edit Ongkir';
      modalWilayahInput.value = wilayah;
      modalHargaOngkir.value = harga;
      modalWilayahInput.readOnly = true; // Prevent changing wilayah name
    }
    addEditOngkirModal.classList.add('show');
  };

  async function saveOngkirModal() {
    const w = modalWilayahInput.value.trim();
    const h = Number(modalHargaOngkir.value || 0);
    if (!w) { showNotification('Isi wilayah', 'warning'); return; }
    if (isNaN(h)) { showNotification('Harga ongkir harus angka.', 'warning'); return; }

    try {
      if (editingOngkirWilayah) { // Edit existing
        await set(ref(db, 'daftar_ongkir/' + w), { wilayah: w, ongkir: h });
        showNotification(`Ongkir wilayah "${w}" berhasil diperbarui.`, 'success');
      } else { // Add new
        const existing = Object.values(ongkirDataAdminRealtime).find(item => item.wilayah === w);
        if (existing) { showNotification('Wilayah ini sudah ada, gunakan tombol edit.', 'warning'); return; }
        await set(ref(db, 'daftar_ongkir/' + w), { wilayah: w, ongkir: h });
        showNotification(`Ongkir wilayah "${w}" berhasil disimpan.`, 'success');
      }
      addEditOngkirModal.classList.remove('show');
    } catch (error) {
      console.error("Error saving ongkir:", error);
      showNotification('Gagal menyimpan ongkir: ' + error.message, 'error');
    }
  }

  window.simpanOngkirAdmin = () => showAddEditOngkirModal(); // Use modal for adding

  window.hapusOngkirAdmin = async () => {
    const namaWilayah = el('wilayahInput').value.trim();
    if (!namaWilayah) return showNotification('Pilih wilayah', 'warning');
    deleteOngkirRowAdmin(namaWilayah);
  };

  window.deleteOngkirRowAdmin = async (namaWilayah) => {
    if (!await showConfirmModal('Hapus Wilayah Ongkir', `Hapus wilayah "${namaWilayah}"?`)) return;

    try {
      await remove(ref(db, 'daftar_ongkir/' + namaWilayah)); // Assuming key is wilayah name
      showNotification('Wilayah dihapus.', 'info');
    } catch (error) {
      console.error("Error deleting ongkir:", error);
      showNotification('Gagal menghapus wilayah: ' + error.message, 'error');
    }
  };

  // ====================================================================
  // Admin Dashboard: Manajemen Absensi
  // ====================================================================
  const MASTER_DOC = collection(firestoreDb, 'appdata');
  const JADWAL_COLLECTION = collection(firestoreDb, 'jadwal_off');
  const PENGAJUAN_COLLECTION = collection(firestoreDb, 'pengajuan_off');

  let kurirListAbsensi = []; // This will be loaded from Firestore
  let jadwalDataAbsensi = {};
  let unsubJadwalAbsensi = null;
  let pengajuanCacheAbsensi = [];
  const idDays = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

  const absensiMonthPick = el('monthPick');
  absensiMonthPick.value = new Date().toISOString().slice(0, 7);

  // Absensi Admin Actions
  const btnAddKurirAbsensi = el('btn-add-kurir-absensi');
  const btnDelKurirAbsensi = el('btn-del-kurir-absensi');
  const btnBlockKurirAbsensi = el('btn-block-kurir-absensi');
  const btnUnblockKurirAbsensi = el('btn-unblock-kurir-absensi');
  const btnRegenAbsensi = el('btn-regen');
  const btnSaveAbsensi = el('btn-save');

  // Absensi Tabs
  qsa('#absensiTopbar .btn[data-tab]').forEach(b => {
    b.onclick = () => {
      qsa('#tabAbsensiAdmin .tab').forEach(t => t.classList.remove('active'));
      qsa('#absensiTopbar .btn[data-tab]').forEach(bb => bb.classList.remove('active'));
      el(b.dataset.tab).classList.add('active');
      b.classList.add('active');
      if (b.dataset.tab === 'tab-jadwal') renderJadwalAbsensi(absensiMonthPick.value);
      if (b.dataset.tab === 'tab-absensi') renderAbsensi(absensiMonthPick.value);
      if (b.dataset.tab === 'tab-rekap') renderRekapAbsensi(absensiMonthPick.value);
      if (b.dataset.tab === 'tab-approval') renderApprovalAbsensi();
    };
  });

  // Absensi Data & Renderers
  function generateFairOffForMonth(ym) {
    const [y, m] = ym.split('-').map(Number), year = y, month = m - 1;
    const days = new Date(year, month + 1, 0).getDate();
    const pool = kurirListAbsensi.slice();
    if (pool.length === 0) { jadwalDataAbsensi[ym] = []; return; }
    const counts = Object.fromEntries(pool.map(k => [k, 0]));
    const arr = [];
    for (let d = 1; d <= days; d++) {
      const minV = Math.min(...Object.values(counts));
      const cands = pool.filter(k => counts[k] === minV);
      const pick = cands[Math.floor(Math.random() * cands.length)];
      counts[pick] += 1;
      const dt = new Date(year, month, d);
      arr.push({ tanggal: `${year}-${leftPad(month + 1, 2)}-${leftPad(d, 2)}`, off: pick, pengganti: '' });
    }
    jadwalDataAbsensi[ym] = arr;
  }

  function renderJadwalAbsensi(ym) {
    const tbody = document.querySelector('#tableJadwal tbody');
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;

    jadwalDataAbsensi[ym].forEach(it => {
      const d = new Date(it.tanggal);
      const hari = idDays[d.getDay()];
      const tr = document.createElement('tr');

      const tdTanggal = document.createElement('td'); tdTanggal.textContent = it.tanggal;
      const tdHari = document.createElement('td'); tdHari.textContent = hari;

      const tdOff = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = it.off ? 'badge off' : 'badge on';
      badge.textContent = it.off || 'Semua On';
      badge.style.cursor = 'pointer';
      badge.title = 'Klik kanan untuk set OFF';
      badge.oncontextmenu = async (e) => {
        e.preventDefault();
        const nama = await showPromptModal('Set Kurir OFF', 'Set OFF hari ini untuk kurir (kosongkan untuk Semua On):', it.off || '');
        if (nama !== null) {
          const newOff = nama.trim();
          it.off = newOff;
          it.pengganti = '';
          await saveFirestoreJadwalAbsensi(ym);
          showNotification(`OFF diperbarui: ${it.tanggal}: ${it.off || 'Semua On'}`, 'success');
        }
      };
      tdOff.appendChild(badge);

      const tdPeng = document.createElement('td');
      tdPeng.textContent = it.pengganti || '—';

      tr.append(tdTanggal, tdHari, tdOff, tdPeng);
      tbody.appendChild(tr);
    });
  }

  function renderAbsensi(ym) {
    const tbody = document.querySelector('#tableAbsensi tbody');
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;
    jadwalDataAbsensi[ym].forEach(it => {
      kurirListAbsensi.forEach(async k => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.tanggal}</td><td>${k}</td>`;
        let status = (k === it.off) ? 'Off' : 'On';
        const tdS = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn-mini ' + (status === 'On' ? 'btn-on' : 'btn-off');
        btn.textContent = status;
        btn.onclick = async () => {
          const ymLocal = it.tanggal.slice(0, 7);
          const row = jadwalDataAbsensi[ymLocal].find(r => r.tanggal === it.tanggal);
          row.off = (status === 'On') ? k : ''; // Toggle status
          row.pengganti = ''; // Clear pengganti if admin manually changes
          await saveFirestoreJadwalAbsensi(ymLocal);
          showNotification(`Status ${k} di ${it.tanggal} diubah menjadi ${row.off ? 'OFF' : 'ON'}`, 'info');
        };
        tdS.appendChild(btn);
        tr.appendChild(tdS);
        tbody.appendChild(tr);
      });
    });
  }

  function renderRekapAbsensi(ym) {
    const tbody = document.querySelector('#tableRekap tbody');
    tbody.innerHTML = '';
    if (!jadwalDataAbsensi[ym]) return;
    const arr = jadwalDataAbsensi[ym];
    const sum = Object.fromEntries(kurirListAbsensi.map(k => [k, { on: 0, off: 0 }]));
    arr.forEach(it => { kurirListAbsensi.forEach(k => { if (k === it.off) sum[k].off++; else sum[k].on++; }); });
    kurirListAbsensi.forEach(k => {
      const { on, off } = sum[k];
      const total = on + off || 1;
      const skor = Math.round((on / total) * 100);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td>${on}</td><td>${off}</td><td>${skor}%</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderApprovalAbsensi() {
    const tbody = document.querySelector('#tableApproval tbody');
    tbody.innerHTML = '';
    pengajuanCacheAbsensi.forEach(item => {
      const tr = document.createElement('tr');
      const createdAtDate = item.created ? new Date(item.created.toDate ? item.created.toDate() : item.created).toLocaleString('id-ID') : '-';
      tr.innerHTML = `<td>${createdAtDate}</td><td>${item.asal}</td><td>${item.pengganti}</td><td>${item.status}</td>`;
      if (item.status === 'Pending') {
        const tdA = document.createElement('td');

        const btnApprove = document.createElement('button');
        btnApprove.textContent = 'Approve';
        btnApprove.className = 'btn-mini btn-on';
        btnApprove.onclick = async () => {
          if (!await showConfirmModal('Setujui Pengajuan', 'Yakin ingin menyetujui pengajuan ini?')) return;
          const ym = item.tanggal.slice(0, 7);
          if (!jadwalDataAbsensi[ym]) { showNotification('Jadwal tidak ditemukan untuk bulan ini.', 'error'); return; }
          const row = jadwalDataAbsensi[ym].find(it => it.tanggal === item.tanggal);
          const swapRow = jadwalDataAbsensi[ym].find(it => it.tanggal === item.tukarTanggal);
          if (row && swapRow) {
            const tmp = row.off;
            row.off = swapRow.off;
            swapRow.off = tmp;
            row.pengganti = '';
            swapRow.pengganti = '';
            await updateDoc(doc(PENGAJUAN_COLLECTION, item.id), { status: 'Approved', approvedBy: auth.currentUser.uid });
            await saveFirestoreJadwalAbsensi(ym);
            showNotification('Approval berhasil: ' + item.tanggal + ' ↔ ' + item.tukarTanggal, 'success');
          } else {
            showNotification('Jadwal tidak valid untuk tukar off.', 'error');
          }
        };
        tdA.appendChild(btnApprove);

        const btnReject = document.createElement('button');
        btnReject.textContent = 'Tolak';
        btnReject.className = 'btn-mini btn-off';
        btnReject.style.marginLeft = '6px';
        btnReject.onclick = async () => {
          if (!await showConfirmModal('Tolak Pengajuan', 'Yakin ingin MENOLAK pengajuan ini?')) return;
          await updateDoc(doc(PENGAJUAN_COLLECTION, item.id), { status: 'Rejected', rejectedBy: auth.currentUser.uid });
          showNotification('Pengajuan ditolak: ' + item.tanggal, 'info');
        };
        tdA.appendChild(btnReject);

        tr.appendChild(tdA);
      } else {
        tr.appendChild(document.createElement('td'));
      }
      tbody.appendChild(tr);
    });
  }

  function absensiQuickSync() {
    const ym = absensiMonthPick.value;
    renderJadwalAbsensi(ym);
    renderAbsensi(ym);
    renderRekapAbsensi(ym);
    renderApprovalAbsensi();
  }

  // Absensi Firestore I/O
  async function saveFirestoreJadwalAbsensi(ym) {
    if (jadwalDataAbsensi[ym]) {
      await setDoc(doc(JADWAL_COLLECTION, ym), { data: jadwalDataAbsensi[ym] });
    }
  }

  // Absensi Realtime Listeners
  function listenMasterKurirAbsensi() {
    onSnapshot(doc(MASTER_DOC, 'master'), docSnap => {
      if (docSnap.exists()) {
        kurirListAbsensi = Array.isArray(docSnap.data().kurirList) ? docSnap.data().kurirList : [];
        absensiQuickSync();
      } else {
        absensiQuickSync();
      }
    });
  }

  function listenJadwalAbsensi(ym) {
    if (unsubJadwalAbsensi) { unsubJadwalAbsensi(); unsubJadwalAbsensi = null; }
    unsubJadwalAbsensi = onSnapshot(doc(JADWAL_COLLECTION, ym), async docSnap => {
      if (docSnap.exists()) {
        jadwalDataAbsensi[ym] = docSnap.data().data || [];
        absensiQuickSync();
      } else {
        generateFairOffForMonth(ym);
        await saveFirestoreJadwalAbsensi(ym);
        showNotification('Jadwal dibuat untuk ' + ym, 'success');
      }
    });
  }

  function listenPengajuanAbsensi() {
    onSnapshot(query(PENGAJUAN_COLLECTION, orderBy('created', 'desc')), snap => {
      pengajuanCacheAbsensi = [];
      snap.forEach(doc => {
        const d = doc.data();
        pengajuanCacheAbsensi.push({ id: doc.id, ...d });
      });
      renderApprovalAbsensi();
    });
  }

  // Absensi Admin Actions
  btnAddKurirAbsensi.addEventListener('click', async () => {
    const nama = await showPromptModal('Tambah Kurir Absensi', 'Nama Kurir baru:');
    if (nama) { 
      if (kurirListAbsensi.includes(nama.trim())) {
        showNotification('Kurir sudah ada!', 'warning');
        return;
      }
      // Add to Realtime DB for login
      await set(ref(db, 'kurir/' + nama.trim()), {
        username: nama.trim(),
        password: 'default_password', // Default password for new kurir
        enabled: true,
        createdAt: new Date().toISOString()
      });
      // Update Firestore absensi list (will trigger listenMasterKurirAbsensi)
      kurirListAbsensi.push(nama.trim());
      await setDoc(doc(MASTER_DOC, 'master'), { kurirList: kurirListAbsensi }, { merge: true });
      showNotification('Kurir ditambahkan: ' + nama, 'success'); 
    }
  });
  btnDelKurirAbsensi.addEventListener('click', async () => {
    const nama = await showPromptModal('Hapus Kurir Absensi', 'Hapus kurir (ketik persis):');
    if (!nama) return;
    const idx = kurirListAbsensi.indexOf(nama);
    if (idx > -1) { 
      if (!await showConfirmModal('Hapus Kurir Absensi', `Yakin ingin menghapus kurir "${nama}" dari absensi dan login?`)) return;
      // Remove from Realtime DB
      await remove(ref(db, 'kurir/' + nama));
      // Update Firestore absensi list (will trigger listenMasterKurirAbsensi)
      kurirListAbsensi.splice(idx, 1); 
      await setDoc(doc(MASTER_DOC, 'master'), { kurirList: kurirListAbsensi }, { merge: true });
      showNotification('Kurir dihapus: ' + nama, 'info'); 
    } else {
      showNotification('Kurir tidak ditemukan.', 'warning');
    }
  });
  btnBlockKurirAbsensi.addEventListener('click', async () => {
    const nama = await showPromptModal('Blokir Kurir Absensi', 'Blokir kurir (ketik persis):');
    if (nama) {
      if (!await showConfirmModal('Blokir Kurir Absensi', `Yakin ingin memblokir kurir "${nama}"? Ini akan mencegahnya login.`)) return;
      await update(ref(db, 'kurir/' + nama), { enabled: false });
      showNotification(`Kurir ${nama} diblokir.`, 'info');
    }
  });
  btnUnblockKurirAbsensi.addEventListener('click', async () => {
    const nama = await showPromptModal('Buka Blokir Kurir Absensi', 'Buka blokir kurir (ketik persis):');
    if (nama) {
      if (!await showConfirmModal('Buka Blokir Kurir Absensi', `Yakin ingin membuka blokir kurir "${nama}"?`)) return;
      await update(ref(db, 'kurir/' + nama), { enabled: true });
      showNotification(`Kurir ${nama} dibuka blokirnya.`, 'info');
    }
  });
  btnRegenAbsensi.addEventListener('click', async () => {
    const ym = absensiMonthPick.value;
    if (!ym) { showNotification('Pilih bulan.', 'warning'); return; }
    if (!await showConfirmModal('Regenerasi Jadwal OFF', `Yakin ingin meregenerasi jadwal OFF untuk bulan ${ym}? Ini akan menimpa jadwal yang ada.`)) return;
    generateFairOffForMonth(ym);
    await saveFirestoreJadwalAbsensi(ym);
    showNotification('Regenerasi selesai untuk ' + ym, 'success');
  });
  btnSaveAbsensi.addEventListener('click', async () => {
    try {
      // kurirListAbsensi is already updated via listenMasterKurirAbsensi
      const ym = absensiMonthPick.value;
      if (jadwalDataAbsensi[ym]) await saveFirestoreJadwalAbsensi(ym);
      showNotification('Data absensi disimpan di Firestore.', 'success');
    } catch (e) { showNotification('Gagal save absensi: ' + e.message, 'error'); }
  });

  // Absensi Init
  absensiMonthPick.addEventListener('change', () => listenJadwalAbsensi(absensiMonthPick.value));

  // ====================================================================
  // Utilities
  // ====================================================================
  function downloadCSV(rows, filename) {
    const csv = rows.map(r => r.map(c => {
      const v = (c === undefined || c === null) ? '' : String(c);
      if (/[",\n]/.test(v)) return '"' + v.replace(/"/g, '""') + '"';
      return v;
    }).join(',')).join('\n'); 
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ====================================================================
  // Initial Setup & Event Listeners
  // ====================================================================
  // Admin Nav Tabs
  qsa('#adminNavTabs button').forEach(b => b.addEventListener('click', () => setActiveTab('adminNavTabs', b.dataset.tab)));
</script>
</body>
</html>
